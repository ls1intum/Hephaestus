server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # Hide nginx version in error pages and Server header
    server_tokens off;

    # ==========================================================================
    # Compression (applied globally)
    # ==========================================================================
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        text/xml
        image/svg+xml
        application/manifest+json
        application/wasm;

    # ==========================================================================
    # env-config.{hash}.js - Immutable (content-hashed at container startup)
    # ==========================================================================
    location ~ "^/env-config\.[a-f0-9]{8}\.js$" {
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Permissions-Policy "geolocation=(), camera=(), microphone=(), payment=()" always;
        access_log off;
    }

    # ==========================================================================
    # Vite static assets - Immutable (content-hashed by Vite build)
    # ==========================================================================
    location /assets/ {
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Permissions-Policy "geolocation=(), camera=(), microphone=(), payment=()" always;
        access_log off;
        try_files $uri =404;
    }

    # ==========================================================================
    # Static files (favicon, images, fonts) - Cache with revalidation
    # These are not content-hashed, so use shorter cache with must-revalidate
    # ==========================================================================
    location ~* \.(ico|png|jpg|jpeg|gif|webp|svg|woff|woff2|ttf|otf|eot)$ {
        add_header Cache-Control "public, max-age=86400, must-revalidate" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Permissions-Policy "geolocation=(), camera=(), microphone=(), payment=()" always;
        access_log off;
        try_files $uri =404;
    }

    # ==========================================================================
    # Manifest and config files - No cache (may change between deployments)
    # ==========================================================================
    location ~* ^/(manifest(-dev)?\.json|robots\.txt|silent-check-sso\.html)$ {
        add_header Cache-Control "no-cache" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Permissions-Policy "geolocation=(), camera=(), microphone=(), payment=()" always;
    }

    # ==========================================================================
    # SPA routing - using error_page pattern to avoid duplicate headers
    # ==========================================================================
    
    # Direct requests to / and /index.html
    # no-cache: browser may cache but MUST revalidate with origin before use (allows 304 responses)
    location = / {
        add_header Cache-Control "no-cache" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Permissions-Policy "geolocation=(), camera=(), microphone=(), payment=()" always;
    }

    location = /index.html {
        add_header Cache-Control "no-cache" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Permissions-Policy "geolocation=(), camera=(), microphone=(), payment=()" always;
    }

    # Named location for SPA fallback - headers defined once
    # Uses rewrite with 'break' to serve file without triggering another location match
    location @spa {
        rewrite ^ /index.html break;
        add_header Cache-Control "no-cache" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Permissions-Policy "geolocation=(), camera=(), microphone=(), payment=()" always;
    }

    # Catch-all: try file, otherwise delegate to @spa via error_page
    # The '=' in 'error_page 404 =' uses response code from @spa
    location / {
        try_files $uri $uri/ =404;
        error_page 404 = @spa;
    }

    # ==========================================================================
    # Error pages
    # ==========================================================================
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }
}
