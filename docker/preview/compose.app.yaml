# =============================================================================
# PER-PR APPLICATION STACK FOR PREVIEW DEPLOYMENTS (Coolify)
# =============================================================================
#
# Coolify deploys this for each Pull Request automatically.
# Each PR gets its own isolated stack with its own Postgres database.
#
# Coolify Setup:
#   1. Create Application → Docker Compose (from Git repository)
#   2. Point to: docker/preview/compose.app.yaml
#   3. Enable "Connect to Predefined Network" to access shared infra
#   4. Enable Preview Deployments in the application settings
#   5. Configure environment variables (see .env.example)
#   6. Assign domain in Coolify UI for webapp service
#
# Coolify Magic Variables Used:
#   - SERVICE_FQDN_WEBAPP: Auto-generated domain for webapp
#   - COOLIFY_BRANCH: Branch name (used to identify PR)
#
# Connects to shared infrastructure services (from compose.shared-infra.yaml):
#   - nats-server: Message queue
#   - keycloak: Authentication  
#   - postfix: Email relay
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL - Per-PR database (isolated data per preview)
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: hephaestus
      POSTGRES_USER: hephaestus
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-hephaestus-preview}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hephaestus -d hephaestus"]
      interval: 5s
      timeout: 5s
      retries: 10
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Intelligence Service - AI analysis backend (internal only)
  # ---------------------------------------------------------------------------
  intelligence-service:
    build:
      context: ./server/intelligence-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      # Database - use Coolify's service naming
      DATABASE_URL: postgresql://postgres:5432/hephaestus
      DATABASE_USERNAME: hephaestus
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-hephaestus-preview}
      # AI Models
      MODEL_NAME: ${MODEL_NAME:?Required}
      DETECTION_MODEL_NAME: ${DETECTION_MODEL_NAME:?Required}
      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_API_VERSION: ${OPENAI_API_VERSION:-}
      # Azure OpenAI
      AZURE_OPENAI_ENDPOINT: ${AZURE_OPENAI_ENDPOINT:-}
      AZURE_OPENAI_API_KEY: ${AZURE_OPENAI_API_KEY:-}
      # Ollama
      OLLAMA_HOST: ${OLLAMA_HOST:-}
      OLLAMA_BASIC_AUTH_USERNAME: ${OLLAMA_BASIC_AUTH_USERNAME:-}
      OLLAMA_BASIC_AUTH_PASSWORD: ${OLLAMA_BASIC_AUTH_PASSWORD:-}
      # Observability (optional)
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
      LANGFUSE_HOST: ${LANGFUSE_HOST:-}
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Application Server - Spring Boot backend
  # Assign domain in Coolify: pr-{id}.preview.example.com/api → port 8080
  # ---------------------------------------------------------------------------
  application-server:
    build:
      context: ./server/application-server
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: prod
      # URL - Coolify provides SERVICE_FQDN_WEBAPP
      APPLICATION_HOST_URL: https://${SERVICE_FQDN_WEBAPP}
      # Database - internal service reference
      DATABASE_URL: postgresql://postgres:5432/hephaestus
      DATABASE_USERNAME: hephaestus
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-hephaestus-preview}
      # Internal service reference
      INTELLIGENCE_SERVICE_URL: http://intelligence-service:5000
      # Shared infrastructure (must match shared-infra service names with UUID suffix)
      # When "Connect to Predefined Network" is enabled, use the full container names
      NATS_SERVER: nats://nats-server:4222
      NATS_ENABLED: ${NATS_ENABLED:-true}
      NATS_DURABLE_CONSUMER_NAME: ${COOLIFY_CONTAINER_NAME:-preview}-consumer
      # Shared Keycloak - use base preview domain
      KEYCLOAK_URL: https://${PREVIEW_DOMAIN:?Required}/keycloak
      KEYCLOAK_REALM: hephaestus
      KEYCLOAK_CLIENT_ID: hephaestus-confidential
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_HEPHAESTUS_CONFIDENTIAL_CLIENT_SECRET:?Required}
      # Shared Postfix
      POSTFIX_HOST: postfix
      POSTFIX_PORT: 25
      # GitHub integration
      GH_APP_ID: ${GH_APP_ID:?Required}
      GH_APP_PRIVATE_KEY: ${GH_APP_PRIVATE_KEY:?Required}
      GH_AUTH_TOKEN: ${GH_AUTH_TOKEN:?Required}
      # Monitoring (relaxed for previews)
      MONITORING_TIMEFRAME: ${MONITORING_TIMEFRAME:-14}
      MONITORING_RUN_ON_STARTUP: ${MONITORING_RUN_ON_STARTUP:-false}
      MONITORING_SYNC_CRON: ${MONITORING_SYNC_CRON:-0 0 2 * * *}
      MONITORING_BACKFILL_ENABLED: "false"
      # Notifications disabled for previews
      LEADERBOARD_NOTIFICATION_ENABLED: "false"
      # Observability (optional)
      SENTRY_DSN: ${SENTRY_DSN:-}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
      LANGFUSE_HOST: ${LANGFUSE_HOST:-}
    depends_on:
      postgres:
        condition: service_healthy
      intelligence-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://127.0.0.1:8080/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 90s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # Webapp - React frontend served by nginx
  # Assign domain in Coolify: pr-{id}.preview.example.com → port 80
  # ---------------------------------------------------------------------------
  webapp:
    build:
      context: ./webapp
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      # Coolify provides SERVICE_FQDN_WEBAPP automatically
      APPLICATION_CLIENT_URL: https://${SERVICE_FQDN_WEBAPP}
      APPLICATION_SERVER_URL: https://${SERVICE_FQDN_WEBAPP}/api
      # Shared Keycloak
      KEYCLOAK_URL: https://${PREVIEW_DOMAIN:?Required}/keycloak
      KEYCLOAK_REALM: hephaestus
      KEYCLOAK_CLIENT_ID: hephaestus
      KEYCLOAK_SKIP_LOGIN: ${KEYCLOAK_SKIP_LOGIN:-false}
      # Optional
      SENTRY_ENVIRONMENT: preview
      SENTRY_DSN: ${SENTRY_DSN:-}
      POSTHOG_ENABLED: "false"
    depends_on:
      application-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:80/"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

# =============================================================================
# VOLUMES (per-deployment, isolated)
# =============================================================================
volumes:
  postgres-data:
