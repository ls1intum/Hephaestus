# PR Audit - GitHub Projects V2 Sync

Date: 2026-02-03
Scope: Application server project sync, activity events, and logs review

## Intent (What This PR Tries To Do)
- Add full GitHub Projects V2 support: project metadata, fields, status updates, and draft-issue items.
- Sync project items from the issue/PR side (embedded GraphQL) while keeping Draft Issues on the project side.
- Add actor-aware project events and activity events for projects/items/status updates.
- Add resumable pagination cursors and cost-optimized GraphQL queries.
- Add integrity cleanup for polymorphic project ownership.

## Key Log Observations (2026-02-02)
- GitHub GraphQL 504 retry logged at 20:35:39.807 (application-local-2026-02-02.0.log).
- App restart failed because port 8080 already in use at 20:45:48.755 (application-local.log). This is a plausible source of 502/504 from upstream.
- Repeated warnings: "Skipped stale Draft Issue removal: reason=incompleteSync" during project item sync. This is data-preserving but indicates incomplete pagination.
- Multiple "commentNotFound" skips on review comment edit events, suggesting out-of-order events or missing initial sync data.

## Findings (Ruthlessly Critical)
Critical
- Project item completeness risk: projects are synced after issues/PRs, so embedded project items are skipped when projects do not yet exist. There is no guaranteed replay for older issues. This can permanently drop project items.
- Sync result semantics: Draft Issue sync can log status=COMPLETED even when itemsSynced=false. This masks partial data and blocks alerting.

High
- XP calculation can award points when actorId exists but user does not exist locally. ActivityEventListener uses getActorOrNull() but xpForActor() only checks authorId != null.
- Activity events for project items/status updates do not link repository_id even for repository-owned projects, weakening relationships and analytics joins.

Medium
- Project activity timestamps use Instant.now() instead of event timestamps. This breaks chronological correctness for the activity timeline.
- Project item delete events lose actor attribution (sender is available on webhooks but not stored in DomainEvent).

## Activity Event Coverage (Target: activity_event)
- Present: project created/updated/closed/reopened; project item created/updated/archived/restored/deleted; status update created/updated/deleted.
- Gaps: repository linkage for repo-owned projects; actor attribution for deletes and missing local users; event_time vs processing time.

## Plan (No Backward Compatibility Required)
1. Reorder sync so project list runs before issue/PR sync, or add a replay pass to attach items after projects exist.
2. Make SyncResult reflect partials: if itemsSynced=false, final status must be COMPLETED_WITH_WARNINGS or ABORTED_*.
3. Add event_time and actor_id provenance to ProjectData and ProjectItemData; use source timestamps instead of Instant.now().
4. Resolve repository for repo-owned projects when recording project_item.* and project_status_update.* activity events.

## Notes
- Any fix must follow repo conventions: Conventional Commits, structured logging, and existing sync patterns.
- Dropping orphan tables (project_view, project_workflow) is valid to clear FK errors; keep Liquibase changes guarded by preconditions.
