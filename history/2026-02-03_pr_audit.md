# PR Audit - GitHub Projects V2 Sync

Date: 2026-02-03
Scope: Application server project sync, activity events, and logs review

## Intent (What This PR Tries To Do)
- Add full GitHub Projects V2 support: project metadata, fields, status updates, and draft-issue items.
- Sync project items from the issue/PR side (embedded GraphQL) while keeping Draft Issues on the project side.
- Add actor-aware project events and activity events for projects/items/status updates.
- Add resumable pagination cursors and cost-optimized GraphQL queries.
- Add integrity cleanup for polymorphic project ownership.

## Key Log Observations (2026-02-02)
- GitHub GraphQL 504 retry logged at 20:35:39.807 (application-local-2026-02-02.0.log).
- App restart failed because port 8080 already in use at 20:45:48.755 (application-local.log). This is a plausible source of 502/504 from upstream.
- Repeated warnings: "Skipped stale Draft Issue removal: reason=incompleteSync" during project item sync. This is data-preserving but indicates incomplete pagination.
- Multiple "commentNotFound" skips on review comment edit events, suggesting out-of-order events or missing initial sync data.

## Findings (Ruthlessly Critical)
Critical
- Project item completeness risk: projects are synced after issues/PRs, so embedded project items are skipped when projects do not yet exist. There is no guaranteed replay for older issues. This can permanently drop project items.
- Sync result semantics: Draft Issue sync can log status=COMPLETED even when itemsSynced=false. This masks partial data and blocks alerting.

High
- XP calculation can award points when actorId exists but user does not exist locally. ActivityEventListener uses getActorOrNull() but xpForActor() only checks authorId != null.
- Activity events for project items/status updates do not link repository_id even for repository-owned projects, weakening relationships and analytics joins.

Medium
- Project activity timestamps use Instant.now() instead of event timestamps. This breaks chronological correctness for the activity timeline.
- Project item delete events lose actor attribution (sender is available on webhooks but not stored in DomainEvent).

## Activity Event Coverage (Target: activity_event)
- Present: project created/updated/closed/reopened; project item created/updated/archived/restored/deleted; status update created/updated/deleted.
- Gaps: repository linkage for repo-owned projects; actor attribution for deletes and missing local users; event_time vs processing time.

## Plan (No Backward Compatibility Required)
1. Reorder sync so project list runs before issue/PR sync (no replay pass; rely on backfill + incremental sync + webhooks).
2. Make SyncResult reflect partials: if itemsSynced=false, final status must be COMPLETED_WITH_WARNINGS or ABORTED_*.
3. Add event_time and actor_id provenance to ProjectData and ProjectItemData; use source timestamps instead of Instant.now().
4. Resolve repository for repo-owned projects when recording project_item.* and project_status_update.* activity events.

## Progress (2026-02-03)
- Reordered scheduled and scoped sync to run project list before repository sync; added org presence check before project sync.
- Fixed Draft Issue sync status to flag incomplete item sync and abort on pagination cap.
- Added createdAt/updatedAt/closedAt to project, project item, and status update event payloads; activity events now use source timestamps.
- Resolved repository linkage for project items and status updates via issue/project lookup; project deletion remains repo-null if entity is gone.
- Set project-related activity events to 0 XP to keep audit trail without scoring.
- XP now requires a resolved actor (user exists) rather than just a non-null authorId.

## Rubric (Ruthless, Data-Quality-First)
Scoring uses 0–100 total. A+ requires ≥ 95 with zero gating failures.

Gating failures (cap grade at C regardless of score):
- Any project_item linked to a non-existent project (referential break).
- Event timestamps for projects/items/status updates use processing time instead of source time.
- Repository-owned projects lack repository_id on project_item/status_update events when the repo is resolvable.
- Sync status marks “COMPLETED” while item pagination is incomplete.

Dimensions (weight → A+ bar → failure bar):
- Accuracy (20%): ≥ 99.9% field values match GitHub truth. Fail if any systemic mismatch across core fields.
- Completeness (20%): ≥ 99.5% of required fields present; project items coverage ≥ 99%. Fail if any required field nulls or skipped items are un-replayed.
- Consistency (10%): Zero contradictions across tables (e.g., owner_type/owner_id mismatch). Fail if any contradictions exist.
- Timeliness/Currentness (15%): Median event timestamp drift < 1 minute; 99% < 10 minutes. Fail if event time is system clock for historical events.
- Validity (10%): 0 invalid enums, formats, or out-of-range values. Fail if any invalids are present.
- Uniqueness (5%): 0 duplicate events and 0 duplicate unique keys. Fail if duplicates > 0.1%.
- Integrity/Referential (15%): 0 orphaned relationships; all resolvable foreign links present. Fail if any orphan exists.
- Traceability/Auditability (5%): 100% events have scope, target, and correlation context; null actor only when unknown. Fail if context missing.

Current grade (post-fixes): B-
- Strengths: timestamps now source-aligned; repository linkage for project items/status updates; sync ordering fixed.
- Known accepted gap: no additional replay for previously skipped embedded project items (backfill + incremental sync + webhooks only).
- Remaining blockers to A+: deletion events still lose repository when entity already purged; org-level project item repo attribution is partial when issue missing.

## A+ Verification Audit (2026-02-03)
Verdict: Not verified as A+. Evidence-based gaps remain.

What I could verify:
- Logs show historical project item skips due to missing projects (`projectNotSynced`) and incomplete Draft Issue syncs (pagesProcessed=1 with `draftIssues=false`). This was before the sync-order fix but is still evidence of prior data gaps that require the standard backfill/incremental/webhook flow to heal. (application-local-2026-02-02.0.log)
- GitHub GraphQL 504 retry occurred during sync (20:35:39), consistent with reported 502/504 instability. Retried and continued. (application-local-2026-02-02.0.log)
- Liquibase warnings about missing constraints on `project_view` / `project_workflow` appeared at startup, suggesting legacy schema drift (non-fatal, but still noise). (application-local.log, application-local-2026-02-02.0.log)

What I could NOT verify (DB unavailable):
- Referential integrity (project_item → project, project_status_update → project, activity_event → repository_id linkage).
- Completeness metrics (percent of project items represented; null-field rates).
- Event timestamp drift (event_time vs entity createdAt/updatedAt).

Blocking reason: The configured DB at `localhost:5432/hephaestus` refused connections. No hephaestus Postgres container is running (`docker ps` shows none). Without DB access, A+ cannot be proven.

Required to certify A+:
- Bring up the Hephaestus Postgres (`localhost:5432`) and rerun the sync with the new code, then run the integrity queries.
- Confirm no `projectNotSynced` skips occur in new logs after the reorder.

## DB Audit (2026-02-03  — Postgres Online)
Status: Still not A+.

Integrity & linkage checks (counts):
- Project orphans (by owner type): 0
- Project item orphans: 0
- Project status update orphans: 0
- Project field orphans: 0
- Project field value orphans (item/field): 0 / 0
- Missing node_id (project / item / status update): 0 / 0 / 0

Activity events:
- Project-related XP non-zero: 0
- Project item events missing repo where issue is linked: 0
- Project item events missing repo for repo-owned projects: 0
- Project status update events missing repo for repo-owned projects: 0
- Activity events missing for project / item / status update: 0 / 0 / 0
- Event time mismatches (created/updated vs entity timestamps): 0

Blocking gap:
- All ISSUE/PULL_REQUEST project items lack `issue_id` (167/167). This means project items are not linked to issues/PRs in the database, which breaks cross-entity analytics and violates “A+ completeness” for project relationships.

Interpretation:
- This likely means every project item referencing an issue/PR points to issues not present locally (unmonitored repos) or the link resolution never succeeds. Either way, the relationship is absent.



## Notes
- Any fix must follow repo conventions: Conventional Commits, structured logging, and existing sync patterns.
- Dropping orphan tables (project_view, project_workflow) is valid to clear FK errors; keep Liquibase changes guarded by preconditions.
