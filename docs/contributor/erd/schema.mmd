---
config:
    layout: elk
---
erDiagram
    %% Generated automatically from PostgreSQL database schema
    %% using scripts/generate_mermaid_erd.py
    %% To regenerate: npm run db:erd:generate

    direction LR

    BadPracticeDetection {
        BIGINT id PK
        TIMESTAMPTZ detection_time
        VARCHAR(255) trace_id
        BIGINT pullrequest_id FK
        TEXT summary
    }

    BadPracticeFeedback {
        BIGINT id PK
        VARCHAR(255) type
        BIGINT pull_request_bad_practice_id FK
        TIMESTAMPTZ creation_time
        TEXT explanation
    }

    ChatMessage {
        UUID id PK
        TIMESTAMPTZ created_at "NOT NULL"
        JSONB metadata
        VARCHAR(16) role "NOT NULL"
        UUID parent_message_id FK
        UUID thread_id FK "NOT NULL"
    }

    ChatMessagePart {
        UUID message_id PK,FK
        INTEGER order_index PK
        JSONB content
        VARCHAR(128) original_type
        VARCHAR(32) type "NOT NULL"
    }

    ChatMessageVote {
        UUID message_id PK
        TIMESTAMPTZ created_at "NOT NULL"
        BOOLEAN is_upvoted "NOT NULL"
        TIMESTAMPTZ updated_at "NOT NULL"
    }

    ChatThread {
        UUID id PK
        TIMESTAMPTZ created_at "NOT NULL"
        TEXT title
        UUID selected_leaf_message_id FK,UK
        BIGINT user_id FK
        BIGINT workspace_id FK "NOT NULL"
    }

    ContributionEvent {
        BIGINT id PK
        TIMESTAMPTZ occurred_at "NOT NULL"
        BIGINT source_id UK "NOT NULL"
        VARCHAR(32) source_type UK "NOT NULL"
        INTEGER xp_awarded "NOT NULL"
        BIGINT actor_id FK "NOT NULL"
    }

    Document {
        UUID id PK
        INTEGER version_number PK
        TEXT content
        TIMESTAMPTZ created_at "NOT NULL"
        VARCHAR(255) kind "NOT NULL"
        VARCHAR(255) title "NOT NULL"
        BIGINT user_id FK "NOT NULL"
        BIGINT workspace_id FK "NOT NULL"
    }

    Issue {
        VARCHAR(31) issue_type "NOT NULL"
        BIGINT id PK
        TIMESTAMPTZ created_at
        TIMESTAMPTZ updated_at
        TIMESTAMPTZ closed_at
        INTEGER comments_count "NOT NULL"
        VARCHAR(255) html_url
        BOOLEAN is_locked "NOT NULL"
        INTEGER number "NOT NULL"
        VARCHAR(255) state
        VARCHAR(255) title
        INTEGER additions
        INTEGER changed_files
        INTEGER commits
        INTEGER deletions
        BOOLEAN is_draft
        BOOLEAN is_mergeable
        BOOLEAN is_merged
        BOOLEAN maintainer_can_modify
        VARCHAR(255) merge_commit_sha
        VARCHAR(255) mergeable_state
        TIMESTAMPTZ merged_at
        BIGINT author_id FK
        BIGINT milestone_id FK
        BIGINT repository_id FK
        BIGINT merged_by_id FK
        BOOLEAN has_pull_request "NOT NULL"
        TIMESTAMP last_sync_at
        TIMESTAMPTZ last_detection_time
        VARCHAR(32) state_reason
        TEXT body
        TEXT bad_practice_summary
    }

    IssueAssignee {
        BIGINT issue_id PK,FK
        BIGINT user_id PK,FK
    }

    IssueComment {
        BIGINT id PK
        TIMESTAMPTZ created_at
        TIMESTAMPTZ updated_at
        VARCHAR(255) author_association
        VARCHAR(255) html_url
        BIGINT author_id FK
        BIGINT issue_id FK
        TEXT body
    }

    IssueLabel {
        BIGINT issue_id PK,FK
        BIGINT label_id PK,FK
    }

    Label {
        BIGINT id PK
        VARCHAR(255) color
        VARCHAR(255) description
        VARCHAR(255) name
        BIGINT repository_id FK
    }

    Milestone {
        BIGINT id PK
        TIMESTAMPTZ created_at
        TIMESTAMPTZ updated_at
        TIMESTAMPTZ closed_at
        TIMESTAMPTZ due_on
        VARCHAR(255) html_url
        INTEGER number "NOT NULL"
        VARCHAR(255) state
        VARCHAR(255) title
        BIGINT creator_id FK
        BIGINT repository_id FK
        TEXT description
        INTEGER closed_issues_count "NOT NULL"
        INTEGER open_issues_count "NOT NULL"
    }

    Organization {
        BIGINT id PK
        TIMESTAMPTZ created_at
        TIMESTAMPTZ updated_at
        VARCHAR(255) avatar_url
        BIGINT github_id UK "NOT NULL"
        VARCHAR(255) html_url
        BIGINT installation_id
        VARCHAR(255) login UK "NOT NULL"
        VARCHAR(255) name
    }

    OrganizationMembership {
        BIGINT organization_id PK
        BIGINT user_id PK
        TIMESTAMPTZ joined_at
        VARCHAR(32) role
    }

    PullRequestRequestedReviewer {
        BIGINT pull_request_id PK,FK
        BIGINT user_id PK,FK
    }

    PullRequestReview {
        BIGINT id PK
        VARCHAR(255) commit_id
        VARCHAR(255) html_url
        BOOLEAN is_dismissed "NOT NULL"
        VARCHAR(255) state
        TIMESTAMPTZ submitted_at
        BIGINT author_id FK
        BIGINT pull_request_id FK
        TEXT body
    }

    PullRequestReviewComment {
        BIGINT id PK
        TIMESTAMPTZ created_at
        TIMESTAMPTZ updated_at
        VARCHAR(255) author_association
        VARCHAR(255) commit_id
        VARCHAR(255) html_url
        INTEGER line "NOT NULL"
        VARCHAR(255) original_commit_id
        INTEGER original_line "NOT NULL"
        INTEGER original_position "NOT NULL"
        INTEGER original_start_line
        VARCHAR(255) path
        INTEGER position "NOT NULL"
        VARCHAR(255) side
        INTEGER start_line
        VARCHAR(255) start_side
        BIGINT author_id FK
        BIGINT pull_request_id FK
        BIGINT review_id FK
        BIGINT thread_id FK "NOT NULL"
        BIGINT in_reply_to_id FK
        TEXT body
        TEXT diff_hunk
    }

    PullRequestReviewThread {
        BIGINT id PK
        TIMESTAMPTZ created_at
        TIMESTAMPTZ updated_at
        VARCHAR(20) state "NOT NULL"
        TIMESTAMPTZ resolved_at
        BIGINT pull_request_id FK "NOT NULL"
        BIGINT root_comment_id FK,UK
        BIGINT provider_thread_id
        VARCHAR(64) node_id
        TEXT path
        INTEGER line
        INTEGER start_line
        VARCHAR(16) side
        VARCHAR(16) start_side
        BOOLEAN outdated
        BOOLEAN collapsed
        BIGINT resolved_by_id FK
    }

    PullRequestBadPractice {
        BIGINT id PK
        VARCHAR(255) title
        BIGINT pullrequest_id FK
        SMALLINT state
        TIMESTAMPTZ detection_time
        TIMESTAMPTZ last_update_time
        SMALLINT user_state
        SMALLINT detection_pullrequest_lifecycle_state
        VARCHAR(255) detection_trace_id
        BIGINT bad_practice_detection_id FK
        TEXT description
    }

    Repository {
        BIGINT id PK
        TIMESTAMPTZ created_at
        TIMESTAMPTZ updated_at
        VARCHAR(255) default_branch
        VARCHAR(255) description
        BOOLEAN has_issues "NOT NULL"
        BOOLEAN has_projects "NOT NULL"
        BOOLEAN has_wiki "NOT NULL"
        VARCHAR(1024) homepage
        VARCHAR(512) html_url
        BOOLEAN is_archived "NOT NULL"
        BOOLEAN is_disabled "NOT NULL"
        BOOLEAN is_private "NOT NULL"
        VARCHAR(255) name
        VARCHAR(150) name_with_owner
        TIMESTAMPTZ pushed_at
        INTEGER stargazers_count "NOT NULL"
        VARCHAR(255) visibility
        INTEGER watchers_count "NOT NULL"
        BIGINT organization_id FK
    }

    RepositoryCollaborator {
        BIGINT repository_id PK,FK
        BIGINT user_id PK,FK
        VARCHAR(32) permission "NOT NULL"
    }

    RepositoryToMonitor {
        BIGINT id PK
        TIMESTAMP issues_and_pull_requests_synced_at
        TIMESTAMP labels_synced_at
        TIMESTAMP milestones_synced_at
        VARCHAR(255) name_with_owner
        TIMESTAMP repository_synced_at
        BIGINT workspace_id FK
        INTEGER backfill_checkpoint
        INTEGER backfill_high_water_mark
        TIMESTAMPTZ backfill_last_run_at
        TIMESTAMPTZ collaborators_synced_at
    }

    Team {
        BIGINT id PK
        VARCHAR(255) name
        BOOLEAN hidden "NOT NULL"
        TIMESTAMPTZ created_at
        TEXT description
        TEXT html_url
        TIMESTAMPTZ last_synced_at
        VARCHAR(255) organization
        BIGINT parent_id
        VARCHAR(32) privacy
        TIMESTAMPTZ updated_at
    }

    TeamLabel {
        BIGINT team_id PK,FK
        BIGINT label_id PK,FK
    }

    TeamMembership {
        VARCHAR(32) role
        BIGINT user_id PK,FK
        BIGINT team_id PK,FK
    }

    TeamRepositoryPermission {
        VARCHAR(32) permission "NOT NULL"
        BIGINT repository_id PK,FK
        BIGINT team_id PK,FK
        BOOLEAN hidden_from_contributions "NOT NULL"
    }

    User {
        BIGINT id PK
        TIMESTAMPTZ created_at
        TIMESTAMPTZ updated_at
        VARCHAR(255) avatar_url
        VARCHAR(255) blog
        VARCHAR(255) company
        VARCHAR(255) description
        VARCHAR(255) email
        INTEGER followers "NOT NULL"
        INTEGER following "NOT NULL"
        VARCHAR(255) html_url
        VARCHAR(255) location
        VARCHAR(255) login
        VARCHAR(255) name
        VARCHAR(255) type
        INTEGER league_points "NOT NULL"
        BOOLEAN notifications_enabled "NOT NULL"
        BOOLEAN participate_in_research "NOT NULL"
    }

    Workspace {
        BIGINT id PK
        TIMESTAMP users_synced_at
        VARCHAR(120) account_login
        VARCHAR(255) git_provider_mode
        VARCHAR(255) github_repository_selection
        BIGINT installation_id
        TIMESTAMPTZ installation_linked_at
        BIGINT organization_id FK,UK
        TEXT personal_access_token
        VARCHAR(10) account_type "NOT NULL"
        TIMESTAMPTZ created_at "NOT NULL"
        VARCHAR(120) display_name "NOT NULL"
        BOOLEAN is_publicly_viewable "NOT NULL"
        VARCHAR(100) leaderboard_notification_channel_id
        BOOLEAN leaderboard_notification_enabled
        VARCHAR(100) leaderboard_notification_team
        INTEGER leaderboard_schedule_day
        VARCHAR(10) leaderboard_schedule_time
        TEXT slack_signing_secret
        TEXT slack_token
        VARCHAR(64) slug UK "NOT NULL"
        VARCHAR(20) status "NOT NULL"
        TIMESTAMPTZ updated_at
        TIMESTAMPTZ members_synced_at
        TIMESTAMPTZ teams_synced_at
    }

    WorkspaceMembership {
        TIMESTAMPTZ created_at "NOT NULL"
        INTEGER league_points "NOT NULL"
        VARCHAR(16) role "NOT NULL"
        BIGINT user_id PK,FK
        BIGINT workspace_id PK,FK
    }

    WorkspaceSlugHistory {
        BIGINT id PK
        TIMESTAMPTZ changed_at "NOT NULL"
        VARCHAR(64) new_slug "NOT NULL"
        VARCHAR(64) old_slug "NOT NULL"
        TIMESTAMPTZ redirect_expires_at
        BIGINT workspace_id FK "NOT NULL"
    }

    %% Relationships
    %% One-to-One relationships
    ChatMessage ||--|| ChatMessagePart : has
    ChatMessage ||--|| ChatThread : references
    PullRequestReviewComment ||--|| PullRequestReviewThread : reviewed
    Organization ||--|| Workspace : has
    User ||--|| WorkspaceMembership : belongs_to
    Workspace ||--|| WorkspaceMembership : belongs_to

    %% One-to-Many relationships
    Issue ||--o{ BadPracticeDetection : references
    PullRequestBadPractice ||--o{ BadPracticeFeedback : references
    ChatMessage ||--o{ ChatMessage : references
    ChatThread ||--o{ ChatMessage : has
    User ||--o{ ChatThread : has
    Workspace ||--o{ ChatThread : has
    User ||--o{ ContributionEvent : references
    User ||--o{ Document : has
    Workspace ||--o{ Document : has
    User ||--o{ Issue : authored_by
    User ||--o{ Issue : merged_by
    Milestone ||--o{ Issue : has
    Repository ||--o{ Issue : has
    User ||--o{ IssueComment : commented_on
    Issue ||--o{ IssueComment : commented_on
    Repository ||--o{ Label : labeled
    User ||--o{ Milestone : created_by
    Repository ||--o{ Milestone : has
    User ||--o{ PullRequestReview : reviewed
    Issue ||--o{ PullRequestReview : reviewed
    User ||--o{ PullRequestReviewComment : commented_on
    PullRequestReviewComment ||--o{ PullRequestReviewComment : commented_on
    Issue ||--o{ PullRequestReviewComment : commented_on
    PullRequestReview ||--o{ PullRequestReviewComment : commented_on
    PullRequestReviewThread ||--o{ PullRequestReviewComment : commented_on
    Issue ||--o{ PullRequestReviewThread : reviewed
    User ||--o{ PullRequestReviewThread : reviewed
    BadPracticeDetection ||--o{ PullRequestBadPractice : has
    Issue ||--o{ PullRequestBadPractice : references
    Organization ||--o{ Repository : has
    Workspace ||--o{ RepositoryToMonitor : monitors
    Workspace ||--o{ WorkspaceSlugHistory : has

    %% Many-to-Many relationships
    Issue }o--o{ IssueAssignee : assigned_to
    User }o--o{ IssueAssignee : assigned_to
    Issue }o--o{ IssueLabel : labeled
    Label }o--o{ IssueLabel : labeled
    Issue }o--o{ PullRequestRequestedReviewer : reviewed
    User }o--o{ PullRequestRequestedReviewer : reviewed
    Repository }o--o{ RepositoryCollaborator : has
    User }o--o{ RepositoryCollaborator : has
    Label }o--o{ TeamLabel : labeled
    Team }o--o{ TeamLabel : labeled
    Team }o--o{ TeamMembership : belongs_to
    User }o--o{ TeamMembership : belongs_to
    Repository }o--o{ TeamRepositoryPermission : has
    Team }o--o{ TeamRepositoryPermission : has

    %% Styling
    classDef primaryEntity fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef associationEntity fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef metadataEntity fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px

    class Issue primaryEntity
    class IssueAssignee associationEntity
    class IssueLabel associationEntity
    class Label primaryEntity
    class Milestone primaryEntity
    class PullRequestRequestedReviewer associationEntity
    class Repository primaryEntity
    class RepositoryToMonitor metadataEntity
    class Team primaryEntity
    class TeamLabel associationEntity
    class User primaryEntity
    class Workspace primaryEntity