openapi: 3.1.0
info:
  version: 0.13.0
  title: Hephaestus Intelligence Service API
components:
  schemas:
    BadPractice:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        status:
          type: string
          enum:
            - Good Practice
            - Fixed
            - Critical Issue
            - Normal Issue
            - Minor Issue
            - Won't Fix
            - Wrong
      required:
        - title
        - description
        - status
    BadPracticeResult:
      type: object
      properties:
        badPracticeSummary:
          type: string
        badPractices:
          type: array
          items:
            $ref: "#/components/schemas/BadPractice"
      required:
        - badPracticeSummary
        - badPractices
    DetectorResponse:
      allOf:
        - $ref: "#/components/schemas/BadPracticeResult"
        - type: object
          properties:
            traceId:
              type: string
          required:
            - traceId
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Human-readable error message
      required:
        - error
      x-hephaestus: &a1
        export: true
    DetectorRequest:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        lifecycleState:
          type: string
        repositoryName:
          type: string
        pullRequestNumber:
          type: number
        badPracticeSummary:
          type: string
        badPractices:
          type: array
          items:
            $ref: "#/components/schemas/BadPractice"
        pullRequestTemplate:
          type: string
      required:
        - title
        - description
        - lifecycleState
        - repositoryName
        - pullRequestNumber
        - badPracticeSummary
        - badPractices
        - pullRequestTemplate
    ChatThreadSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        createdAt:
          type: string
          format: date-time
      required:
        - id
        - title
      x-hephaestus: *a1
    ChatThreadGroup:
      type: object
      properties:
        groupName:
          type: string
        threads:
          type: array
          items:
            $ref: "#/components/schemas/ChatThreadSummary"
      required:
        - groupName
        - threads
      x-hephaestus: *a1
    ThreadDetail:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type:
            - string
            - "null"
        selectedLeafMessageId:
          type:
            - string
            - "null"
          format: uuid
        messages:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              role:
                type: string
                enum:
                  - system
                  - user
                  - assistant
              parts:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                  required:
                    - type
                  additionalProperties: {}
              createdAt:
                type: string
                format: date-time
              parentMessageId:
                type:
                  - string
                  - "null"
                format: uuid
            required:
              - id
              - role
              - parts
      required:
        - id
        - messages
      x-hephaestus: *a1
    DocumentKind:
      type: string
      enum:
        - text
      x-hephaestus: *a1
    Document:
      type: object
      properties:
        id:
          type: string
          format: uuid
        versionNumber:
          type: integer
        createdAt:
          type: string
          format: date-time
        title:
          type: string
        content:
          type: string
        kind:
          $ref: "#/components/schemas/DocumentKind"
        userId:
          type: integer
      required:
        - id
        - versionNumber
        - createdAt
        - title
        - content
        - kind
        - userId
      x-hephaestus: *a1
    CreateDocumentRequest:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 255
        content:
          type: string
          minLength: 1
        kind:
          $ref: "#/components/schemas/DocumentKind"
      required:
        - title
        - content
        - kind
      x-hephaestus: *a1
    DocumentSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        kind:
          $ref: "#/components/schemas/DocumentKind"
        createdAt:
          type: string
          format: date-time
        userId:
          type: integer
      required:
        - id
        - title
        - kind
        - createdAt
        - userId
      x-hephaestus: *a1
    ChatMessageVote:
      type: object
      properties:
        messageId:
          type: string
          format: uuid
        isUpvoted:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - messageId
        - isUpvoted
        - createdAt
        - updatedAt
      x-hephaestus: *a1
    VoteMessageRequest:
      type: object
      properties:
        isUpvoted:
          type: boolean
      required:
        - isUpvoted
      x-hephaestus: *a1
    StreamPart:
      type: object
      properties:
        type:
          type: string
      required:
        - type
      additionalProperties: {}
      x-hephaestus: *a1
  parameters: {}
paths:
  /detector:
    post:
      operationId: detectBadPractices
      tags:
        - Detector
      summary: Detect bad practices for a pull request
      requestBody:
        description: Detector request
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DetectorRequest"
      responses:
        "200":
          description: Detection response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DetectorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /mentor/threads/grouped:
    get:
      tags:
        - mentor
        - exported
      summary: List chat threads grouped by time buckets
      operationId: getGroupedThreads
      responses:
        "200":
          description: Grouped chat threads
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ChatThreadGroup"
        "400":
          description: Missing context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      x-hephaestus: *a1
  /mentor/threads/{threadId}:
    get:
      tags:
        - mentor
        - exported
      summary: Get mentor chat thread detail
      operationId: getThread
      parameters:
        - schema:
            type: string
            format: uuid
          required: true
          name: threadId
          in: path
      responses:
        "200":
          description: Thread detail with messages
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ThreadDetail"
        "400":
          description: Missing required context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Thread not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "503":
          description: Service temporarily unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      x-hephaestus: *a1
  /mentor/documents:
    post:
      tags:
        - documents
        - exported
      summary: Create a new document
      operationId: createDocument
      requestBody:
        description: Create document
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateDocumentRequest"
      responses:
        "201":
          description: Created document
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Document"
        "400":
          description: Missing required context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      x-hephaestus: *a1
    get:
      tags:
        - documents
        - exported
      summary: List documents owned by the authenticated user
      operationId: listDocuments
      parameters:
        - schema:
            type:
              - integer
              - "null"
            minimum: 0
            default: 0
          required: false
          name: page
          in: query
        - schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          required: false
          name: size
          in: query
      responses:
        "200":
          description: Document summaries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/DocumentSummary"
        "400":
          description: Missing context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      x-hephaestus: *a1
  /mentor/documents/{id}:
    get:
      tags:
        - documents
        - exported
      summary: Get latest version of a document
      operationId: getDocument
      parameters:
        - schema:
            type: string
            format: uuid
          required: true
          name: id
          in: path
      responses:
        "200":
          description: Document
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Document"
        "400":
          description: Missing context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      x-hephaestus: *a1
    put:
      tags:
        - documents
        - exported
      summary: Update a document (creates new version)
      operationId: updateDocument
      parameters:
        - schema:
            type: string
            format: uuid
          required: true
          name: id
          in: path
      requestBody:
        description: Update document
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateDocumentRequest"
      responses:
        "200":
          description: Updated document
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Document"
        "400":
          description: Missing context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      x-hephaestus: *a1
    delete:
      tags:
        - documents
        - exported
      summary: Delete a document and all versions
      operationId: deleteDocument
      parameters:
        - schema:
            type: string
            format: uuid
          required: true
          name: id
          in: path
      responses:
        "204":
          description: Deleted
        "400":
          description: Missing context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      x-hephaestus: *a1
  /mentor/documents/{id}/versions:
    get:
      tags:
        - documents
        - exported
      summary: List versions of a document
      operationId: listVersions
      parameters:
        - schema:
            type: string
            format: uuid
          required: true
          name: id
          in: path
        - schema:
            type:
              - integer
              - "null"
            minimum: 0
            default: 0
          required: false
          name: page
          in: query
        - schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          required: false
          name: size
          in: query
      responses:
        "200":
          description: Document versions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Document"
        "400":
          description: Missing context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      x-hephaestus: *a1
    delete:
      tags:
        - documents
        - exported
      summary: Delete versions after timestamp
      operationId: deleteDocumentVersionsAfter
      parameters:
        - schema:
            type: string
            format: uuid
          required: true
          name: id
          in: path
        - schema:
            type: string
            format: date-time
          required: true
          name: after
          in: query
      responses:
        "200":
          description: Deleted versions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Document"
        "400":
          description: Missing context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      x-hephaestus: *a1
  /mentor/documents/{id}/versions/{versionNumber}:
    get:
      tags:
        - documents
        - exported
      summary: Get specific version
      operationId: getVersion
      parameters:
        - schema:
            type: string
            format: uuid
          required: true
          name: id
          in: path
        - schema:
            type:
              - integer
              - "null"
          required: true
          name: versionNumber
          in: path
      responses:
        "200":
          description: Document
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Document"
        "400":
          description: Missing context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      x-hephaestus: *a1
  /mentor/messages/{messageId}/vote:
    put:
      tags:
        - vote
        - exported
      summary: Vote on a chat message (upvote/downvote) - idempotent upsert
      operationId: voteMessage
      parameters:
        - schema:
            type: string
            format: uuid
          required: true
          name: messageId
          in: path
      requestBody:
        description: Vote request body
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VoteMessageRequest"
      responses:
        "200":
          description: Vote recorded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatMessageVote"
        "400":
          description: Missing context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Message not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      x-hephaestus: *a1
  /mentor/chat:
    post:
      tags:
        - mentor
        - exported
      summary: Handle mentor chat (set greeting=true for initial greeting without user
        message)
      operationId: mentorChat
      requestBody:
        description: Chat request body
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
                message:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                    role:
                      type: string
                      enum:
                        - user
                    parts:
                      type: array
                      items:
                        anyOf:
                          - type: object
                            properties:
                              type:
                                type: string
                                enum:
                                  - text
                              text:
                                type: string
                                minLength: 1
                                maxLength: 2000
                            required:
                              - type
                              - text
                          - type: object
                            properties:
                              type:
                                type: string
                                enum:
                                  - file
                              mediaType:
                                type: string
                                enum:
                                  - image/jpeg
                                  - image/png
                              name:
                                type: string
                                minLength: 1
                                maxLength: 100
                              url:
                                type: string
                                format: uri
                            required:
                              - type
                              - mediaType
                              - name
                              - url
                  required:
                    - id
                    - role
                    - parts
                previousMessageId:
                  type: string
                greeting:
                  type: boolean
                  description: If true, generate a greeting without user message
              required:
                - id
      responses:
        "200":
          description: Event stream of chat updates.
          content:
            text/event-stream:
              schema:
                $ref: "#/components/schemas/StreamPart"
      x-hephaestus: *a1
webhooks: {}
