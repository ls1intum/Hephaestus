# Fetches project items with field values. Cost-optimized page sizes for nested queries.
# See GitHubSyncConstants.java for page size rationale.

query GetProjectItems($nodeId: ID!, $first: Int!, $after: String) {
    rateLimit {
        cost
        limit
        remaining
        resetAt
    }
    node(id: $nodeId) {
        ... on ProjectV2 {
            id
            fullDatabaseId
            number
            items(first: $first, after: $after) {
                pageInfo {
                    hasNextPage
                    endCursor
                }
                totalCount
                nodes {
                    ...ProjectV2ItemFields
                    content {
                        ...ProjectV2ItemContentFields
                    }
                    fieldValues(first: 20) {
                        pageInfo {
                            hasNextPage
                            endCursor
                        }
                        totalCount
                        nodes {
                            ...FieldValueFieldsCostOptimized
                        }
                    }
                }
            }
        }
    }
}

# Fragments ProjectV2ItemFields, ProjectV2ItemContentFields, ActorFieldsCompact,
# and RequestedReviewerFields are resolved from ProjectFragments.graphql
# via ResourceDocumentSource.

# Cost-optimized variant of FieldValueFields with smaller page sizes for nested
# collections (labels: 10, users: 10, pullRequests: 5, reviewers: 10) to reduce
# GraphQL cost when fetching many items at once.
fragment FieldValueFieldsCostOptimized on ProjectV2ItemFieldValue {
    __typename
    ... on ProjectV2ItemFieldTextValue {
        text
        field {
            ... on ProjectV2Field {
                id
                name
            }
        }
    }
    ... on ProjectV2ItemFieldNumberValue {
        number
        field {
            ... on ProjectV2Field {
                id
                name
            }
        }
    }
    ... on ProjectV2ItemFieldDateValue {
        date
        field {
            ... on ProjectV2Field {
                id
                name
            }
        }
    }
    ... on ProjectV2ItemFieldSingleSelectValue {
        optionId
        name
        color
        field {
            ... on ProjectV2SingleSelectField {
                id
                name
            }
        }
    }
    ... on ProjectV2ItemFieldIterationValue {
        iterationId
        title
        startDate
        duration
        field {
            ... on ProjectV2IterationField {
                id
                name
            }
        }
    }
    ... on ProjectV2ItemFieldLabelValue {
        labels(first: 10) {
            pageInfo {
                hasNextPage
            }
            nodes {
                id
                name
                color
            }
        }
        field {
            ... on ProjectV2Field {
                id
                name
            }
        }
    }
    ... on ProjectV2ItemFieldMilestoneValue {
        milestone {
            id
            number
            title
            dueOn
            state
        }
        field {
            ... on ProjectV2Field {
                id
                name
            }
        }
    }
    ... on ProjectV2ItemFieldUserValue {
        users(first: 10) {
            pageInfo {
                hasNextPage
            }
            nodes {
                id
                databaseId
                login
                avatarUrl
            }
        }
        field {
            ... on ProjectV2Field {
                id
                name
            }
        }
    }
    ... on ProjectV2ItemFieldRepositoryValue {
        repository {
            id
            databaseId
            nameWithOwner
        }
        field {
            ... on ProjectV2Field {
                id
                name
            }
        }
    }
    ... on ProjectV2ItemFieldPullRequestValue {
        pullRequests(first: 5) {
            pageInfo {
                hasNextPage
            }
            nodes {
                __typename
                id
                number
                title
                state
            }
        }
        field {
            ... on ProjectV2Field {
                id
                name
            }
        }
    }
    ... on ProjectV2ItemFieldReviewerValue {
        reviewers(first: 10) {
            pageInfo {
                hasNextPage
            }
            nodes {
                ...RequestedReviewerFields
            }
        }
        field {
            ... on ProjectV2Field {
                id
                name
            }
        }
    }
}
