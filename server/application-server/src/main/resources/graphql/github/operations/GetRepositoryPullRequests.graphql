# GraphQL query for fetching repository pull requests with all fields
# Used by GraphQL-based sync services

query GetRepositoryPullRequests($owner: String!, $name: String!, $first: Int!, $after: String, $states: [PullRequestState!]) {
	rateLimit {
		cost
		remaining
		resetAt
	}
	repository(owner: $owner, name: $name) {
		pullRequests(first: $first, after: $after, states: $states, orderBy: { field: UPDATED_AT, direction: DESC }) {
			pageInfo {
				hasNextPage
				endCursor
			}
			totalCount
			nodes {
				id
				fullDatabaseId
				number
				title
				body
				state
				url
				createdAt
				updatedAt
				closedAt
				mergedAt
				isDraft
				additions
				deletions
				changedFiles
				
				# Head and base refs
				headRefName
				baseRefName
				headRefOid
				baseRefOid
				
				# Author
				author {
					__typename
					... on User {
						id
						databaseId
						login
						avatarUrl
						name
						email
					}
					... on Bot {
						id
						databaseId
						login
						avatarUrl
					}
				}
				
				# Merged by
				mergedBy {
					__typename
					... on User {
						id
						databaseId
						login
						avatarUrl
					}
					... on Bot {
						id
						databaseId
						login
						avatarUrl
					}
				}
				
				# Assignees
				assignees(first: 20) {
					nodes {
						id
						databaseId
						login
						avatarUrl
						name
					}
				}
				
				# Requested reviewers
				reviewRequests(first: 20) {
					nodes {
						requestedReviewer {
							__typename
							... on User {
								id
								databaseId
								login
								avatarUrl
							}
							... on Bot {
								id
								databaseId
								login
								avatarUrl
							}
						}
					}
				}
				
				# Labels
				labels(first: 50) {
					nodes {
						id
						name
						description
						color
					}
				}
				
				# Milestone
				milestone {
					id
					number
					title
					description
					state
					dueOn
					url
				}
				
				# Reviews (embedded to avoid N+1 queries)
				# Most PRs have <10 reviews; we'll paginate for PRs with more
				reviews(first: 10) {
					totalCount
					pageInfo {
						hasNextPage
						endCursor
					}
					nodes {
						id
						fullDatabaseId
						body
						state
						url
						submittedAt
						
						# Commit
						commit {
							oid
						}
						
						# Author
						author {
							__typename
							... on User {
								id
								databaseId
								login
								avatarUrl
							}
							... on Bot {
								id
								databaseId
								login
								avatarUrl
							}
						}
					}
				}
			}
		}
	}
}
