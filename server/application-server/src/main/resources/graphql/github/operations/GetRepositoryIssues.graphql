# GraphQL query for fetching repository issues with all fields including issue type
# Used by GitHubIssueSyncService for GraphQL-based sync
# Comments are embedded inline (first 10) to avoid N+1 queries - pagination handles issues with more
# Project items are embedded inline (first 5) - pagination handles issues in more projects
# Supports incremental sync via filterBy.since parameter (filters by updatedAt >= since)

query GetRepositoryIssues(
    $owner: String!
    $name: String!
    $first: Int!
    $after: String
    $states: [IssueState!]
    $since: DateTime
) {
    rateLimit {
        cost
        limit
        remaining
        resetAt
    }
    repository(owner: $owner, name: $name) {
        issues(
            first: $first
            after: $after
            states: $states
            filterBy: { since: $since }
            orderBy: { field: UPDATED_AT, direction: DESC }
        ) {
            pageInfo {
                hasNextPage
                endCursor
            }
            totalCount
            nodes {
                __typename
                id
                fullDatabaseId
                number
                title
                body
                state
                stateReason
                url
                createdAt
                updatedAt
                closedAt
                locked

                # Embedded comments (first 10) - pagination handled by GetIssueComments for issues with more
                comments(first: 10) {
                    totalCount
                    pageInfo {
                        hasNextPage
                        endCursor
                    }
                    nodes {
                        id
                        fullDatabaseId
                        body
                        url
                        createdAt
                        updatedAt

                        # Author
                        author {
                            ...ActorFields
                        }

                        authorAssociation
                    }
                }

                # Issue type (organization-level categorization)
                issueType {
                    id
                    name
                    description
                    color
                    isEnabled
                }

                # Author
                author {
                    ...ActorFields
                }

                # Assignees
                assignees(first: 20) {
                    totalCount
                    nodes {
                        ...UserFields
                    }
                }

                # Labels
                labels(first: 50) {
                    totalCount
                    nodes {
                        id
                        name
                        description
                        color
                    }
                }

                # Milestone
                milestone {
                    id
                    number
                    title
                    description
                    state
                    dueOn
                    url
                }

                # Project items (embedded, first 5) - pagination for issues in more projects
                # Syncs project membership from the issue side for proper historical backfill
                projectItems(first: 5, includeArchived: true) {
                    totalCount
                    pageInfo {
                        hasNextPage
                        endCursor
                    }
                    nodes {
                        id
                        fullDatabaseId
                        type
                        isArchived
                        createdAt
                        updatedAt

                        # Project reference - needed to link item to correct project
                        project {
                            ...ProjectV2RefFields
                        }

                        # Field values (embedded, first 20) - pagination for items with more
                        # Uses shared FieldValueFieldsCostOptimized fragment (all 11 field value types)
                        fieldValues(first: 20) {
                            totalCount
                            pageInfo {
                                hasNextPage
                                endCursor
                            }
                            nodes {
                                ...FieldValueFieldsCostOptimized
                            }
                        }
                    }
                }
            }
        }
    }
}
