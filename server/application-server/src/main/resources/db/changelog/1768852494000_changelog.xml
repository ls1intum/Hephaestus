<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
    =======================================================================================
    Fix Duplicate Repository Records
    =======================================================================================

    Problem:
    - The repository.name_with_owner column had no unique constraint
    - This allowed duplicate records to be created (same nameWithOwner, different IDs)
    - Queries using findByNameWithOwner() could return multiple results
    - This caused NonUniqueResultException crashes during workspace activation

    Solution:
    1. Delete duplicate repository records, keeping the one with the most recent updated_at
       (or highest ID as tiebreaker to ensure deterministic behavior)
    2. Add a unique constraint on name_with_owner column

    Note: Duplicates are deleted using a safe approach that:
    - Keeps the most recently updated record (best data quality)
    - Uses ID as tiebreaker for deterministic results
    - Handles cascading deletes properly via foreign key constraints

    =======================================================================================
    -->

    <!-- Step 1: Remove duplicate repository records, keeping the most recently updated one -->
    <changeSet id="1768852494000-1-deduplicate-repositories" author="FelixTJDietrich">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="repository"/>
            <columnExists tableName="repository" columnName="name_with_owner"/>
            <!-- Only run if duplicates exist -->
            <sqlCheck expectedResult="1">
                SELECT CASE WHEN EXISTS (
                    SELECT name_with_owner
                    FROM repository
                    WHERE name_with_owner IS NOT NULL
                    GROUP BY name_with_owner
                    HAVING COUNT(*) > 1
                ) THEN 1 ELSE 0 END
            </sqlCheck>
        </preConditions>
        <comment>
            Delete duplicate repository records, keeping the one with the most recent
            updated_at timestamp (or highest ID as tiebreaker). This ensures we keep
            the record with the freshest data. Foreign key cascades will clean up
            related records (issues, labels, etc.).
        </comment>
        <sql>
            DELETE FROM repository
            WHERE id IN (
                SELECT id FROM (
                    SELECT id,
                           ROW_NUMBER() OVER (
                               PARTITION BY name_with_owner
                               ORDER BY updated_at DESC NULLS LAST, id DESC
                           ) as rn
                    FROM repository
                    WHERE name_with_owner IS NOT NULL
                ) ranked
                WHERE rn > 1
            );
        </sql>
        <rollback>
            <!-- Duplicates cannot be restored - this is a one-way migration -->
            <empty/>
        </rollback>
    </changeSet>

    <!-- Step 2: Add unique constraint on name_with_owner -->
    <changeSet id="1768852494000-2-add-unique-constraint" author="FelixTJDietrich">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="repository"/>
            <columnExists tableName="repository" columnName="name_with_owner"/>
            <!-- Only add if constraint doesn't already exist -->
            <not>
                <indexExists indexName="uq_repository_name_with_owner"/>
            </not>
        </preConditions>
        <comment>
            Add unique constraint on repository.name_with_owner to prevent future duplicates.
            This ensures findByNameWithOwner() always returns at most one result.
        </comment>
        <addUniqueConstraint
            tableName="repository"
            columnNames="name_with_owner"
            constraintName="uq_repository_name_with_owner"/>
    </changeSet>

</databaseChangeLog>
