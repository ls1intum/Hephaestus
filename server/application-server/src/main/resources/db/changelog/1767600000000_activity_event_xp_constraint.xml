<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
    Activity Event XP Data Integrity

    This changelog adds data integrity constraints for the XP column:
    1. CHECK constraint to ensure XP >= 0 at database level
    2. Covering index for leaderboard SUM(xp) queries (index-only scans)

    Defense-in-depth: The service layer already clamps XP to valid bounds,
    but a database CHECK constraint is the ultimate safety net for data integrity.
    -->

    <!-- Changeset 1: CHECK constraint for XP >= 0 -->
    <changeSet id="1767600000000-1-check-xp-non-negative" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="activity_event"/>
            <columnExists tableName="activity_event" columnName="xp"/>
        </preConditions>
        <sql>
            ALTER TABLE activity_event
            ADD CONSTRAINT chk_activity_event_xp_non_negative
            CHECK (xp >= 0);
        </sql>
        <rollback>
            <sql>
                ALTER TABLE activity_event
                DROP CONSTRAINT IF EXISTS chk_activity_event_xp_non_negative;
            </sql>
        </rollback>
        <comment>Ensure XP values are non-negative at database level - defense-in-depth with service layer clamping</comment>
    </changeSet>

    <!--
    Changeset 2: Covering index for leaderboard aggregation

    The main leaderboard query is:
        SELECT actor_id, SUM(xp), COUNT(*)
        FROM activity_event
        WHERE workspace_id = ? AND occurred_at >= ? AND occurred_at < ?
        GROUP BY actor_id

    Adding xp and actor_id to the existing workspace_occurred index enables
    index-only scans (no heap fetches) for these aggregations.

    Trade-off: Slightly larger index, but dramatically faster leaderboard queries
    on large activity_event tables (100K+ rows).
    -->
    <changeSet id="1767600000000-2-covering-index-leaderboard" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="activity_event"/>
            <not>
                <indexExists indexName="idx_activity_event_leaderboard_covering"/>
            </not>
        </preConditions>
        <createIndex tableName="activity_event" indexName="idx_activity_event_leaderboard_covering">
            <column name="workspace_id"/>
            <column name="occurred_at" descending="true"/>
            <column name="actor_id"/>
            <column name="xp"/>
        </createIndex>
        <rollback>
            <dropIndex tableName="activity_event" indexName="idx_activity_event_leaderboard_covering"/>
        </rollback>
        <comment>Covering index for leaderboard SUM(xp) GROUP BY actor_id queries - enables index-only scans</comment>
    </changeSet>

</databaseChangeLog>
