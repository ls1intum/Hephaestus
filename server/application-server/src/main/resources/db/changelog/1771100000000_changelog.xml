<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- ================================================================== -->
    <!-- Replace uk_user_login unique constraint with case-insensitive index -->
    <!--                                                                    -->
    <!-- The CTE-based upsert in UserRepository uses LOWER(login) for       -->
    <!-- conflict detection, but the old uk_user_login constraint was        -->
    <!-- case-sensitive. This mismatch means the CTE could fail to rename    -->
    <!-- a conflicting user with different casing, causing constraint        -->
    <!-- violations under concurrent cross-scope webhook processing.         -->
    <!--                                                                    -->
    <!-- The new unique index on LOWER(login) ensures that:                  -->
    <!--   1. Login uniqueness is enforced case-insensitively               -->
    <!--   2. The CTE's LOWER(login) matching aligns with the constraint   -->
    <!--   3. ON CONFLICT ON CONSTRAINT can target this index directly      -->
    <!-- ================================================================== -->

    <changeSet id="1771100000000-1" author="Hephaestus">
        <comment>
            Drop case-sensitive uk_user_login constraint and replace with
            a case-insensitive unique index on LOWER(login). This aligns
            the database constraint with the CTE-based upsert logic that
            uses LOWER(login) for conflict detection, preventing race
            conditions under concurrent webhook processing.
        </comment>

        <!-- Drop the old case-sensitive unique constraint -->
        <dropUniqueConstraint
            tableName="user"
            constraintName="uk_user_login"/>

        <!-- Create a case-insensitive unique index -->
        <sql>
            CREATE UNIQUE INDEX uk_user_login_lower ON "user" (LOWER(login));
        </sql>
        <rollback>
            <sql>DROP INDEX IF EXISTS uk_user_login_lower;</sql>
            <addUniqueConstraint
                tableName="user"
                columnNames="login"
                constraintName="uk_user_login"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
