<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd"
>
    <changeSet author="FelixTJDietrich" id="1761774703038-1">
        <createTable tableName="pull_request_review_thread">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pull_request_review_thread_pkey"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="state" type="VARCHAR(20)" defaultValue="UNRESOLVED">
                <constraints nullable="false"/>
            </column>
            <column name="resolved_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="pull_request_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="root_comment_id" type="BIGINT"/>
        </createTable>
    </changeSet>

    <changeSet author="FelixTJDietrich" id="1761774703038-2">
        <addColumn tableName="pull_request_review_comment">
            <column name="thread_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>
            <column name="in_reply_to_id" type="BIGINT"/>
        </addColumn>
    </changeSet>

    <changeSet author="FelixTJDietrich" id="1761774703038-2a">
        <comment>Create a thread for each existing comment, treating each as its own thread</comment>
        <sql>
            INSERT INTO pull_request_review_thread (id, created_at, updated_at, state, pull_request_id, root_comment_id)
            SELECT 
                c.id as id,
                c.created_at,
                c.updated_at,
                'UNRESOLVED' as state,
                c.pull_request_id,
                c.id as root_comment_id
            FROM pull_request_review_comment c
            WHERE c.thread_id IS NULL;
        </sql>
    </changeSet>

    <changeSet author="FelixTJDietrich" id="1761774703038-2b">
        <comment>Link existing comments to their newly created threads</comment>
        <sql>
            UPDATE pull_request_review_comment c
            SET thread_id = c.id
            WHERE c.thread_id IS NULL;
        </sql>
    </changeSet>

    <changeSet author="FelixTJDietrich" id="1761774703038-2c">
        <comment>Add NOT NULL constraint to thread_id after migrating existing data</comment>
        <addNotNullConstraint 
            tableName="pull_request_review_comment" 
            columnName="thread_id" 
            columnDataType="BIGINT"/>
    </changeSet>

    <changeSet author="FelixTJDietrich" id="1761774703038-3">
        <createIndex indexName="idx_pull_request_review_thread_pull_request" tableName="pull_request_review_thread">
            <column name="pull_request_id"/>
        </createIndex>
        <createIndex indexName="idx_pull_request_review_comment_thread" tableName="pull_request_review_comment">
            <column name="thread_id"/>
        </createIndex>
    </changeSet>

    <changeSet author="FelixTJDietrich" id="1761774703038-4">
        <addForeignKeyConstraint
            baseColumnNames="pull_request_id"
            baseTableName="pull_request_review_thread"
            constraintName="fk_pr_review_thread_pull_request"
            referencedColumnNames="id"
            referencedTableName="issue"
            onDelete="NO ACTION"
            onUpdate="NO ACTION"
        />
        <addForeignKeyConstraint
            baseColumnNames="root_comment_id"
            baseTableName="pull_request_review_thread"
            constraintName="fk_pr_review_thread_root_comment"
            referencedColumnNames="id"
            referencedTableName="pull_request_review_comment"
            onDelete="NO ACTION"
            onUpdate="NO ACTION"
        />
        <addForeignKeyConstraint
            baseColumnNames="thread_id"
            baseTableName="pull_request_review_comment"
            constraintName="fk_pr_review_comment_thread"
            referencedColumnNames="id"
            referencedTableName="pull_request_review_thread"
            onDelete="CASCADE"
            onUpdate="NO ACTION"
        />
        <addForeignKeyConstraint
            baseColumnNames="in_reply_to_id"
            baseTableName="pull_request_review_comment"
            constraintName="fk_pr_review_comment_reply"
            referencedColumnNames="id"
            referencedTableName="pull_request_review_comment"
            onDelete="SET NULL"
            onUpdate="NO ACTION"
        />
    </changeSet>

    <changeSet author="FelixTJDietrich" id="1761774703038-5">
        <addUniqueConstraint
            columnNames="root_comment_id"
            constraintName="uq_pr_review_thread_root_comment"
            tableName="pull_request_review_thread"
        />
    </changeSet>
</databaseChangeLog>
