<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- ========================================================================
         Git Commit Tables + Enrichment Columns + Review/Comment Metadata
         ========================================================================

         Introduces commit-level data synced from GitHub push webhooks,
         local git clone backfills, and PR merge events.

         Tables:
           git_commit            – Commit metadata (SHA, timestamps, diff stats, authorship)
           commit_file_change    – File-level change info per commit
           commit_contributor    – Multi-author tracking (primary + co-authors + committer)
           commit_pull_request   – Join table linking commits to associated pull requests

         Also adds enrichment columns to git_commit (signature, parent SHAs,
         CI status, on-behalf-of) and previously-discarded fields to
         pull_request_review and pull_request_review_comment.
    -->

    <!-- 1: Create git_commit table -->
    <changeSet id="1771542830539-1" author="hephaestus">
        <createTable tableName="git_commit">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_git_commit"/>
            </column>
            <column name="sha" type="VARCHAR(40)">
                <constraints nullable="false"/>
            </column>
            <column name="message" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="message_body" type="TEXT"/>
            <column name="html_url" type="VARCHAR(512)"/>
            <column name="authored_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="committed_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="additions" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="deletions" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="changed_files" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="author_email" type="VARCHAR(255)"/>
            <column name="committer_email" type="VARCHAR(255)"/>
            <column name="signature_valid" type="BOOLEAN"/>
            <column name="authored_by_committer" type="BOOLEAN"/>
            <column name="committed_via_web" type="BOOLEAN"/>
            <column name="parent_count" type="INTEGER"/>
            <column name="last_sync_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="repository_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="author_id" type="BIGINT"/>
            <column name="committer_id" type="BIGINT"/>
            <!-- Enrichment columns (signature, parents, CI status, org attribution) -->
            <column name="signature_state" type="VARCHAR(32)"/>
            <column name="signature_was_signed_by_github" type="BOOLEAN"/>
            <column name="signature_signer_login" type="VARCHAR(255)"/>
            <column name="parent_shas" type="TEXT"/>
            <column name="status_check_rollup_state" type="VARCHAR(32)"/>
            <column name="on_behalf_of_login" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <!-- 2: Create commit_file_change table -->
    <changeSet id="1771542830539-2" author="hephaestus">
        <createTable tableName="commit_file_change">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_commit_file_change"/>
            </column>
            <column name="filename" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="change_type" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="additions" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="deletions" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="changes" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="previous_filename" type="VARCHAR(1024)"/>
            <column name="commit_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- 3: Create commit_contributor table -->
    <changeSet id="1771542830539-3" author="hephaestus">
        <createTable tableName="commit_contributor">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_commit_contributor"/>
            </column>
            <column name="commit_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT"/>
            <column name="role" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="ordinal" type="INTEGER" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- 4: Create commit_pull_request join table -->
    <changeSet id="1771542830539-4" author="hephaestus">
        <createTable tableName="commit_pull_request">
            <column name="commit_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="pull_request_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- 5: Foreign keys for git_commit -->
    <changeSet id="1771542830539-5" author="hephaestus">
        <addForeignKeyConstraint
            baseTableName="git_commit" baseColumnNames="repository_id"
            referencedTableName="repository" referencedColumnNames="id"
            constraintName="fk_git_commit_repository"
            onDelete="CASCADE"/>
        <addForeignKeyConstraint
            baseTableName="git_commit" baseColumnNames="author_id"
            referencedTableName="user" referencedColumnNames="id"
            constraintName="fk_git_commit_author"
            onDelete="SET NULL"/>
        <addForeignKeyConstraint
            baseTableName="git_commit" baseColumnNames="committer_id"
            referencedTableName="user" referencedColumnNames="id"
            constraintName="fk_git_commit_committer"
            onDelete="SET NULL"/>
    </changeSet>

    <!-- 6: Foreign keys for commit_file_change -->
    <changeSet id="1771542830539-6" author="hephaestus">
        <addForeignKeyConstraint
            baseTableName="commit_file_change" baseColumnNames="commit_id"
            referencedTableName="git_commit" referencedColumnNames="id"
            constraintName="fk_commit_file_change_commit"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- 7: Foreign keys for commit_contributor -->
    <changeSet id="1771542830539-7" author="hephaestus">
        <addForeignKeyConstraint
            baseTableName="commit_contributor" baseColumnNames="commit_id"
            referencedTableName="git_commit" referencedColumnNames="id"
            constraintName="fk_commit_contributor_commit"
            onDelete="CASCADE"/>
        <addForeignKeyConstraint
            baseTableName="commit_contributor" baseColumnNames="user_id"
            referencedTableName="user" referencedColumnNames="id"
            constraintName="fk_commit_contributor_user"
            onDelete="SET NULL"/>
    </changeSet>

    <!-- 8: Primary key and foreign keys for commit_pull_request -->
    <changeSet id="1771542830539-8" author="hephaestus">
        <addPrimaryKey
            tableName="commit_pull_request"
            columnNames="commit_id, pull_request_id"
            constraintName="pk_commit_pull_request"/>
        <addForeignKeyConstraint
            baseTableName="commit_pull_request" baseColumnNames="commit_id"
            referencedTableName="git_commit" referencedColumnNames="id"
            constraintName="fk_commit_pr_commit"
            onDelete="CASCADE"/>
        <addForeignKeyConstraint
            baseTableName="commit_pull_request" baseColumnNames="pull_request_id"
            referencedTableName="issue" referencedColumnNames="id"
            constraintName="fk_commit_pr_pull_request"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- 9: Unique constraints -->
    <changeSet id="1771542830539-9" author="hephaestus">
        <addUniqueConstraint
            tableName="git_commit"
            columnNames="sha, repository_id"
            constraintName="uq_git_commit_sha_repository"/>
        <addUniqueConstraint
            tableName="commit_contributor"
            columnNames="commit_id, email, role"
            constraintName="uq_commit_contributor_commit_email_role"/>
    </changeSet>

    <!-- 10: Indexes for git_commit -->
    <changeSet id="1771542830539-10" author="hephaestus">
        <createIndex tableName="git_commit" indexName="idx_git_commit_repository_id">
            <column name="repository_id"/>
        </createIndex>
        <createIndex tableName="git_commit" indexName="idx_git_commit_author_id">
            <column name="author_id"/>
        </createIndex>
        <createIndex tableName="git_commit" indexName="idx_git_commit_committer_id">
            <column name="committer_id"/>
        </createIndex>
        <createIndex tableName="git_commit" indexName="idx_git_commit_authored_at">
            <column name="authored_at"/>
        </createIndex>
    </changeSet>

    <!-- 11: Indexes for commit_file_change -->
    <changeSet id="1771542830539-11" author="hephaestus">
        <createIndex tableName="commit_file_change" indexName="idx_commit_file_change_commit_id">
            <column name="commit_id"/>
        </createIndex>
        <createIndex tableName="commit_file_change" indexName="idx_commit_file_change_filename">
            <column name="filename"/>
        </createIndex>
    </changeSet>

    <!-- 12: Indexes for commit_contributor -->
    <changeSet id="1771542830539-12" author="hephaestus">
        <createIndex tableName="commit_contributor" indexName="idx_commit_contributor_commit_id">
            <column name="commit_id"/>
        </createIndex>
        <createIndex tableName="commit_contributor" indexName="idx_commit_contributor_user_id">
            <column name="user_id"/>
        </createIndex>
    </changeSet>

    <!-- 13: Indexes for commit_pull_request -->
    <changeSet id="1771542830539-13" author="hephaestus">
        <createIndex tableName="commit_pull_request" indexName="idx_commit_pull_request_pr_id">
            <column name="pull_request_id"/>
        </createIndex>
    </changeSet>

    <!-- 14: Partial indexes for unresolved author/committer enrichment -->
    <changeSet id="1771542830539-14" author="hephaestus">
        <sql>
            CREATE INDEX idx_git_commit_unresolved_author_email
            ON git_commit (repository_id, author_email)
            WHERE author_id IS NULL AND author_email IS NOT NULL
        </sql>
        <sql>
            CREATE INDEX idx_git_commit_unresolved_committer_email
            ON git_commit (repository_id, committer_email)
            WHERE committer_id IS NULL AND committer_email IS NOT NULL
        </sql>
    </changeSet>

    <!-- 15: Add previously-discarded fields to reviews and review comments -->
    <changeSet id="1771542830539-15" author="hephaestus">
        <addColumn tableName="pull_request_review">
            <column name="created_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="true"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="true"/>
            </column>
            <column name="author_can_push_to_repository" type="BOOLEAN">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="1771542830539-16" author="hephaestus">
        <addColumn tableName="pull_request_review_comment">
            <column name="outdated" type="BOOLEAN">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

</databaseChangeLog>
