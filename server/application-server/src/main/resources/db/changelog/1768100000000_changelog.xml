<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
    =======================================================================================
    Extract User Preferences to Account Module
    =======================================================================================

    The gitprovider User entity had two fields that violated domain isolation:
    - notifications_enabled: Hephaestus platform preference
    - participate_in_research: Hephaestus platform preference

    These belong in the account module, not the gitprovider module which should only
    contain data from the Git provider (GitHub).

    This migration:
    1. Creates a new user_preferences table in the account module
    2. Migrates existing preference data from the user table
    3. Drops the preference columns from the user table
    =======================================================================================
    -->

    <changeSet id="1768100000000-create-user-preferences-table" author="hephaestus">
        <comment>Create user_preferences table for platform preferences (domain isolation from gitprovider)</comment>
        <createTable tableName="user_preferences">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" primaryKeyName="user_preferences_pkey"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" unique="true" uniqueConstraintName="uk_user_preferences_user_id"/>
            </column>
            <column name="notifications_enabled" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="participate_in_research" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableName="user_preferences"
            baseColumnNames="user_id"
            constraintName="fk_user_preferences_user"
            referencedTableName="user"
            referencedColumnNames="id"
            onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="1768100000000-migrate-user-preferences-data" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="user" columnName="notifications_enabled"/>
        </preConditions>
        <comment>Migrate existing preference data from user table to user_preferences</comment>
        <sql>
            INSERT INTO user_preferences (user_id, notifications_enabled, participate_in_research)
            SELECT id, notifications_enabled, participate_in_research
            FROM "user"
            WHERE notifications_enabled IS NOT NULL OR participate_in_research IS NOT NULL
        </sql>
    </changeSet>

    <changeSet id="1768100000000-drop-user-preferences-columns" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="user" columnName="notifications_enabled"/>
        </preConditions>
        <comment>Remove preference columns from user table (now in user_preferences)</comment>
        <dropColumn tableName="user" columnName="notifications_enabled"/>
        <dropColumn tableName="user" columnName="participate_in_research"/>
    </changeSet>

</databaseChangeLog>
