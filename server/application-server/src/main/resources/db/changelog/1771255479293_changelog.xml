<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
    =======================================================================================
    GitHub Projects V2, Sync Timestamps, Performance Indexes, Case-Insensitive Login
    =======================================================================================

    Table of Contents:
    ==================
    SECTION 1: GitHub Projects V2 (project, project_field, project_item, project_field_value, project_status_update)
    SECTION 2: Split Issue/PR Sync Timestamps (issues_synced_at, pull_requests_synced_at)
    SECTION 3: Projects V2 Performance Indexes (content_type+archived, orphan relink)
    SECTION 4: Case-Insensitive User Login (uk_user_login_lower)
    -->

    <!-- ==================== SECTION 1: GitHub Projects V2 ==================== -->
    <!--
    Adds five tables to model GitHub Projects V2:
      project              - Project board metadata
      project_field        - Custom field definitions (EAV schema)
      project_item         - Rows: Issue, PR, or Draft Issue
      project_field_value  - Field values per item (EAV values)
      project_status_update - Timeline status updates

    Also drops orphan tables left by removed Hibernate entities.
    -->

    <!-- 1. Project table -->
    <changeSet id="1770489781375-1" author="FelixTJDietrich">
        <createTable tableName="project">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="project_pkey"/>
            </column>
            <column name="node_id" type="VARCHAR(64)"/>
            <column name="owner_type" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="owner_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="number" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(256)"/>
            <column name="short_description" type="TEXT"/>
            <column name="readme" type="TEXT"/>
            <column name="template" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="url" type="VARCHAR(512)"/>
            <column name="closed" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="closed_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="is_public" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="creator_id" type="BIGINT"/>
            <column name="last_sync_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="item_sync_cursor" type="VARCHAR(256)"/>
            <column name="items_synced_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="field_sync_cursor" type="VARCHAR(256)"/>
            <column name="fields_synced_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="status_update_sync_cursor" type="VARCHAR(256)"/>
            <column name="status_updates_synced_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>

        <addUniqueConstraint tableName="project" columnNames="owner_type, owner_id, number"
                             constraintName="uk_project_owner_number"/>

        <addUniqueConstraint tableName="project" columnNames="node_id"
                             constraintName="uk_project_node_id"/>

        <addForeignKeyConstraint baseTableName="project" baseColumnNames="creator_id"
                                 referencedTableName="user" referencedColumnNames="id"
                                 constraintName="fk_project_creator" onDelete="SET NULL"/>

        <createIndex tableName="project" indexName="idx_project_owner">
            <column name="owner_type"/>
            <column name="owner_id"/>
        </createIndex>

        <createIndex tableName="project" indexName="idx_project_creator_id">
            <column name="creator_id"/>
        </createIndex>
    </changeSet>

    <!-- 2. Project field table (custom field definitions) -->
    <changeSet id="1770489781375-2" author="FelixTJDietrich">
        <createTable tableName="project_field">
            <column name="id" type="VARCHAR(64)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="project_field_pkey"/>
            </column>
            <column name="project_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(256)">
                <constraints nullable="false"/>
            </column>
            <column name="data_type" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="options" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>

        <addUniqueConstraint tableName="project_field" columnNames="project_id, name"
                             constraintName="uk_project_field_project_name"/>

        <addForeignKeyConstraint baseTableName="project_field" baseColumnNames="project_id"
                                 referencedTableName="project" referencedColumnNames="id"
                                 constraintName="fk_project_field_project" onDelete="CASCADE"/>

        <createIndex tableName="project_field" indexName="idx_project_field_project_id">
            <column name="project_id"/>
        </createIndex>
    </changeSet>

    <!-- 3. Project item table (issue, PR, or draft issue rows) -->
    <changeSet id="1770489781375-3" author="FelixTJDietrich">
        <createTable tableName="project_item">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="project_item_pkey"/>
            </column>
            <column name="node_id" type="VARCHAR(64)"/>
            <column name="project_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="content_type" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="issue_id" type="BIGINT"/>
            <column name="content_database_id" type="BIGINT"/>
            <column name="draft_title" type="VARCHAR(1024)"/>
            <column name="draft_body" type="TEXT"/>
            <column name="archived" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="creator_id" type="BIGINT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>

        <addUniqueConstraint tableName="project_item" columnNames="project_id, node_id"
                             constraintName="uk_project_item_project_nodeid"/>

        <addForeignKeyConstraint baseTableName="project_item" baseColumnNames="project_id"
                                 referencedTableName="project" referencedColumnNames="id"
                                 constraintName="fk_project_item_project" onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="project_item" baseColumnNames="issue_id"
                                 referencedTableName="issue" referencedColumnNames="id"
                                 constraintName="fk_project_item_issue" onDelete="SET NULL"/>

        <addForeignKeyConstraint baseTableName="project_item" baseColumnNames="creator_id"
                                 referencedTableName="user" referencedColumnNames="id"
                                 constraintName="fk_project_item_creator" onDelete="SET NULL"/>

        <createIndex tableName="project_item" indexName="idx_project_item_issue_id">
            <column name="issue_id"/>
        </createIndex>

        <createIndex tableName="project_item" indexName="idx_project_item_project_archived">
            <column name="project_id"/>
            <column name="archived"/>
        </createIndex>

        <createIndex tableName="project_item" indexName="idx_project_item_creator_id">
            <column name="creator_id"/>
        </createIndex>
    </changeSet>

    <!-- 4. Project field value table (EAV values) -->
    <changeSet id="1770489781375-4" author="FelixTJDietrich">
        <createTable tableName="project_field_value">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" primaryKeyName="project_field_value_pkey"/>
            </column>
            <column name="item_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="field_id" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="text_value" type="TEXT"/>
            <column name="number_value" type="DOUBLE PRECISION"/>
            <column name="date_value" type="DATE"/>
            <column name="single_select_option_id" type="VARCHAR(64)"/>
            <column name="iteration_id" type="VARCHAR(64)"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>

        <addUniqueConstraint tableName="project_field_value" columnNames="item_id, field_id"
                             constraintName="uk_project_field_value_item_field"/>

        <addForeignKeyConstraint baseTableName="project_field_value" baseColumnNames="item_id"
                                 referencedTableName="project_item" referencedColumnNames="id"
                                 constraintName="fk_project_field_value_item" onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="project_field_value" baseColumnNames="field_id"
                                 referencedTableName="project_field" referencedColumnNames="id"
                                 constraintName="fk_project_field_value_field" onDelete="CASCADE"/>

        <createIndex tableName="project_field_value" indexName="idx_project_field_value_item_id">
            <column name="item_id"/>
        </createIndex>

        <createIndex tableName="project_field_value" indexName="idx_project_field_value_field_id">
            <column name="field_id"/>
        </createIndex>
    </changeSet>

    <!-- 5. Project status update table -->
    <changeSet id="1770489781375-5" author="FelixTJDietrich">
        <createTable tableName="project_status_update">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="project_status_update_pkey"/>
            </column>
            <column name="node_id" type="VARCHAR(64)"/>
            <column name="project_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="body" type="TEXT"/>
            <column name="body_html" type="TEXT"/>
            <column name="start_date" type="DATE"/>
            <column name="target_date" type="DATE"/>
            <column name="status" type="VARCHAR(32)"/>
            <column name="creator_id" type="BIGINT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>

        <addUniqueConstraint tableName="project_status_update" columnNames="node_id"
                             constraintName="uk_project_status_update_node_id"/>

        <addForeignKeyConstraint baseTableName="project_status_update" baseColumnNames="project_id"
                                 referencedTableName="project" referencedColumnNames="id"
                                 constraintName="fk_project_status_update_project" onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="project_status_update" baseColumnNames="creator_id"
                                 referencedTableName="user" referencedColumnNames="id"
                                 constraintName="fk_project_status_update_creator" onDelete="SET NULL"/>

        <createIndex tableName="project_status_update" indexName="idx_project_status_update_created_at">
            <column name="project_id"/>
            <column name="created_at" descending="true"/>
        </createIndex>

        <createIndex tableName="project_status_update" indexName="idx_project_status_update_creator_id">
            <column name="creator_id"/>
        </createIndex>
    </changeSet>

    <!-- 6. Drop orphan tables from removed Hibernate entities -->
    <changeSet id="1770489781375-6" author="FelixTJDietrich">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="project_view"/>
        </preConditions>
        <dropTable tableName="project_view" cascadeConstraints="true"/>
    </changeSet>

    <changeSet id="1770489781375-7" author="FelixTJDietrich">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="project_workflow"/>
        </preConditions>
        <dropTable tableName="project_workflow" cascadeConstraints="true"/>
    </changeSet>

    <!-- ==================== SECTION 2: Split Issue/PR Sync Timestamps ==================== -->
    <!--
    Replaces the combined issues_and_pull_requests_synced_at column
    with separate issues_synced_at and pull_requests_synced_at columns
    so each sync type can independently track progress.
    -->

    <!-- 1. Add the two new columns -->
    <changeSet id="1770818956382-1" author="FelixTJDietrich">
        <addColumn tableName="repository_to_monitor">
            <column name="issues_synced_at" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
        <addColumn tableName="repository_to_monitor">
            <column name="pull_requests_synced_at" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
    </changeSet>

    <!-- 2. Copy existing data into both new columns -->
    <changeSet id="1770818956382-2" author="FelixTJDietrich">
        <sql>
            UPDATE repository_to_monitor
            SET issues_synced_at = issues_and_pull_requests_synced_at,
                pull_requests_synced_at = issues_and_pull_requests_synced_at
            WHERE issues_and_pull_requests_synced_at IS NOT NULL
        </sql>
    </changeSet>

    <!-- 3. Drop the old combined column -->
    <changeSet id="1770818956382-3" author="FelixTJDietrich">
        <dropColumn tableName="repository_to_monitor" columnName="issues_and_pull_requests_synced_at"/>
    </changeSet>

    <!-- ==================== SECTION 3: Projects V2 Performance Indexes ==================== -->
    <!--
    Adds indexes to optimize:
      1. Stale item removal queries (content_type + archived filter)
      2. Orphaned item relinking (content_database_id lookup)
    -->

    <!-- 1. Composite index for stale removal queries -->
    <changeSet id="1771000000000-1" author="FelixTJDietrich">
        <createIndex tableName="project_item" indexName="idx_project_item_content_type_archived">
            <column name="project_id"/>
            <column name="content_type"/>
            <column name="archived"/>
        </createIndex>
    </changeSet>

    <!-- 2. Partial index for orphaned item relinking -->
    <changeSet id="1771000000000-2" author="FelixTJDietrich">
        <sql>
            CREATE INDEX idx_project_item_orphaned_relink
            ON project_item (content_database_id)
            WHERE issue_id IS NULL
              AND content_database_id IS NOT NULL
              AND content_type IN ('ISSUE', 'PULL_REQUEST');
        </sql>
        <rollback>
            <sql>DROP INDEX IF EXISTS idx_project_item_orphaned_relink;</sql>
        </rollback>
    </changeSet>

    <!-- ==================== SECTION 4: Case-Insensitive User Login ==================== -->
    <!--
    Replace uk_user_login unique constraint with case-insensitive index.
    The upsert in UserRepository uses LOWER(login) for conflict detection.
    This aligns the database constraint with that logic.
    -->

    <changeSet id="1771100000000-1" author="Hephaestus">
        <comment>
            Drop case-sensitive uk_user_login constraint and replace with
            a case-insensitive unique index on LOWER(login). This aligns
            the database constraint with the upsert logic that uses
            LOWER(login) for conflict detection, preventing race
            conditions under concurrent webhook processing.
        </comment>

        <!-- Drop the old case-sensitive unique constraint -->
        <dropUniqueConstraint
            tableName="user"
            constraintName="uk_user_login"/>

        <!-- Create a case-insensitive unique index -->
        <sql>
            CREATE UNIQUE INDEX uk_user_login_lower ON "user" (LOWER(login));
        </sql>
        <rollback>
            <sql>DROP INDEX IF EXISTS uk_user_login_lower;</sql>
            <addUniqueConstraint
                tableName="user"
                columnNames="login"
                constraintName="uk_user_login"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
