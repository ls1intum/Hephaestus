<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
    Dead Letter Event Storage

    This changelog creates the dead_letter_event table for persisting activity events
    that failed to record after retry exhaustion. This enables:
    - Investigation of failure patterns
    - Automated retry of transient failures
    - Audit trail for data integrity
    - Alerting and monitoring dashboards

    Resolution workflow:
    1. Event fails after retries â†’ stored with status=PENDING
    2. Scheduled job or operator investigates
    3. On success: mark RESOLVED; on permanent failure: mark DISCARDED
    4. Cleanup job purges resolved/discarded events after 30 days
    -->

    <changeSet id="1767700000000-1-create-dead-letter-event-table" author="hephaestus">
        <createTable tableName="dead_letter_event">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="workspace_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="event_type" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="occurred_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="actor_id" type="BIGINT"/>
            <column name="repository_id" type="BIGINT"/>
            <column name="target_type" type="VARCHAR(32)"/>
            <column name="target_id" type="BIGINT"/>
            <column name="xp" type="DOUBLE PRECISION">
                <constraints nullable="false"/>
            </column>
            <column name="source_system" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="JSONB"/>
            <column name="error_message" type="VARCHAR(2000)">
                <constraints nullable="false"/>
            </column>
            <column name="error_type" type="VARCHAR(256)"/>
            <column name="stack_trace" type="TEXT"/>
            <column name="retry_count" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(16)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="resolved_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="resolution_notes" type="VARCHAR(1000)"/>
        </createTable>
        <comment>Create dead_letter_event table for persisting failed activity events</comment>
    </changeSet>

    <changeSet id="1767700000000-2-dead-letter-status-created-index" author="hephaestus">
        <createIndex tableName="dead_letter_event" indexName="idx_dead_letter_status_created">
            <column name="status"/>
            <column name="created_at"/>
        </createIndex>
        <comment>Index for finding pending dead letters for retry</comment>
    </changeSet>

    <changeSet id="1767700000000-3-dead-letter-workspace-created-index" author="hephaestus">
        <createIndex tableName="dead_letter_event" indexName="idx_dead_letter_workspace_created">
            <column name="workspace_id"/>
            <column name="created_at" descending="true"/>
        </createIndex>
        <comment>Index for workspace-specific dead letter queries</comment>
    </changeSet>

    <changeSet id="1767700000000-4-dead-letter-event-type-index" author="hephaestus">
        <createIndex tableName="dead_letter_event" indexName="idx_dead_letter_event_type">
            <column name="event_type"/>
            <column name="created_at" descending="true"/>
        </createIndex>
        <comment>Index for analyzing failure patterns by event type</comment>
    </changeSet>

    <changeSet id="1767700000000-5-dead-letter-status-check" author="hephaestus">
        <sql>
            ALTER TABLE dead_letter_event
            ADD CONSTRAINT chk_dead_letter_status
            CHECK (status IN ('PENDING', 'RESOLVED', 'DISCARDED'));
        </sql>
        <rollback>
            <sql>
                ALTER TABLE dead_letter_event
                DROP CONSTRAINT IF EXISTS chk_dead_letter_status;
            </sql>
        </rollback>
        <comment>Ensure status is one of the allowed values</comment>
    </changeSet>

</databaseChangeLog>
