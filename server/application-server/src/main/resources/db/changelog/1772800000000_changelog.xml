<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- ========================================================================
         Add author_email and committer_email columns to git_commit

         These columns store the raw email addresses from git commit metadata,
         enabling negative caching for commit author enrichment. When a commit
         has author_email set but author_id is NULL, enrichment was attempted
         and failed (deleted GitHub account, non-GitHub email, CI bot, etc.).

         This eliminates the need to re-open JGit bare clones during the
         enrichment cycle â€” emails are captured at ingestion time and
         re-resolution uses cheap DB lookups instead.
         ======================================================================== -->

    <!-- Changeset 1: Add author_email column -->
    <changeSet id="1772800000000-1" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="git_commit" columnName="author_email"/>
            </not>
        </preConditions>
        <addColumn tableName="git_commit">
            <column name="author_email" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <!-- Changeset 2: Add committer_email column -->
    <changeSet id="1772800000000-2" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="git_commit" columnName="committer_email"/>
            </not>
        </preConditions>
        <addColumn tableName="git_commit">
            <column name="committer_email" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <!-- Changeset 3: Partial index for unresolved author enrichment queries.
         Covers: SELECT DISTINCT author_email FROM git_commit
                 WHERE repository_id = ? AND author_id IS NULL AND author_email IS NOT NULL
    -->
    <changeSet id="1772800000000-3" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_git_commit_unresolved_author_email"/>
            </not>
        </preConditions>
        <sql>
            CREATE INDEX idx_git_commit_unresolved_author_email
            ON git_commit (repository_id, author_email)
            WHERE author_id IS NULL AND author_email IS NOT NULL
        </sql>
    </changeSet>

    <!-- Changeset 4: Partial index for unresolved committer enrichment queries. -->
    <changeSet id="1772800000000-4" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_git_commit_unresolved_committer_email"/>
            </not>
        </preConditions>
        <sql>
            CREATE INDEX idx_git_commit_unresolved_committer_email
            ON git_commit (repository_id, committer_email)
            WHERE committer_id IS NULL AND committer_email IS NOT NULL
        </sql>
    </changeSet>

</databaseChangeLog>
