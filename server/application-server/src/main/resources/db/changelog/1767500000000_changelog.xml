<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
    =======================================================================================
    Consolidated GraphQL Sync Migration
    =======================================================================================

    This changelog consolidates all schema changes for the hub4j removal refactoring
    and activity event ledger implementation. It combines the following migrations:

    1. TRIAGE permission level documentation
    2. Activity Event Ledger - Event sourcing table for leaderboard/mentor
    3. Issue Types and Sub-Issues - GitHub hierarchy support
    4. Schema Cleanup - Dropping unused columns from hub4j era
    5. Performance Indexes - FK indexes and covering indexes
    6. Activity Event Enhancements - schema_version, FK fixes, XP constraints
    7. Dead Letter Event Table - Failed event persistence
    8. Trigger Context - Audit trail enhancement

    Original files consolidated:
    - 1767287604000_add_triage_permission.xml
    - 1767300000000_graphql_sync_migration.xml
    - 1767400000000_activity_event_ledger_enhancements.xml
    - 1767500000000_activity_event_performance_indexes.xml
    - 1767600000000_activity_event_xp_constraint.xml
    - 1767700000000_dead_letter_event_table.xml
    - 1767800000000_activity_event_trigger_context.xml

    See: docs/contributor/database-migration.mdx
    =======================================================================================
    -->

    <!-- ==================== SECTION 1: Documentation Changesets ==================== -->

    <changeSet id="1767287604000-1-add-triage-permission-doc" author="hephaestus">
        <comment>
            Added TRIAGE permission level to TeamRepositoryPermission.PermissionLevel enum.
            No schema migration needed - the permission column is VARCHAR(32).
            Previously, GitHub TRIAGE permissions were incorrectly mapped to READ.
            After this change, they are correctly stored as TRIAGE.
        </comment>
        <empty/>
    </changeSet>

    <!-- ==================== SECTION 2: Drop Legacy Tables ==================== -->

    <changeSet id="1767300000000-drop-contribution-event" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="contribution_event"/>
        </preConditions>
        <dropTable tableName="contribution_event"/>
    </changeSet>

    <!-- ==================== SECTION 3: Activity Event Ledger ==================== -->
    <!--
    MINIMAL Activity Event Ledger - The Stripe/Square Approach

    One table. 11 columns. 4 indexes. That's it.

    Supports:
    - Leaderboard: COUNT(*) GROUP BY actor_id, event_type
    - Mentor context: WHERE actor_id = ? ORDER BY occurred_at DESC
    - Email attribution: WHERE correlation_id = ? for notification→click chains
    - DX Core 4 metrics: Speed, Effectiveness, Quality, Impact
    -->

    <changeSet id="1767300000000-create-activity-event" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="activity_event"/>
            </not>
        </preConditions>
        <createTable tableName="activity_event">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="event_key" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="event_type" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="occurred_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="actor_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>
            <column name="workspace_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="repository_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>
            <column name="target_type" type="VARCHAR(32)">
                <constraints nullable="true"/>
            </column>
            <column name="target_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>
            <column name="source_system" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="correlation_id" type="UUID">
                <constraints nullable="true"/>
            </column>
            <column name="xp" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="JSONB">
                <constraints nullable="true"/>
            </column>
            <column name="ingested_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addUniqueConstraint
            tableName="activity_event"
            columnNames="workspace_id, event_key"
            constraintName="uk_activity_event_workspace_key"/>

        <createIndex tableName="activity_event" indexName="idx_activity_event_workspace_time">
            <column name="workspace_id"/>
            <column name="occurred_at"/>
        </createIndex>
        <createIndex tableName="activity_event" indexName="idx_activity_event_actor_time">
            <column name="actor_id"/>
            <column name="occurred_at"/>
        </createIndex>
        <createIndex tableName="activity_event" indexName="idx_activity_event_type_time">
            <column name="event_type"/>
            <column name="occurred_at"/>
        </createIndex>
        <createIndex tableName="activity_event" indexName="idx_activity_event_correlation">
            <column name="correlation_id"/>
        </createIndex>
        <createIndex tableName="activity_event" indexName="idx_activity_event_leaderboard">
            <column name="workspace_id"/>
            <column name="actor_id"/>
            <column name="occurred_at"/>
        </createIndex>

        <addForeignKeyConstraint
            baseTableName="activity_event"
            baseColumnNames="workspace_id"
            referencedTableName="workspace"
            referencedColumnNames="id"
            constraintName="fk_activity_event_workspace"/>
        <addForeignKeyConstraint
            baseTableName="activity_event"
            baseColumnNames="actor_id"
            referencedTableName="user"
            referencedColumnNames="id"
            constraintName="fk_activity_event_actor"/>
        <addForeignKeyConstraint
            baseTableName="activity_event"
            baseColumnNames="repository_id"
            referencedTableName="repository"
            referencedColumnNames="id"
            constraintName="fk_activity_event_repository"/>
    </changeSet>

    <!-- ==================== SECTION 4: Issue Types ==================== -->

    <changeSet id="1767300000000-create-issue-type-table" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="issue_type"/>
            </not>
        </preConditions>
        <createTable tableName="issue_type">
            <column name="id" type="varchar(128)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text">
                <constraints nullable="true"/>
            </column>
            <column name="color" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="is_enabled" type="boolean" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="organization_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableName="issue_type"
            baseColumnNames="organization_id"
            referencedTableName="organization"
            referencedColumnNames="id"
            constraintName="fk_issue_type_organization"
            onDelete="CASCADE"/>

        <createIndex tableName="issue_type" indexName="idx_issue_type_organization_id">
            <column name="organization_id"/>
        </createIndex>
    </changeSet>

    <!-- ==================== SECTION 5: Sub-Issues Hierarchy ==================== -->

    <changeSet id="1767300000000-add-sub-issue-hierarchy" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="issue" columnName="parent_issue_id"/>
            </not>
        </preConditions>
        <addColumn tableName="issue">
            <column name="parent_issue_id" type="bigint">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <addForeignKeyConstraint
            baseTableName="issue"
            baseColumnNames="parent_issue_id"
            referencedTableName="issue"
            referencedColumnNames="id"
            constraintName="fk_issue_parent_issue"
            onDelete="SET NULL"/>

        <createIndex tableName="issue" indexName="idx_issue_parent_issue_id">
            <column name="parent_issue_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="1767300000000-add-sub-issue-summary" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="issue" columnName="sub_issues_total"/>
            </not>
        </preConditions>
        <addColumn tableName="issue">
            <column name="sub_issues_total" type="integer">
                <constraints nullable="true"/>
            </column>
            <column name="sub_issues_completed" type="integer">
                <constraints nullable="true"/>
            </column>
            <column name="sub_issues_percent_completed" type="integer">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="1767300000000-add-issue-type-to-issue" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="issue" columnName="issue_type_id"/>
            </not>
        </preConditions>
        <addColumn tableName="issue">
            <column name="issue_type_id" type="varchar(128)">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <addForeignKeyConstraint
            baseTableName="issue"
            baseColumnNames="issue_type_id"
            referencedTableName="issue_type"
            referencedColumnNames="id"
            constraintName="fk_issue_issue_type"
            onDelete="SET NULL"/>

        <createIndex tableName="issue" indexName="idx_issue_issue_type_id">
            <column name="issue_type_id"/>
        </createIndex>
    </changeSet>

    <!-- ==================== SECTION 6: Issue Dependencies ==================== -->

    <changeSet id="1767300000000-create-issue-blocking-table" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="issue_blocking"/>
            </not>
        </preConditions>
        <createTable tableName="issue_blocking">
            <column name="blocked_issue_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="blocking_issue_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="issue_blocking"
            columnNames="blocked_issue_id, blocking_issue_id"
            constraintName="pk_issue_blocking"/>

        <addForeignKeyConstraint
            baseTableName="issue_blocking"
            baseColumnNames="blocked_issue_id"
            referencedTableName="issue"
            referencedColumnNames="id"
            constraintName="fk_issue_blocking_blocked"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableName="issue_blocking"
            baseColumnNames="blocking_issue_id"
            referencedTableName="issue"
            referencedColumnNames="id"
            constraintName="fk_issue_blocking_blocking"
            onDelete="CASCADE"/>

        <createIndex tableName="issue_blocking" indexName="idx_issue_blocking_blocked_id">
            <column name="blocked_issue_id"/>
        </createIndex>
        <createIndex tableName="issue_blocking" indexName="idx_issue_blocking_blocking_id">
            <column name="blocking_issue_id"/>
        </createIndex>
    </changeSet>

    <!-- ==================== SECTION 7: Workspace Sync Timestamps ==================== -->

    <changeSet id="1767300000000-add-workspace-sync-timestamps" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="workspace" columnName="sub_issues_synced_at"/>
            </not>
        </preConditions>
        <addColumn tableName="workspace">
            <column name="sub_issues_synced_at" type="TIMESTAMP(6) WITH TIME ZONE">
                <constraints nullable="true"/>
            </column>
            <column name="issue_types_synced_at" type="TIMESTAMP(6) WITH TIME ZONE">
                <constraints nullable="true"/>
            </column>
            <column name="issue_dependencies_synced_at" type="TIMESTAMP(6) WITH TIME ZONE">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- ==================== SECTION 8: Organization Workspace ID ==================== -->

    <changeSet id="1767300000000-add-organization-workspace-id" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="organization" columnName="workspace_id"/>
            </not>
        </preConditions>
        <addColumn tableName="organization">
            <column name="workspace_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- ==================== SECTION 9: Drop Unused User Columns ==================== -->
    <!--
    Remove columns from user table that were synced by hub4j but never used.
    These fields were deprecated and have no feature use.
    -->

    <changeSet id="1767300000000-drop-user-followers" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="user" columnName="followers"/>
        </preConditions>
        <dropColumn tableName="user" columnName="followers"/>
    </changeSet>

    <changeSet id="1767300000000-drop-user-following" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="user" columnName="following"/>
        </preConditions>
        <dropColumn tableName="user" columnName="following"/>
    </changeSet>

    <changeSet id="1767300000000-drop-user-blog" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="user" columnName="blog"/>
        </preConditions>
        <dropColumn tableName="user" columnName="blog"/>
    </changeSet>

    <changeSet id="1767300000000-drop-user-company" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="user" columnName="company"/>
        </preConditions>
        <dropColumn tableName="user" columnName="company"/>
    </changeSet>

    <changeSet id="1767300000000-drop-user-description" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="user" columnName="description"/>
        </preConditions>
        <dropColumn tableName="user" columnName="description"/>
    </changeSet>

    <changeSet id="1767300000000-drop-user-location" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="user" columnName="location"/>
        </preConditions>
        <dropColumn tableName="user" columnName="location"/>
    </changeSet>

    <changeSet id="1767300000000-drop-user-league-points" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="user" columnName="league_points"/>
        </preConditions>
        <dropColumn tableName="user" columnName="league_points"/>
    </changeSet>

    <!-- Also check hephaestus_user table name variant -->
    <changeSet id="1767300000000-drop-hephaestus-user-league-points" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="hephaestus_user" columnName="league_points"/>
        </preConditions>
        <dropColumn tableName="hephaestus_user" columnName="league_points"/>
    </changeSet>

    <!-- ==================== SECTION 10: Drop Unused Repository Columns ==================== -->

    <changeSet id="1767300000000-drop-repo-has-issues" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="repository" columnName="has_issues"/>
        </preConditions>
        <dropColumn tableName="repository" columnName="has_issues"/>
    </changeSet>

    <changeSet id="1767300000000-drop-repo-has-projects" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="repository" columnName="has_projects"/>
        </preConditions>
        <dropColumn tableName="repository" columnName="has_projects"/>
    </changeSet>

    <changeSet id="1767300000000-drop-repo-has-wiki" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="repository" columnName="has_wiki"/>
        </preConditions>
        <dropColumn tableName="repository" columnName="has_wiki"/>
    </changeSet>

    <changeSet id="1767300000000-drop-repo-homepage" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="repository" columnName="homepage"/>
        </preConditions>
        <dropColumn tableName="repository" columnName="homepage"/>
    </changeSet>

    <changeSet id="1767300000000-drop-repo-stargazers-count" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="repository" columnName="stargazers_count"/>
        </preConditions>
        <dropColumn tableName="repository" columnName="stargazers_count"/>
    </changeSet>

    <changeSet id="1767300000000-drop-repo-watchers-count" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="repository" columnName="watchers_count"/>
        </preConditions>
        <dropColumn tableName="repository" columnName="watchers_count"/>
    </changeSet>

    <!-- ==================== SECTION 11: Drop Unused Issue Columns ==================== -->

    <changeSet id="1767300000000-drop-issue-is-mergeable" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="issue" columnName="is_mergeable"/>
        </preConditions>
        <dropColumn tableName="issue" columnName="is_mergeable"/>
    </changeSet>

    <changeSet id="1767300000000-drop-issue-maintainer-can-modify" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="issue" columnName="maintainer_can_modify"/>
        </preConditions>
        <dropColumn tableName="issue" columnName="maintainer_can_modify"/>
    </changeSet>

    <changeSet id="1767300000000-drop-issue-merge-commit-sha" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="issue" columnName="merge_commit_sha"/>
        </preConditions>
        <dropColumn tableName="issue" columnName="merge_commit_sha"/>
    </changeSet>

    <changeSet id="1767300000000-drop-issue-mergeable-state" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="issue" columnName="mergeable_state"/>
        </preConditions>
        <dropColumn tableName="issue" columnName="mergeable_state"/>
    </changeSet>

    <!-- ==================== SECTION 12: Drop Unused PR Columns ==================== -->

    <changeSet id="1767300000000-drop-pr-bad-practice-summary" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="pullrequest" columnName="bad_practice_summary"/>
        </preConditions>
        <dropColumn tableName="pullrequest" columnName="bad_practice_summary"/>
    </changeSet>

    <changeSet id="1767300000000-drop-pr-last-detection-time" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="pullrequest" columnName="last_detection_time"/>
        </preConditions>
        <dropColumn tableName="pullrequest" columnName="last_detection_time"/>
    </changeSet>

    <!-- ==================== SECTION 13: Drop Deprecated PR Review Comment Columns ==================== -->

    <changeSet id="1767300000000-drop-pr-review-comment-position" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="pull_request_review_comment" columnName="position"/>
        </preConditions>
        <dropColumn tableName="pull_request_review_comment" columnName="position"/>
    </changeSet>

    <changeSet id="1767300000000-drop-pr-review-comment-original-position" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="pull_request_review_comment" columnName="original_position"/>
        </preConditions>
        <dropColumn tableName="pull_request_review_comment" columnName="original_position"/>
    </changeSet>

    <!-- ==================== SECTION 14: Column Type Fixes ==================== -->

    <changeSet id="1767300000000-fix-nodeid-column-length" author="hephaestus">
        <modifyDataType tableName="pull_request_review_thread"
            columnName="node_id"
            newDataType="varchar(128)"/>
    </changeSet>

    <changeSet id="1767300000000-fix-repository-description-type" author="hephaestus">
        <sql>ALTER TABLE repository ALTER COLUMN description TYPE TEXT;</sql>
    </changeSet>

    <!-- ==================== SECTION 15: Performance Indexes ==================== -->
    <!-- Each index in its own changeset with precondition for idempotency -->

    <changeSet id="1767300000000-idx-issue-repository-id" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_issue_repository_id"/></not>
        </preConditions>
        <createIndex tableName="issue" indexName="idx_issue_repository_id">
            <column name="repository_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="1767300000000-idx-issue-author-id" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_issue_author_id"/></not>
        </preConditions>
        <createIndex tableName="issue" indexName="idx_issue_author_id">
            <column name="author_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="1767300000000-idx-issue-state" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_issue_state"/></not>
        </preConditions>
        <createIndex tableName="issue" indexName="idx_issue_state">
            <column name="state"/>
        </createIndex>
    </changeSet>

    <changeSet id="1767300000000-idx-pr-review-author-id" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_pr_review_author_id"/></not>
        </preConditions>
        <createIndex tableName="pull_request_review" indexName="idx_pr_review_author_id">
            <column name="author_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="1767300000000-idx-pr-review-submitted-at" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_pr_review_submitted_at"/></not>
        </preConditions>
        <createIndex tableName="pull_request_review" indexName="idx_pr_review_submitted_at">
            <column name="submitted_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="1767300000000-idx-pr-review-pull-request-id" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_pr_review_pull_request_id"/></not>
        </preConditions>
        <createIndex tableName="pull_request_review" indexName="idx_pr_review_pull_request_id">
            <column name="pull_request_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="1767300000000-idx-issue-comment-author-id" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_issue_comment_author_id"/></not>
        </preConditions>
        <createIndex tableName="issue_comment" indexName="idx_issue_comment_author_id">
            <column name="author_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="1767300000000-idx-issue-comment-created-at" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_issue_comment_created_at"/></not>
        </preConditions>
        <createIndex tableName="issue_comment" indexName="idx_issue_comment_created_at">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="1767300000000-idx-repository-name-with-owner" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_repository_name_with_owner"/></not>
        </preConditions>
        <createIndex tableName="repository" indexName="idx_repository_name_with_owner">
            <column name="name_with_owner"/>
        </createIndex>
    </changeSet>

    <changeSet id="1767300000000-idx-repository-organization-id" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_repository_organization_id"/></not>
        </preConditions>
        <createIndex tableName="repository" indexName="idx_repository_organization_id">
            <column name="organization_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="1767300000000-idx-workspace-membership-user-id" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_workspace_membership_user_id"/></not>
        </preConditions>
        <createIndex tableName="workspace_membership" indexName="idx_workspace_membership_user_id">
            <column name="user_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="1767300000000-idx-chat-message-thread-id" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="idx_chat_message_thread_id"/></not>
        </preConditions>
        <createIndex tableName="chat_message" indexName="idx_chat_message_thread_id">
            <column name="thread_id"/>
        </createIndex>
    </changeSet>

    <!-- ==================== SECTION 16: Activity Event Ledger Enhancements ==================== -->
    <!--
    Improvements to the activity_event table for proper event sourcing and ledger immutability:
    1. schema_version field - Enables forward compatibility for event evolution
    2. actor_id FK fix - SET NULL on delete to preserve history
    3. repository_id FK fix - SET NULL on delete to preserve history
    -->

    <changeSet id="1767400000000-1-add-schema-version" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="activity_event"/>
            <not>
                <columnExists tableName="activity_event" columnName="schema_version"/>
            </not>
        </preConditions>
        <addColumn tableName="activity_event">
            <column name="schema_version" type="INTEGER" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <rollback>
            <dropColumn tableName="activity_event" columnName="schema_version"/>
        </rollback>
        <comment>Add schema_version field for forward compatibility and event evolution</comment>
    </changeSet>

    <changeSet id="1767400000000-2-fix-actor-fk" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyName="fk_activity_event_actor"/>
        </preConditions>
        <dropForeignKeyConstraint
            baseTableName="activity_event"
            constraintName="fk_activity_event_actor"/>
        <addForeignKeyConstraint
            baseTableName="activity_event"
            baseColumnNames="actor_id"
            referencedTableName="user"
            referencedColumnNames="id"
            constraintName="fk_activity_event_actor"
            onDelete="SET NULL"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="activity_event" constraintName="fk_activity_event_actor"/>
            <addForeignKeyConstraint
                baseTableName="activity_event"
                baseColumnNames="actor_id"
                referencedTableName="user"
                referencedColumnNames="id"
                constraintName="fk_activity_event_actor"/>
        </rollback>
        <comment>Update actor_id FK to SET NULL on delete - preserve activity history when user is deleted</comment>
    </changeSet>

    <changeSet id="1767400000000-3-fix-repository-fk" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyName="fk_activity_event_repository"/>
        </preConditions>
        <dropForeignKeyConstraint
            baseTableName="activity_event"
            constraintName="fk_activity_event_repository"/>
        <addForeignKeyConstraint
            baseTableName="activity_event"
            baseColumnNames="repository_id"
            referencedTableName="repository"
            referencedColumnNames="id"
            constraintName="fk_activity_event_repository"
            onDelete="SET NULL"/>
        <rollback>
            <dropForeignKeyConstraint baseTableName="activity_event" constraintName="fk_activity_event_repository"/>
            <addForeignKeyConstraint
                baseTableName="activity_event"
                baseColumnNames="repository_id"
                referencedTableName="repository"
                referencedColumnNames="id"
                constraintName="fk_activity_event_repository"/>
        </rollback>
        <comment>Update repository_id FK to SET NULL on delete - preserve activity history when repository is deleted</comment>
    </changeSet>

    <changeSet id="1767400000000-4-add-target-index" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="activity_event"/>
            <columnExists tableName="activity_event" columnName="target_id"/>
            <columnExists tableName="activity_event" columnName="target_type"/>
            <not>
                <indexExists indexName="idx_activity_event_target"/>
            </not>
        </preConditions>
        <createIndex tableName="activity_event" indexName="idx_activity_event_target">
            <column name="target_id"/>
            <column name="target_type"/>
        </createIndex>
        <rollback>
            <dropIndex tableName="activity_event" indexName="idx_activity_event_target"/>
        </rollback>
        <comment>Add composite index on (target_id, target_type) to optimize queries filtering by target</comment>
    </changeSet>

    <!-- ==================== SECTION 17: Activity Event Performance Indexes ==================== -->
    <!--
    Additional indexes for leaderboard query performance with proper descending order.
    Note: Some indexes may be similar to those created in the table creation changeset,
    but these have optimized column ordering for specific query patterns.
    -->

    <changeSet id="1767500000000-1-idx-workspace-occurred" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="activity_event"/>
            <not>
                <indexExists indexName="idx_activity_event_workspace_occurred"/>
            </not>
        </preConditions>
        <createIndex tableName="activity_event" indexName="idx_activity_event_workspace_occurred">
            <column name="workspace_id"/>
            <column name="occurred_at" descending="true"/>
        </createIndex>
        <rollback>
            <dropIndex tableName="activity_event" indexName="idx_activity_event_workspace_occurred"/>
        </rollback>
        <comment>Composite index for leaderboard aggregation queries filtering by workspace and time range</comment>
    </changeSet>

    <changeSet id="1767500000000-2-idx-actor-occurred" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="activity_event"/>
            <not>
                <indexExists indexName="idx_activity_event_actor_occurred"/>
            </not>
        </preConditions>
        <createIndex tableName="activity_event" indexName="idx_activity_event_actor_occurred">
            <column name="actor_id"/>
            <column name="occurred_at" descending="true"/>
        </createIndex>
        <rollback>
            <dropIndex tableName="activity_event" indexName="idx_activity_event_actor_occurred"/>
        </rollback>
        <comment>Composite index for mentor context queries - user activity feed with time ordering</comment>
    </changeSet>

    <changeSet id="1767500000000-3-idx-workspace-actor-occurred" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="activity_event"/>
            <not>
                <indexExists indexName="idx_activity_event_workspace_actor_occurred"/>
            </not>
        </preConditions>
        <createIndex tableName="activity_event" indexName="idx_activity_event_workspace_actor_occurred">
            <column name="workspace_id"/>
            <column name="actor_id"/>
            <column name="occurred_at" descending="true"/>
        </createIndex>
        <rollback>
            <dropIndex tableName="activity_event" indexName="idx_activity_event_workspace_actor_occurred"/>
        </rollback>
        <comment>Composite index for activity breakdown queries filtering by workspace and specific actors</comment>
    </changeSet>

    <!-- Note: idx_activity_event_correlation is already created in the table creation changeset -->

    <!-- ==================== SECTION 18: Activity Event XP Data Integrity ==================== -->
    <!--
    Data integrity constraints for the XP column:
    1. CHECK constraint to ensure XP >= 0 at database level
    2. Covering index for leaderboard SUM(xp) queries (index-only scans)
    -->

    <changeSet id="1767600000000-1-check-xp-non-negative" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="activity_event"/>
            <columnExists tableName="activity_event" columnName="xp"/>
        </preConditions>
        <sql>
            ALTER TABLE activity_event
            ADD CONSTRAINT chk_activity_event_xp_non_negative
            CHECK (xp >= 0);
        </sql>
        <rollback>
            <sql>
                ALTER TABLE activity_event
                DROP CONSTRAINT IF EXISTS chk_activity_event_xp_non_negative;
            </sql>
        </rollback>
        <comment>Ensure XP values are non-negative at database level - defense-in-depth with service layer clamping</comment>
    </changeSet>

    <!--
    Covering index for leaderboard aggregation - enables index-only scans for:
        SELECT actor_id, SUM(xp), COUNT(*)
        FROM activity_event
        WHERE workspace_id = ? AND occurred_at >= ? AND occurred_at < ?
        GROUP BY actor_id
    -->
    <changeSet id="1767600000000-2-covering-index-leaderboard" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="activity_event"/>
            <not>
                <indexExists indexName="idx_activity_event_leaderboard_covering"/>
            </not>
        </preConditions>
        <createIndex tableName="activity_event" indexName="idx_activity_event_leaderboard_covering">
            <column name="workspace_id"/>
            <column name="occurred_at" descending="true"/>
            <column name="actor_id"/>
            <column name="xp"/>
        </createIndex>
        <rollback>
            <dropIndex tableName="activity_event" indexName="idx_activity_event_leaderboard_covering"/>
        </rollback>
        <comment>Covering index for leaderboard SUM(xp) GROUP BY actor_id queries - enables index-only scans</comment>
    </changeSet>

    <!-- ==================== SECTION 19: Dead Letter Event Storage ==================== -->
    <!--
    Dead letter table for persisting activity events that failed to record after retry exhaustion.
    Enables investigation of failure patterns, automated retry, and audit trail.

    Resolution workflow:
    1. Event fails after retries → stored with status=PENDING
    2. Scheduled job or operator investigates
    3. On success: mark RESOLVED; on permanent failure: mark DISCARDED
    4. Cleanup job purges resolved/discarded events after 30 days
    -->

    <changeSet id="1767700000000-1-create-dead-letter-event-table" author="hephaestus">
        <createTable tableName="dead_letter_event">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="workspace_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="event_type" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="occurred_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="actor_id" type="BIGINT"/>
            <column name="repository_id" type="BIGINT"/>
            <column name="target_type" type="VARCHAR(32)"/>
            <column name="target_id" type="BIGINT"/>
            <column name="xp" type="DOUBLE PRECISION">
                <constraints nullable="false"/>
            </column>
            <column name="source_system" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="JSONB"/>
            <column name="error_message" type="VARCHAR(2000)">
                <constraints nullable="false"/>
            </column>
            <column name="error_type" type="VARCHAR(256)"/>
            <column name="stack_trace" type="TEXT"/>
            <column name="retry_count" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(16)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="resolved_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="resolution_notes" type="VARCHAR(1000)"/>
        </createTable>
        <comment>Create dead_letter_event table for persisting failed activity events</comment>
    </changeSet>

    <changeSet id="1767700000000-2-dead-letter-status-created-index" author="hephaestus">
        <createIndex tableName="dead_letter_event" indexName="idx_dead_letter_status_created">
            <column name="status"/>
            <column name="created_at"/>
        </createIndex>
        <comment>Index for finding pending dead letters for retry</comment>
    </changeSet>

    <changeSet id="1767700000000-3-dead-letter-workspace-created-index" author="hephaestus">
        <createIndex tableName="dead_letter_event" indexName="idx_dead_letter_workspace_created">
            <column name="workspace_id"/>
            <column name="created_at" descending="true"/>
        </createIndex>
        <comment>Index for workspace-specific dead letter queries</comment>
    </changeSet>

    <changeSet id="1767700000000-4-dead-letter-event-type-index" author="hephaestus">
        <createIndex tableName="dead_letter_event" indexName="idx_dead_letter_event_type">
            <column name="event_type"/>
            <column name="created_at" descending="true"/>
        </createIndex>
        <comment>Index for analyzing failure patterns by event type</comment>
    </changeSet>

    <changeSet id="1767700000000-5-dead-letter-status-check" author="hephaestus">
        <sql>
            ALTER TABLE dead_letter_event
            ADD CONSTRAINT chk_dead_letter_status
            CHECK (status IN ('PENDING', 'RESOLVED', 'DISCARDED'));
        </sql>
        <rollback>
            <sql>
                ALTER TABLE dead_letter_event
                DROP CONSTRAINT IF EXISTS chk_dead_letter_status;
            </sql>
        </rollback>
        <comment>Ensure status is one of the allowed values</comment>
    </changeSet>

    <!-- ==================== SECTION 20: Activity Event Trigger Context ==================== -->
    <!--
    Add trigger_context column for audit trail completeness - captures WHY the event occurred.
    -->

    <changeSet id="1767800000000-1" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="activity_event" columnName="trigger_context"/>
            </not>
        </preConditions>
        <comment>Add trigger_context column for audit trail completeness (WHY the event occurred)</comment>
        <addColumn tableName="activity_event">
            <column name="trigger_context" type="varchar(64)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="1767800000000-2" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="idx_activity_event_trigger_context"/>
            </not>
        </preConditions>
        <comment>Index for querying events by trigger context (debugging, audit)</comment>
        <createIndex tableName="activity_event" indexName="idx_activity_event_trigger_context">
            <column name="trigger_context"/>
        </createIndex>
    </changeSet>

    <!-- ==================== SECTION 21: Pull Request GraphQL Fields ==================== -->
    <!--
    Add fields for PR merge state, review decision, and ref information from GraphQL API.
    These replace the webhook-based mergeable fields with GraphQL equivalents.
    -->

    <changeSet id="1767900000000-1" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="issue" columnName="merge_state_status"/>
            </not>
        </preConditions>
        <comment>Add merge_state_status for GraphQL MergeStateStatus enum</comment>
        <addColumn tableName="issue">
            <column name="merge_state_status" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="1767900000000-2" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="issue" columnName="mergeable"/>
            </not>
        </preConditions>
        <comment>Add mergeable boolean for GraphQL mergeable field</comment>
        <addColumn tableName="issue">
            <column name="mergeable" type="BOOLEAN"/>
        </addColumn>
    </changeSet>

    <changeSet id="1767900000000-3" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="issue" columnName="review_decision"/>
            </not>
        </preConditions>
        <comment>Add review_decision for GraphQL PullRequestReviewDecision enum</comment>
        <addColumn tableName="issue">
            <column name="review_decision" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="1767900000000-4" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="issue" columnName="head_ref_name"/>
            </not>
        </preConditions>
        <comment>Add head/base ref names and OIDs for PR branch information</comment>
        <addColumn tableName="issue">
            <column name="head_ref_name" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="1767900000000-5" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="issue" columnName="head_ref_oid"/>
            </not>
        </preConditions>
        <addColumn tableName="issue">
            <column name="head_ref_oid" type="VARCHAR(40)"/>
        </addColumn>
    </changeSet>

    <changeSet id="1767900000000-6" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="issue" columnName="base_ref_name"/>
            </not>
        </preConditions>
        <addColumn tableName="issue">
            <column name="base_ref_name" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="1767900000000-7" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="issue" columnName="base_ref_oid"/>
            </not>
        </preConditions>
        <addColumn tableName="issue">
            <column name="base_ref_oid" type="VARCHAR(40)"/>
        </addColumn>
    </changeSet>

    <!-- ==================== SECTION 22: Activity Event Formula Version ==================== -->

    <changeSet id="1767900000000-8" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="activity_event" columnName="content_hash"/>
            </not>
        </preConditions>
        <comment>Add content_hash for deduplication based on event content</comment>
        <addColumn tableName="activity_event">
            <column name="content_hash" type="VARCHAR(64)"/>
        </addColumn>
    </changeSet>

    <changeSet id="1767900000000-9" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="activity_event" columnName="formula_version"/>
            </not>
        </preConditions>
        <comment>Add formula_version to track XP calculation algorithm version</comment>
        <addColumn tableName="activity_event">
            <column name="formula_version" type="INTEGER" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- ==================== SECTION 23: Cleanup Deprecated Issue Columns ==================== -->

    <changeSet id="1767900000000-10" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="issue" columnName="bad_practice_summary"/>
        </preConditions>
        <comment>Drop deprecated bad_practice_summary column (moved to separate analysis system)</comment>
        <dropColumn tableName="issue" columnName="bad_practice_summary"/>
    </changeSet>

    <changeSet id="1767900000000-11" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="issue" columnName="last_detection_time"/>
        </preConditions>
        <comment>Drop deprecated last_detection_time column (moved to separate analysis system)</comment>
        <dropColumn tableName="issue" columnName="last_detection_time"/>
    </changeSet>

    <!-- ==================== SECTION 24: Issue Enum CHECK Constraints ==================== -->
    <!--
    Add CHECK constraints for enum columns to ensure data integrity at the database level.
    These constraints mirror the Hibernate-generated constraints for consistency between
    local (Hibernate auto-DDL) and CI (Liquibase-only) environments.
    -->

    <changeSet id="1767900000000-12" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="issue" columnName="merge_state_status"/>
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM information_schema.table_constraints 
                WHERE constraint_name = 'issue_merge_state_status_check' AND table_name = 'issue'
            </sqlCheck>
        </preConditions>
        <comment>Add CHECK constraint for merge_state_status enum values (GitHub MergeStateStatus)</comment>
        <sql>
            ALTER TABLE issue ADD CONSTRAINT issue_merge_state_status_check
            CHECK ((merge_state_status)::text = ANY (ARRAY['BEHIND'::text, 'BLOCKED'::text, 'CLEAN'::text, 'DIRTY'::text, 'HAS_HOOKS'::text, 'UNKNOWN'::text, 'UNSTABLE'::text]));
        </sql>
        <rollback>
            <sql>
                ALTER TABLE issue DROP CONSTRAINT IF EXISTS issue_merge_state_status_check;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="1767900000000-13" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="issue" columnName="review_decision"/>
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM information_schema.table_constraints 
                WHERE constraint_name = 'issue_review_decision_check' AND table_name = 'issue'
            </sqlCheck>
        </preConditions>
        <comment>Add CHECK constraint for review_decision enum values (GitHub PullRequestReviewDecision)</comment>
        <sql>
            ALTER TABLE issue ADD CONSTRAINT issue_review_decision_check
            CHECK ((review_decision)::text = ANY (ARRAY['APPROVED'::text, 'CHANGES_REQUESTED'::text, 'REVIEW_REQUIRED'::text]));
        </sql>
        <rollback>
            <sql>
                ALTER TABLE issue DROP CONSTRAINT IF EXISTS issue_review_decision_check;
            </sql>
        </rollback>
    </changeSet>

    <!-- ==================== SECTION 25: PullRequestBadPractice Enum Migration ==================== -->
    <!--
    Migrate pullrequestbadpractice enum columns from ordinal (smallint) to string (varchar).
    
    This migration converts the enum columns to use EnumType.STRING storage for better
    maintainability and debugging. The ordinal values are mapped to their enum names.
    -->

    <!-- Step 1: Add temporary varchar columns -->
    <changeSet id="1767900000000-14-add-temp-columns" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="pullrequestbadpractice"/>
            <columnExists tableName="pullrequestbadpractice" columnName="state"/>
        </preConditions>
        <comment>Add temporary varchar columns for enum string values</comment>
        
        <addColumn tableName="pullrequestbadpractice">
            <column name="state_new" type="VARCHAR(32)"/>
        </addColumn>
        <addColumn tableName="pullrequestbadpractice">
            <column name="user_state_new" type="VARCHAR(32)"/>
        </addColumn>
        <addColumn tableName="pullrequestbadpractice">
            <column name="detection_pullrequest_lifecycle_state_new" type="VARCHAR(32)"/>
        </addColumn>
    </changeSet>

    <!-- Step 2: Migrate state column (PullRequestBadPracticeState enum) -->
    <changeSet id="1767900000000-15-migrate-state" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="pullrequestbadpractice" columnName="state_new"/>
        </preConditions>
        <comment>Migrate state ordinals to enum names</comment>
        <sql>
            UPDATE pullrequestbadpractice SET state_new = CASE state
                WHEN 0 THEN 'GOOD_PRACTICE'
                WHEN 1 THEN 'MINOR_ISSUE'
                WHEN 2 THEN 'NORMAL_ISSUE'
                WHEN 3 THEN 'CRITICAL_ISSUE'
                WHEN 4 THEN 'FIXED'
                WHEN 5 THEN 'WONT_FIX'
                WHEN 6 THEN 'WRONG'
                ELSE 'NORMAL_ISSUE'
            END
            WHERE state IS NOT NULL;
        </sql>
    </changeSet>

    <!-- Step 3: Migrate user_state column (PullRequestBadPracticeState enum) -->
    <changeSet id="1767900000000-16-migrate-user-state" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="pullrequestbadpractice" columnName="user_state_new"/>
        </preConditions>
        <comment>Migrate user_state ordinals to enum names</comment>
        <sql>
            UPDATE pullrequestbadpractice SET user_state_new = CASE user_state
                WHEN 0 THEN 'GOOD_PRACTICE'
                WHEN 1 THEN 'MINOR_ISSUE'
                WHEN 2 THEN 'NORMAL_ISSUE'
                WHEN 3 THEN 'CRITICAL_ISSUE'
                WHEN 4 THEN 'FIXED'
                WHEN 5 THEN 'WONT_FIX'
                WHEN 6 THEN 'WRONG'
                ELSE NULL
            END
            WHERE user_state IS NOT NULL;
        </sql>
    </changeSet>

    <!-- Step 4: Migrate detection_pullrequest_lifecycle_state column (PullRequestLifecycleState enum) -->
    <changeSet id="1767900000000-17-migrate-lifecycle-state" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="pullrequestbadpractice" columnName="detection_pullrequest_lifecycle_state_new"/>
        </preConditions>
        <comment>Migrate detection_pullrequest_lifecycle_state ordinals to enum names</comment>
        <sql>
            UPDATE pullrequestbadpractice SET detection_pullrequest_lifecycle_state_new = CASE detection_pullrequest_lifecycle_state
                WHEN 0 THEN 'DRAFT'
                WHEN 1 THEN 'OPEN'
                WHEN 2 THEN 'READY_FOR_REVIEW'
                WHEN 3 THEN 'READY_TO_MERGE'
                WHEN 4 THEN 'MERGED'
                WHEN 5 THEN 'CLOSED'
                ELSE NULL
            END
            WHERE detection_pullrequest_lifecycle_state IS NOT NULL;
        </sql>
    </changeSet>

    <!-- Step 5: Drop old columns and rename new ones -->
    <changeSet id="1767900000000-18-swap-columns" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="pullrequestbadpractice" columnName="state_new"/>
        </preConditions>
        <comment>Replace old smallint columns with new varchar columns</comment>
        
        <dropColumn tableName="pullrequestbadpractice" columnName="state"/>
        <renameColumn tableName="pullrequestbadpractice" oldColumnName="state_new" newColumnName="state"/>
        
        <dropColumn tableName="pullrequestbadpractice" columnName="user_state"/>
        <renameColumn tableName="pullrequestbadpractice" oldColumnName="user_state_new" newColumnName="user_state"/>
        
        <dropColumn tableName="pullrequestbadpractice" columnName="detection_pullrequest_lifecycle_state"/>
        <renameColumn tableName="pullrequestbadpractice" oldColumnName="detection_pullrequest_lifecycle_state_new" newColumnName="detection_pullrequest_lifecycle_state"/>
    </changeSet>

    <!-- Step 6: Explicitly set column types to match Hibernate entity expectations -->
    <changeSet id="1767900000000-19-fix-column-types" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="pullrequestbadpractice" columnName="state"/>
        </preConditions>
        <comment>Ensure enum columns have correct varchar(32) type to match Hibernate entity @Column(length=32)</comment>
        
        <modifyDataType tableName="pullrequestbadpractice" columnName="state" newDataType="varchar(32)"/>
        <modifyDataType tableName="pullrequestbadpractice" columnName="user_state" newDataType="varchar(32)"/>
        <modifyDataType tableName="pullrequestbadpractice" columnName="detection_pullrequest_lifecycle_state" newDataType="varchar(32)"/>
    </changeSet>

</databaseChangeLog>
