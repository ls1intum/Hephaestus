<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
    =======================================================================================
    GitHub Discussions Feature Migration
    =======================================================================================

    Adds full support for GitHub Discussions synchronization.

    New tables:
      - discussion_category   (String PK via node_id — GitHub exposes no databaseId)
      - discussion            (extends BaseGitServiceEntity)
      - discussion_comment    (extends BaseGitServiceEntity, self-referential threading)
      - discussion_label      (join table for discussion ↔ label M:N)

    Altered tables:
      - repository            — has_discussions_enabled flag
      - repository_to_monitor — discussion_sync_cursor, discussions_synced_at

    See: https://github.com/ls1intum/Hephaestus/pull/693
    =======================================================================================
    -->

    <!-- ==================== SECTION 1: Alter existing tables ==================== -->

    <changeSet id="1772037098233-1" author="hephaestus">
        <comment>Add discussion-related columns to repository and repository_to_monitor</comment>
        <addColumn tableName="repository">
            <column name="has_discussions_enabled" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="repository_to_monitor">
            <column name="discussion_sync_cursor" type="VARCHAR(255)"/>
            <column name="discussions_synced_at" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
    </changeSet>

    <!-- ==================== SECTION 2: Discussion Category Table ==================== -->

    <changeSet id="1772037098233-2" author="hephaestus">
        <comment>Create discussion_category table</comment>
        <createTable tableName="discussion_category">
            <!-- Primary key is node_id (String) since GitHub exposes no databaseId for categories -->
            <column name="id" type="VARCHAR(128)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="slug" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="emoji" type="VARCHAR(32)"/>
            <column name="description" type="TEXT"/>
            <column name="is_answerable" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="repository_id" type="BIGINT"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
        </createTable>
    </changeSet>

    <!-- ==================== SECTION 3: Discussion Table ==================== -->

    <changeSet id="1772037098233-3" author="hephaestus">
        <comment>Create discussion table</comment>
        <createTable tableName="discussion">
            <column name="id" type="BIGINT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="number" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="body" type="TEXT"/>
            <column name="html_url" type="VARCHAR(512)">
                <constraints nullable="false"/>
            </column>
            <column name="state" type="VARCHAR(16)">
                <constraints nullable="false"/>
            </column>
            <column name="state_reason" type="VARCHAR(32)"/>
            <column name="upvote_count" type="INTEGER" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="is_locked" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="active_lock_reason" type="VARCHAR(32)"/>
            <column name="closed_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="answer_chosen_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="comment_count" type="INTEGER" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="last_sync_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="repository_id" type="BIGINT"/>
            <column name="author_id" type="BIGINT"/>
            <column name="category_id" type="VARCHAR(128)"/>
            <column name="answer_chosen_by_id" type="BIGINT"/>
            <column name="answer_comment_id" type="BIGINT"/>
        </createTable>
    </changeSet>

    <!-- ==================== SECTION 4: Discussion Comment Table ==================== -->

    <changeSet id="1772037098233-4" author="hephaestus">
        <comment>Create discussion_comment table</comment>
        <createTable tableName="discussion_comment">
            <column name="id" type="BIGINT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="body" type="TEXT"/>
            <column name="html_url" type="VARCHAR(512)">
                <constraints nullable="false"/>
            </column>
            <column name="is_answer" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="is_minimized" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="minimized_reason" type="VARCHAR(64)"/>
            <column name="author_association" type="VARCHAR(32)"/>
            <column name="last_sync_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="discussion_id" type="BIGINT"/>
            <column name="author_id" type="BIGINT"/>
            <column name="parent_comment_id" type="BIGINT"/>
        </createTable>
    </changeSet>

    <!-- ==================== SECTION 5: Discussion-Label Join Table ==================== -->

    <changeSet id="1772037098233-5" author="hephaestus">
        <comment>Create discussion_label join table</comment>
        <createTable tableName="discussion_label">
            <column name="discussion_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="label_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="discussion_label" columnNames="discussion_id, label_id"/>
    </changeSet>

    <!-- ==================== SECTION 6: Foreign Key Constraints ==================== -->

    <changeSet id="1772037098233-6" author="hephaestus">
        <comment>Add foreign key constraints for discussion tables</comment>

        <addForeignKeyConstraint baseTableName="discussion_category" baseColumnNames="repository_id"
                                 constraintName="fk_discussion_category_repository"
                                 referencedTableName="repository" referencedColumnNames="id"
                                 onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="discussion" baseColumnNames="repository_id"
                                 constraintName="fk_discussion_repository"
                                 referencedTableName="repository" referencedColumnNames="id"
                                 onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="discussion" baseColumnNames="author_id"
                                 constraintName="fk_discussion_author"
                                 referencedTableName="user" referencedColumnNames="id"
                                 onDelete="SET NULL"/>

        <addForeignKeyConstraint baseTableName="discussion" baseColumnNames="category_id"
                                 constraintName="fk_discussion_category"
                                 referencedTableName="discussion_category" referencedColumnNames="id"
                                 onDelete="SET NULL"/>

        <addForeignKeyConstraint baseTableName="discussion" baseColumnNames="answer_chosen_by_id"
                                 constraintName="fk_discussion_answer_chosen_by"
                                 referencedTableName="user" referencedColumnNames="id"
                                 onDelete="SET NULL"/>

        <addForeignKeyConstraint baseTableName="discussion" baseColumnNames="answer_comment_id"
                                 constraintName="fk_discussion_answer_comment"
                                 referencedTableName="discussion_comment" referencedColumnNames="id"
                                 onDelete="SET NULL"/>

        <addForeignKeyConstraint baseTableName="discussion_comment" baseColumnNames="discussion_id"
                                 constraintName="fk_discussion_comment_discussion"
                                 referencedTableName="discussion" referencedColumnNames="id"
                                 onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="discussion_comment" baseColumnNames="author_id"
                                 constraintName="fk_discussion_comment_author"
                                 referencedTableName="user" referencedColumnNames="id"
                                 onDelete="SET NULL"/>

        <addForeignKeyConstraint baseTableName="discussion_comment" baseColumnNames="parent_comment_id"
                                 constraintName="fk_discussion_comment_parent"
                                 referencedTableName="discussion_comment" referencedColumnNames="id"
                                 onDelete="SET NULL"/>

        <addForeignKeyConstraint baseTableName="discussion_label" baseColumnNames="discussion_id"
                                 constraintName="fk_discussion_label_discussion"
                                 referencedTableName="discussion" referencedColumnNames="id"
                                 onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="discussion_label" baseColumnNames="label_id"
                                 constraintName="fk_discussion_label_label"
                                 referencedTableName="label" referencedColumnNames="id"
                                 onDelete="CASCADE"/>
    </changeSet>

    <!-- ==================== SECTION 7: Unique Constraints ==================== -->

    <changeSet id="1772037098233-7" author="hephaestus">
        <comment>Add unique constraints for discussion tables</comment>

        <addUniqueConstraint tableName="discussion_category"
                             columnNames="repository_id, slug"
                             constraintName="uq_discussion_category_repo_slug"/>

        <addUniqueConstraint tableName="discussion"
                             columnNames="repository_id, number"
                             constraintName="uq_discussion_repo_number"/>

        <addUniqueConstraint tableName="discussion"
                             columnNames="answer_comment_id"
                             constraintName="uk_discussion_answer_comment_id"/>
    </changeSet>

    <!-- ==================== SECTION 8: Performance Indexes ==================== -->

    <changeSet id="1772037098233-8" author="hephaestus">
        <comment>Add performance indexes for discussion tables</comment>

        <createIndex tableName="discussion" indexName="idx_discussion_repository">
            <column name="repository_id"/>
        </createIndex>
        <createIndex tableName="discussion" indexName="idx_discussion_author">
            <column name="author_id"/>
        </createIndex>
        <createIndex tableName="discussion" indexName="idx_discussion_category">
            <column name="category_id"/>
        </createIndex>
        <createIndex tableName="discussion" indexName="idx_discussion_state">
            <column name="state"/>
        </createIndex>
        <createIndex tableName="discussion" indexName="idx_discussion_created_at">
            <column name="created_at"/>
        </createIndex>

        <createIndex tableName="discussion_comment" indexName="idx_discussion_comment_discussion">
            <column name="discussion_id"/>
        </createIndex>
        <createIndex tableName="discussion_comment" indexName="idx_discussion_comment_discussion_created">
            <column name="discussion_id"/>
            <column name="created_at"/>
        </createIndex>
        <createIndex tableName="discussion_comment" indexName="idx_discussion_comment_author">
            <column name="author_id"/>
        </createIndex>
        <createIndex tableName="discussion_comment" indexName="idx_discussion_comment_parent">
            <column name="parent_comment_id"/>
        </createIndex>
        <createIndex tableName="discussion_comment" indexName="idx_discussion_comment_is_answer">
            <column name="is_answer"/>
        </createIndex>

        <createIndex tableName="discussion_category" indexName="idx_discussion_category_repository">
            <column name="repository_id"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
