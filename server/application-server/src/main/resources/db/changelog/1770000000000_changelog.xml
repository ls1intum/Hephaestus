<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
    =======================================================================================
    Achievement Performance Optimization Migration
    =======================================================================================

    This changelog adds the current_value column to user_achievement table to support
    incremental achievement progress tracking. This avoids expensive COUNT(*) queries
    on the ActivityEvent table when checking achievement progress.

    See: plans.md item #2 (Performance Optimization)
    =======================================================================================
    -->

    <changeSet id="1770000000000-add-current-value-to-user-achievement" author="Hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="user_achievement"/>
            <not>
                <columnExists tableName="user_achievement" columnName="current_value"/>
            </not>
        </preConditions>
        <comment>
            Add current_value column to user_achievement for incremental progress tracking.
            This optimization avoids COUNT(*) queries on ActivityEvent table for every event.
        </comment>
        <addColumn tableName="user_achievement">
            <column name="current_value" type="BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <!--
    Backfill current_value from existing activity events.
    This ensures existing achievement records have accurate progress counts.
    -->
    <changeSet id="1770000000000-backfill-current-value" author="Hephaestus">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="user_achievement" columnName="current_value"/>
        </preConditions>
        <comment>
            Backfill current_value based on the required count from the achievement definition.
            For unlocked achievements, set current_value to match the threshold at unlock time.
        </comment>
        <!--
        Note: We cannot easily backfill from ActivityEvent without knowing the exact
        achievement -> event type mapping at database level. For unlocked achievements,
        we set current_value to the required count (since threshold was met to unlock).
        New achievements going forward will use incremental counting.

        This is handled in application code via AchievementService initialization.
        -->
    </changeSet>

</databaseChangeLog>
