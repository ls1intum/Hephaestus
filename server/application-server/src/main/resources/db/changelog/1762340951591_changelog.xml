<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <changeSet id="1762340951591-add-thread-metadata" author="FelixTJDietrich">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="pull_request_review_thread" columnName="provider_thread_id"/>
            </not>
        </preConditions>

        <addColumn tableName="pull_request_review_thread">
            <column name="provider_thread_id" type="BIGINT"/>
            <column name="node_id" type="VARCHAR(64)"/>
            <column name="path" type="TEXT"/>
            <column name="line" type="INTEGER"/>
            <column name="start_line" type="INTEGER"/>
            <column name="side" type="VARCHAR(16)"/>
            <column name="start_side" type="VARCHAR(16)"/>
            <column name="outdated" type="BOOLEAN"/>
            <column name="collapsed" type="BOOLEAN"/>
            <column name="resolved_by_id" type="BIGINT"/>
        </addColumn>

        <addForeignKeyConstraint
            baseTableName="pull_request_review_thread"
            baseColumnNames="resolved_by_id"
            referencedTableName="user"
            referencedColumnNames="id"
            onDelete="SET NULL"
            constraintName="fk_pull_request_review_thread_resolved_by"
        />

        <createIndex
            tableName="pull_request_review_thread"
            indexName="idx_pull_request_review_thread_provider"
        >
            <column name="provider_thread_id"/>
        </createIndex>

        <createIndex
            tableName="pull_request_review_thread"
            indexName="idx_pull_request_review_thread_resolved_by"
        >
            <column name="resolved_by_id"/>
        </createIndex>

        <sql>
            UPDATE pull_request_review_thread
            SET provider_thread_id = id
            WHERE provider_thread_id IS NULL;
        </sql>

        <sql>
            UPDATE pull_request_review_thread AS t
            SET path = COALESCE(t.path, c.path),
                line = COALESCE(t.line, c.line),
                start_line = COALESCE(t.start_line, c.start_line),
                side = COALESCE(t.side, c.side),
                start_side = COALESCE(t.start_side, c.start_side)
            FROM pull_request_review_comment AS c
            WHERE c.thread_id = t.id
              AND (c.in_reply_to_id IS NULL OR c.id = t.root_comment_id);
        </sql>

        <sql>
            UPDATE pull_request_review_thread
            SET side = UPPER(side),
                start_side = UPPER(start_side)
            WHERE side IS NOT NULL OR start_side IS NOT NULL;
        </sql>
    </changeSet>

    <changeSet id="1762340951591-migrate-large-objects" author="FelixTJDietrich">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(*)
                    FROM information_schema.columns
                    WHERE table_schema = 'public'
                      AND (
                        (table_name = 'issue' AND column_name IN ('body', 'bad_practice_summary') AND data_type = 'oid') OR
                        (table_name = 'issue_comment' AND column_name = 'body' AND data_type = 'oid') OR
                        (table_name = 'pull_request_review' AND column_name = 'body' AND data_type = 'oid') OR
                        (table_name = 'pull_request_review_comment' AND column_name IN ('body', 'diff_hunk') AND data_type = 'oid') OR
                        (table_name = 'milestone' AND column_name = 'description' AND data_type = 'oid') OR
                        (table_name = 'pullrequestbadpractice' AND column_name = 'description' AND data_type = 'oid') OR
                        (table_name = 'bad_practice_feedback' AND column_name = 'explanation' AND data_type = 'oid') OR
                        (table_name = 'bad_practice_detection' AND column_name = 'summary' AND data_type = 'oid')
                      );
                </sqlCheck>
            </not>
        </preConditions>

        <!-- issue.body & issue.bad_practice_summary -->
        <sql>
            ALTER TABLE issue ADD COLUMN body_text TEXT;
        </sql>
        <sql>
            ALTER TABLE issue ADD COLUMN bad_practice_summary_text TEXT;
        </sql>
        <sql>
            UPDATE issue
            SET body_text = CASE
                    WHEN body IS NOT NULL
                        AND EXISTS (SELECT 1 FROM pg_largeobject_metadata lom WHERE lom.oid = body)
                        THEN convert_from(
                            pg_catalog.decode(
                                replace(pg_catalog.encode(pg_catalog.lo_get(body), 'escape'), E'\\000', ''),
                                'escape'
                            ),
                            'UTF8'
                        )
                    ELSE NULL
                END,
                bad_practice_summary_text = CASE
                    WHEN bad_practice_summary IS NOT NULL
                        AND EXISTS (SELECT 1 FROM pg_largeobject_metadata lom WHERE lom.oid = bad_practice_summary)
                        THEN convert_from(
                            pg_catalog.decode(
                                replace(pg_catalog.encode(pg_catalog.lo_get(bad_practice_summary), 'escape'), E'\\000', ''),
                                'escape'
                            ),
                            'UTF8'
                        )
                    ELSE NULL
                END;
        </sql>
        <sql splitStatements="false">
            DO $$
            DECLARE
                mismatch_count integer;
            BEGIN
                SELECT COUNT(*)
                INTO mismatch_count
                FROM issue
                WHERE (body IS NOT NULL AND body_text IS NULL)
                   OR (bad_practice_summary IS NOT NULL AND bad_practice_summary_text IS NULL);

                IF mismatch_count > 0 THEN
                    RAISE EXCEPTION 'Failed to migrate issue large objects: % rows missing', mismatch_count;
                END IF;
            END;
            $$;
        </sql>
        <!-- Clean up migrated large objects without lo_unlink to avoid exhausting large-object locks -->
        <sql>
            CREATE TEMP TABLE tmp_issue_lobs AS
            SELECT DISTINCT oid
            FROM (
                SELECT body AS oid FROM issue WHERE body IS NOT NULL
                UNION ALL
                SELECT bad_practice_summary AS oid FROM issue WHERE bad_practice_summary IS NOT NULL
            ) AS oids;
        </sql>
        <sql>
            DELETE FROM pg_largeobject
            WHERE loid IN (SELECT oid FROM tmp_issue_lobs);
        </sql>
        <sql>
            DELETE FROM pg_largeobject_metadata
            WHERE oid IN (SELECT oid FROM tmp_issue_lobs);
        </sql>
        <sql>
            DROP TABLE tmp_issue_lobs;
        </sql>
        <sql>
            ALTER TABLE issue DROP COLUMN body;
        </sql>
        <sql>
            ALTER TABLE issue DROP COLUMN bad_practice_summary;
        </sql>
        <sql>
            ALTER TABLE issue RENAME COLUMN body_text TO body;
        </sql>
        <sql>
            ALTER TABLE issue RENAME COLUMN bad_practice_summary_text TO bad_practice_summary;
        </sql>

        <!-- issue_comment.body -->
        <sql>
            ALTER TABLE issue_comment ADD COLUMN body_text TEXT;
        </sql>
        <sql>
            UPDATE issue_comment
            SET body_text = CASE
                WHEN body IS NOT NULL AND EXISTS (SELECT 1 FROM pg_largeobject_metadata lom WHERE lom.oid = body)
                    THEN convert_from(
                        pg_catalog.decode(
                            replace(pg_catalog.encode(pg_catalog.lo_get(body), 'escape'), E'\\000', ''),
                            'escape'
                        ),
                        'UTF8'
                    )
                ELSE NULL
            END;
        </sql>
        <sql splitStatements="false">
            DO $$
            DECLARE
                mismatch_count integer;
            BEGIN
                SELECT COUNT(*)
                INTO mismatch_count
                FROM issue_comment
                WHERE body IS NOT NULL AND body_text IS NULL;

                IF mismatch_count > 0 THEN
                    RAISE EXCEPTION 'Failed to migrate issue_comment large objects: % rows missing', mismatch_count;
                END IF;
            END;
            $$;
        </sql>
        <sql>
            CREATE TEMP TABLE tmp_issue_comment_lobs AS
            SELECT DISTINCT body AS oid
            FROM issue_comment
            WHERE body IS NOT NULL;
        </sql>
        <sql>
            DELETE FROM pg_largeobject
            WHERE loid IN (SELECT oid FROM tmp_issue_comment_lobs);
        </sql>
        <sql>
            DELETE FROM pg_largeobject_metadata
            WHERE oid IN (SELECT oid FROM tmp_issue_comment_lobs);
        </sql>
        <sql>
            DROP TABLE tmp_issue_comment_lobs;
        </sql>
        <sql>
            ALTER TABLE issue_comment DROP COLUMN body;
        </sql>
        <sql>
            ALTER TABLE issue_comment RENAME COLUMN body_text TO body;
        </sql>

        <!-- pull_request_review.body -->
        <sql>
            ALTER TABLE pull_request_review ADD COLUMN body_text TEXT;
        </sql>
        <sql>
            UPDATE pull_request_review
            SET body_text = CASE
                WHEN body IS NOT NULL AND EXISTS (SELECT 1 FROM pg_largeobject_metadata lom WHERE lom.oid = body)
                    THEN convert_from(
                        pg_catalog.decode(
                            replace(pg_catalog.encode(pg_catalog.lo_get(body), 'escape'), E'\\000', ''),
                            'escape'
                        ),
                        'UTF8'
                    )
                ELSE NULL
            END;
        </sql>
        <sql splitStatements="false">
            DO $$
            DECLARE
                mismatch_count integer;
            BEGIN
                SELECT COUNT(*)
                INTO mismatch_count
                FROM pull_request_review
                WHERE body IS NOT NULL AND body_text IS NULL;

                IF mismatch_count > 0 THEN
                    RAISE EXCEPTION 'Failed to migrate pull_request_review large objects: % rows missing', mismatch_count;
                END IF;
            END;
            $$;
        </sql>
        <sql>
            CREATE TEMP TABLE tmp_pr_review_lobs AS
            SELECT DISTINCT body AS oid
            FROM pull_request_review
            WHERE body IS NOT NULL;
        </sql>
        <sql>
            DELETE FROM pg_largeobject
            WHERE loid IN (SELECT oid FROM tmp_pr_review_lobs);
        </sql>
        <sql>
            DELETE FROM pg_largeobject_metadata
            WHERE oid IN (SELECT oid FROM tmp_pr_review_lobs);
        </sql>
        <sql>
            DROP TABLE tmp_pr_review_lobs;
        </sql>
        <sql>
            ALTER TABLE pull_request_review DROP COLUMN body;
        </sql>
        <sql>
            ALTER TABLE pull_request_review RENAME COLUMN body_text TO body;
        </sql>

        <!-- pull_request_review_comment.body & diff_hunk -->
        <sql>
            ALTER TABLE pull_request_review_comment
                ADD COLUMN body_text TEXT,
                ADD COLUMN diff_hunk_text TEXT;
        </sql>
        <sql>
            UPDATE pull_request_review_comment
            SET body_text = CASE
                    WHEN body IS NOT NULL AND EXISTS (SELECT 1 FROM pg_largeobject_metadata lom WHERE lom.oid = body)
                        THEN convert_from(
                            pg_catalog.decode(
                                replace(pg_catalog.encode(pg_catalog.lo_get(body), 'escape'), E'\\000', ''),
                                'escape'
                            ),
                            'UTF8'
                        )
                    ELSE NULL
                END,
                diff_hunk_text = CASE
                    WHEN diff_hunk IS NOT NULL
                        AND EXISTS (SELECT 1 FROM pg_largeobject_metadata lom WHERE lom.oid = diff_hunk)
                        THEN convert_from(
                            pg_catalog.decode(
                                replace(pg_catalog.encode(pg_catalog.lo_get(diff_hunk), 'escape'), E'\\000', ''),
                                'escape'
                            ),
                            'UTF8'
                        )
                    ELSE NULL
                END;
        </sql>
        <sql splitStatements="false">
            DO $$
            DECLARE
                mismatch_count integer;
            BEGIN
                SELECT COUNT(*)
                INTO mismatch_count
                FROM pull_request_review_comment
                WHERE (body IS NOT NULL AND body_text IS NULL)
                   OR (diff_hunk IS NOT NULL AND diff_hunk_text IS NULL);

                IF mismatch_count > 0 THEN
                    RAISE EXCEPTION 'Failed to migrate pull_request_review_comment large objects: % rows missing', mismatch_count;
                END IF;
            END;
            $$;
        </sql>
        <sql>
            CREATE TEMP TABLE tmp_pr_comment_lobs AS
            SELECT DISTINCT oid
            FROM (
                SELECT body AS oid FROM pull_request_review_comment WHERE body IS NOT NULL
                UNION ALL
                SELECT diff_hunk AS oid FROM pull_request_review_comment WHERE diff_hunk IS NOT NULL
            ) AS oids;
        </sql>
        <sql>
            DELETE FROM pg_largeobject
            WHERE loid IN (SELECT oid FROM tmp_pr_comment_lobs);
        </sql>
        <sql>
            DELETE FROM pg_largeobject_metadata
            WHERE oid IN (SELECT oid FROM tmp_pr_comment_lobs);
        </sql>
        <sql>
            DROP TABLE tmp_pr_comment_lobs;
        </sql>
        <sql>
            ALTER TABLE pull_request_review_comment DROP COLUMN body;
        </sql>
        <sql>
            ALTER TABLE pull_request_review_comment DROP COLUMN diff_hunk;
        </sql>
        <sql>
            ALTER TABLE pull_request_review_comment RENAME COLUMN body_text TO body;
        </sql>
        <sql>
            ALTER TABLE pull_request_review_comment RENAME COLUMN diff_hunk_text TO diff_hunk;
        </sql>

        <!-- milestone.description -->
        <sql>
            ALTER TABLE milestone ADD COLUMN description_text TEXT;
        </sql>
        <sql>
            UPDATE milestone
            SET description_text = CASE
                WHEN description IS NOT NULL AND EXISTS (SELECT 1 FROM pg_largeobject_metadata lom WHERE lom.oid = description)
                    THEN convert_from(
                        pg_catalog.decode(
                            replace(pg_catalog.encode(pg_catalog.lo_get(description), 'escape'), E'\\000', ''),
                            'escape'
                        ),
                        'UTF8'
                    )
                ELSE NULL
            END;
        </sql>
        <sql splitStatements="false">
            DO $$
            DECLARE
                mismatch_count integer;
            BEGIN
                SELECT COUNT(*)
                INTO mismatch_count
                FROM milestone
                WHERE description IS NOT NULL AND description_text IS NULL;

                IF mismatch_count > 0 THEN
                    RAISE EXCEPTION 'Failed to migrate milestone descriptions: % rows missing', mismatch_count;
                END IF;
            END;
            $$;
        </sql>
        <sql>
            CREATE TEMP TABLE tmp_milestone_lobs AS
            SELECT DISTINCT description AS oid
            FROM milestone
            WHERE description IS NOT NULL;
        </sql>
        <sql>
            DELETE FROM pg_largeobject
            WHERE loid IN (SELECT oid FROM tmp_milestone_lobs);
        </sql>
        <sql>
            DELETE FROM pg_largeobject_metadata
            WHERE oid IN (SELECT oid FROM tmp_milestone_lobs);
        </sql>
        <sql>
            DROP TABLE tmp_milestone_lobs;
        </sql>
        <sql>
            ALTER TABLE milestone DROP COLUMN description;
        </sql>
        <sql>
            ALTER TABLE milestone RENAME COLUMN description_text TO description;
        </sql>

        <!-- pullrequestbadpractice.description -->
        <sql>
            ALTER TABLE pullrequestbadpractice ADD COLUMN description_text TEXT;
        </sql>
        <sql>
            UPDATE pullrequestbadpractice
            SET description_text = CASE
                WHEN description IS NOT NULL AND EXISTS (SELECT 1 FROM pg_largeobject_metadata lom WHERE lom.oid = description)
                    THEN convert_from(
                        pg_catalog.decode(
                            replace(pg_catalog.encode(pg_catalog.lo_get(description), 'escape'), E'\\000', ''),
                            'escape'
                        ),
                        'UTF8'
                    )
                ELSE NULL
            END;
        </sql>
        <sql splitStatements="false">
            DO $$
            DECLARE
                mismatch_count integer;
            BEGIN
                SELECT COUNT(*)
                INTO mismatch_count
                FROM pullrequestbadpractice
                WHERE description IS NOT NULL AND description_text IS NULL;

                IF mismatch_count > 0 THEN
                    RAISE EXCEPTION 'Failed to migrate pullrequestbadpractice descriptions: % rows missing', mismatch_count;
                END IF;
            END;
            $$;
        </sql>
        <sql>
            CREATE TEMP TABLE tmp_pr_bad_practice_lobs AS
            SELECT DISTINCT description AS oid
            FROM pullrequestbadpractice
            WHERE description IS NOT NULL;
        </sql>
        <sql>
            DELETE FROM pg_largeobject
            WHERE loid IN (SELECT oid FROM tmp_pr_bad_practice_lobs);
        </sql>
        <sql>
            DELETE FROM pg_largeobject_metadata
            WHERE oid IN (SELECT oid FROM tmp_pr_bad_practice_lobs);
        </sql>
        <sql>
            DROP TABLE tmp_pr_bad_practice_lobs;
        </sql>
        <sql>
            ALTER TABLE pullrequestbadpractice DROP COLUMN description;
        </sql>
        <sql>
            ALTER TABLE pullrequestbadpractice RENAME COLUMN description_text TO description;
        </sql>

        <!-- bad_practice_feedback.explanation -->
        <sql>
            ALTER TABLE bad_practice_feedback ADD COLUMN explanation_text TEXT;
        </sql>
        <sql>
            UPDATE bad_practice_feedback
            SET explanation_text = CASE
                WHEN explanation IS NOT NULL
                    AND EXISTS (SELECT 1 FROM pg_largeobject_metadata lom WHERE lom.oid = explanation)
                    THEN convert_from(
                        pg_catalog.decode(
                            replace(pg_catalog.encode(pg_catalog.lo_get(explanation), 'escape'), E'\\000', ''),
                            'escape'
                        ),
                        'UTF8'
                    )
                ELSE NULL
            END;
        </sql>
        <sql splitStatements="false">
            DO $$
            DECLARE
                mismatch_count integer;
            BEGIN
                SELECT COUNT(*)
                INTO mismatch_count
                FROM bad_practice_feedback
                WHERE explanation IS NOT NULL AND explanation_text IS NULL;

                IF mismatch_count > 0 THEN
                    RAISE EXCEPTION 'Failed to migrate bad_practice_feedback explanations: % rows missing', mismatch_count;
                END IF;
            END;
            $$;
        </sql>
        <sql>
            CREATE TEMP TABLE tmp_bad_practice_feedback_lobs AS
            SELECT DISTINCT explanation AS oid
            FROM bad_practice_feedback
            WHERE explanation IS NOT NULL;
        </sql>
        <sql>
            DELETE FROM pg_largeobject
            WHERE loid IN (SELECT oid FROM tmp_bad_practice_feedback_lobs);
        </sql>
        <sql>
            DELETE FROM pg_largeobject_metadata
            WHERE oid IN (SELECT oid FROM tmp_bad_practice_feedback_lobs);
        </sql>
        <sql>
            DROP TABLE tmp_bad_practice_feedback_lobs;
        </sql>
        <sql>
            ALTER TABLE bad_practice_feedback DROP COLUMN explanation;
        </sql>
        <sql>
            ALTER TABLE bad_practice_feedback RENAME COLUMN explanation_text TO explanation;
        </sql>

        <!-- bad_practice_detection.summary -->
        <sql>
            ALTER TABLE bad_practice_detection ADD COLUMN summary_text TEXT;
        </sql>
        <sql>
            UPDATE bad_practice_detection
            SET summary_text = CASE
                WHEN summary IS NOT NULL AND EXISTS (SELECT 1 FROM pg_largeobject_metadata lom WHERE lom.oid = summary)
                    THEN convert_from(
                        pg_catalog.decode(
                            replace(pg_catalog.encode(pg_catalog.lo_get(summary), 'escape'), E'\\000', ''),
                            'escape'
                        ),
                        'UTF8'
                    )
                ELSE NULL
            END;
        </sql>
        <sql splitStatements="false">
            DO $$
            DECLARE
                mismatch_count integer;
            BEGIN
                SELECT COUNT(*)
                INTO mismatch_count
                FROM bad_practice_detection
                WHERE summary IS NOT NULL AND summary_text IS NULL;

                IF mismatch_count > 0 THEN
                    RAISE EXCEPTION 'Failed to migrate bad_practice_detection summaries: % rows missing', mismatch_count;
                END IF;
            END;
            $$;
        </sql>
        <sql>
            CREATE TEMP TABLE tmp_bad_practice_detection_lobs AS
            SELECT DISTINCT summary AS oid
            FROM bad_practice_detection
            WHERE summary IS NOT NULL;
        </sql>
        <sql>
            DELETE FROM pg_largeobject
            WHERE loid IN (SELECT oid FROM tmp_bad_practice_detection_lobs);
        </sql>
        <sql>
            DELETE FROM pg_largeobject_metadata
            WHERE oid IN (SELECT oid FROM tmp_bad_practice_detection_lobs);
        </sql>
        <sql>
            DROP TABLE tmp_bad_practice_detection_lobs;
        </sql>
        <sql>
            ALTER TABLE bad_practice_detection DROP COLUMN summary;
        </sql>
        <sql>
            ALTER TABLE bad_practice_detection RENAME COLUMN summary_text TO summary;
        </sql>
    </changeSet>
</databaseChangeLog>
