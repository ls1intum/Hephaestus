<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
    Activity Event Performance Indexes

    CRITICAL: These indexes are essential for leaderboard query performance.
    Without them, aggregation queries perform full table scans which becomes
    extremely slow as the activity_event table grows.

    Index strategy:
    1. workspace_id + occurred_at DESC - Leaderboard aggregations with time range
    2. actor_id + occurred_at DESC - User activity feed (mentor context)
    3. workspace_id + actor_id + occurred_at DESC - Combined workspace + user queries
    4. correlation_id - Email attribution chain lookups
    -->

    <!-- Changeset 1: Workspace + occurred_at index for leaderboard queries -->
    <changeSet id="1767500000000-1-idx-workspace-occurred" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="activity_event"/>
            <not>
                <indexExists indexName="idx_activity_event_workspace_occurred"/>
            </not>
        </preConditions>
        <createIndex tableName="activity_event" indexName="idx_activity_event_workspace_occurred">
            <column name="workspace_id"/>
            <column name="occurred_at" descending="true"/>
        </createIndex>
        <rollback>
            <dropIndex tableName="activity_event" indexName="idx_activity_event_workspace_occurred"/>
        </rollback>
        <comment>Composite index for leaderboard aggregation queries filtering by workspace and time range</comment>
    </changeSet>

    <!-- Changeset 2: Actor + occurred_at index for user activity queries -->
    <changeSet id="1767500000000-2-idx-actor-occurred" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="activity_event"/>
            <not>
                <indexExists indexName="idx_activity_event_actor_occurred"/>
            </not>
        </preConditions>
        <createIndex tableName="activity_event" indexName="idx_activity_event_actor_occurred">
            <column name="actor_id"/>
            <column name="occurred_at" descending="true"/>
        </createIndex>
        <rollback>
            <dropIndex tableName="activity_event" indexName="idx_activity_event_actor_occurred"/>
        </rollback>
        <comment>Composite index for mentor context queries - user activity feed with time ordering</comment>
    </changeSet>

    <!-- Changeset 3: Workspace + actor + occurred_at index for combined queries -->
    <changeSet id="1767500000000-3-idx-workspace-actor-occurred" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="activity_event"/>
            <not>
                <indexExists indexName="idx_activity_event_workspace_actor_occurred"/>
            </not>
        </preConditions>
        <createIndex tableName="activity_event" indexName="idx_activity_event_workspace_actor_occurred">
            <column name="workspace_id"/>
            <column name="actor_id"/>
            <column name="occurred_at" descending="true"/>
        </createIndex>
        <rollback>
            <dropIndex tableName="activity_event" indexName="idx_activity_event_workspace_actor_occurred"/>
        </rollback>
        <comment>Composite index for activity breakdown queries filtering by workspace and specific actors</comment>
    </changeSet>

    <!-- Changeset 4: Correlation ID index for attribution queries -->
    <changeSet id="1767500000000-4-idx-correlation" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="activity_event"/>
            <not>
                <indexExists indexName="idx_activity_event_correlation"/>
            </not>
        </preConditions>
        <createIndex tableName="activity_event" indexName="idx_activity_event_correlation">
            <column name="correlation_id"/>
        </createIndex>
        <rollback>
            <dropIndex tableName="activity_event" indexName="idx_activity_event_correlation"/>
        </rollback>
        <comment>Index for email attribution - finding event chains by correlation ID</comment>
    </changeSet>

</databaseChangeLog>
