<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
    =======================================================================================
    Multi-Provider Support with Synthetic PKs (Issue #715)
    =======================================================================================

    Introduces the git_provider table and converts all BaseGitServiceEntity tables from
    manual provider-native IDs to auto-generated synthetic PKs. This enables multiple
    provider instances (GitHub, GitLab, GitHub Enterprise, self-hosted GitLab) to coexist
    in the same database without ID collisions.

    Key changes:
      1. New git_provider table (type + server_url, seeded with GitHub + GitLab defaults)
      2. native_id column on all entity tables (stores the provider's original numeric ID)
      3. provider_id FK column on all entity tables (references git_provider)
      4. id columns converted to GENERATED BY DEFAULT AS IDENTITY (auto-generated PKs)
      5. Unique constraints updated to be provider-scoped

    Existing data is backfilled as GITHUB provider. No data is lost.

    Tables modified (14 BaseGitServiceEntity tables):
      user, repository, organization, issue (includes pull_request via SINGLE_TABLE),
      milestone, issue_comment, pull_request_review_comment, pull_request_review_thread,
      discussion, discussion_comment, team, project, project_item, project_status_update
    =======================================================================================
    -->

    <!-- ==================== Phase 1: Create git_provider table ==================== -->

    <changeSet author="issue-715" id="1772284124265-1">
        <createTable tableName="git_provider">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_git_provider" nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="server_url" type="VARCHAR(512)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint tableName="git_provider"
                             columnNames="type, server_url"
                             constraintName="uq_git_provider_type_server_url"/>
    </changeSet>

    <!-- ==================== Phase 2: Seed default providers ==================== -->

    <changeSet author="issue-715" id="1772284124265-2">
        <sql>
            INSERT INTO git_provider (type, server_url) VALUES ('GITHUB', 'https://github.com');
            INSERT INTO git_provider (type, server_url) VALUES ('GITLAB', 'https://gitlab.com');
        </sql>
    </changeSet>

    <!-- ==================== Phase 3: Organization — rename github_id → native_id ==================== -->

    <changeSet author="issue-715" id="1772284124265-3">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="organization" columnName="github_id"/>
        </preConditions>
        <!-- Drop the old unique constraint on github_id before renaming -->
        <sql>ALTER TABLE organization DROP CONSTRAINT IF EXISTS uq_organization_github_id;</sql>
        <renameColumn tableName="organization" oldColumnName="github_id" newColumnName="native_id"
                      columnDataType="BIGINT"/>
    </changeSet>

    <!-- ==================== Phase 4: Add native_id column to all other tables ==================== -->
    <!-- For these tables, id WAS the provider-native ID. Copy id → native_id. -->

    <changeSet author="issue-715" id="1772284124265-4">
        <sql>
            -- Add native_id to all tables except organization (already handled above)
            ALTER TABLE "user" ADD COLUMN IF NOT EXISTS native_id BIGINT;
            ALTER TABLE repository ADD COLUMN IF NOT EXISTS native_id BIGINT;
            ALTER TABLE issue ADD COLUMN IF NOT EXISTS native_id BIGINT;
            ALTER TABLE milestone ADD COLUMN IF NOT EXISTS native_id BIGINT;
            ALTER TABLE issue_comment ADD COLUMN IF NOT EXISTS native_id BIGINT;
            ALTER TABLE pull_request_review_comment ADD COLUMN IF NOT EXISTS native_id BIGINT;
            ALTER TABLE pull_request_review_thread ADD COLUMN IF NOT EXISTS native_id BIGINT;
            ALTER TABLE discussion ADD COLUMN IF NOT EXISTS native_id BIGINT;
            ALTER TABLE discussion_comment ADD COLUMN IF NOT EXISTS native_id BIGINT;
            ALTER TABLE team ADD COLUMN IF NOT EXISTS native_id BIGINT;
            ALTER TABLE project ADD COLUMN IF NOT EXISTS native_id BIGINT;
            ALTER TABLE project_item ADD COLUMN IF NOT EXISTS native_id BIGINT;
            ALTER TABLE project_status_update ADD COLUMN IF NOT EXISTS native_id BIGINT;

            -- Backfill: copy current id to native_id (all existing data is GitHub)
            UPDATE "user" SET native_id = id WHERE native_id IS NULL;
            UPDATE repository SET native_id = id WHERE native_id IS NULL;
            UPDATE issue SET native_id = id WHERE native_id IS NULL;
            UPDATE milestone SET native_id = id WHERE native_id IS NULL;
            UPDATE issue_comment SET native_id = id WHERE native_id IS NULL;
            UPDATE pull_request_review_comment SET native_id = id WHERE native_id IS NULL;
            UPDATE pull_request_review_thread SET native_id = id WHERE native_id IS NULL;
            UPDATE discussion SET native_id = id WHERE native_id IS NULL;
            UPDATE discussion_comment SET native_id = id WHERE native_id IS NULL;
            UPDATE team SET native_id = id WHERE native_id IS NULL;
            UPDATE project SET native_id = id WHERE native_id IS NULL;
            UPDATE project_item SET native_id = id WHERE native_id IS NULL;
            UPDATE project_status_update SET native_id = id WHERE native_id IS NULL;

            -- Set NOT NULL on native_id for all tables (including organization)
            ALTER TABLE "user" ALTER COLUMN native_id SET NOT NULL;
            ALTER TABLE repository ALTER COLUMN native_id SET NOT NULL;
            ALTER TABLE organization ALTER COLUMN native_id SET NOT NULL;
            ALTER TABLE issue ALTER COLUMN native_id SET NOT NULL;
            ALTER TABLE milestone ALTER COLUMN native_id SET NOT NULL;
            ALTER TABLE issue_comment ALTER COLUMN native_id SET NOT NULL;
            ALTER TABLE pull_request_review_comment ALTER COLUMN native_id SET NOT NULL;
            ALTER TABLE pull_request_review_thread ALTER COLUMN native_id SET NOT NULL;
            ALTER TABLE discussion ALTER COLUMN native_id SET NOT NULL;
            ALTER TABLE discussion_comment ALTER COLUMN native_id SET NOT NULL;
            ALTER TABLE team ALTER COLUMN native_id SET NOT NULL;
            ALTER TABLE project ALTER COLUMN native_id SET NOT NULL;
            ALTER TABLE project_item ALTER COLUMN native_id SET NOT NULL;
            ALTER TABLE project_status_update ALTER COLUMN native_id SET NOT NULL;
        </sql>
    </changeSet>

    <!-- ==================== Phase 5: Add provider_id FK column to all tables ==================== -->

    <changeSet author="issue-715" id="1772284124265-5">
        <sql>
            -- Add provider_id column to all 14 tables
            ALTER TABLE "user" ADD COLUMN IF NOT EXISTS provider_id BIGINT;
            ALTER TABLE repository ADD COLUMN IF NOT EXISTS provider_id BIGINT;
            ALTER TABLE organization ADD COLUMN IF NOT EXISTS provider_id BIGINT;
            ALTER TABLE issue ADD COLUMN IF NOT EXISTS provider_id BIGINT;
            ALTER TABLE milestone ADD COLUMN IF NOT EXISTS provider_id BIGINT;
            ALTER TABLE issue_comment ADD COLUMN IF NOT EXISTS provider_id BIGINT;
            ALTER TABLE pull_request_review_comment ADD COLUMN IF NOT EXISTS provider_id BIGINT;
            ALTER TABLE pull_request_review_thread ADD COLUMN IF NOT EXISTS provider_id BIGINT;
            ALTER TABLE discussion ADD COLUMN IF NOT EXISTS provider_id BIGINT;
            ALTER TABLE discussion_comment ADD COLUMN IF NOT EXISTS provider_id BIGINT;
            ALTER TABLE team ADD COLUMN IF NOT EXISTS provider_id BIGINT;
            ALTER TABLE project ADD COLUMN IF NOT EXISTS provider_id BIGINT;
            ALTER TABLE project_item ADD COLUMN IF NOT EXISTS provider_id BIGINT;
            ALTER TABLE project_status_update ADD COLUMN IF NOT EXISTS provider_id BIGINT;

            -- Backfill: all existing data is GitHub
            UPDATE "user" SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;
            UPDATE repository SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;
            UPDATE organization SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;
            UPDATE issue SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;
            UPDATE milestone SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;
            UPDATE issue_comment SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;
            UPDATE pull_request_review_comment SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;
            UPDATE pull_request_review_thread SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;
            UPDATE discussion SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;
            UPDATE discussion_comment SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;
            UPDATE team SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;
            UPDATE project SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;
            UPDATE project_item SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;
            UPDATE project_status_update SET provider_id = (SELECT id FROM git_provider WHERE type = 'GITHUB' AND server_url = 'https://github.com') WHERE provider_id IS NULL;

            -- Set NOT NULL
            ALTER TABLE "user" ALTER COLUMN provider_id SET NOT NULL;
            ALTER TABLE repository ALTER COLUMN provider_id SET NOT NULL;
            ALTER TABLE organization ALTER COLUMN provider_id SET NOT NULL;
            ALTER TABLE issue ALTER COLUMN provider_id SET NOT NULL;
            ALTER TABLE milestone ALTER COLUMN provider_id SET NOT NULL;
            ALTER TABLE issue_comment ALTER COLUMN provider_id SET NOT NULL;
            ALTER TABLE pull_request_review_comment ALTER COLUMN provider_id SET NOT NULL;
            ALTER TABLE pull_request_review_thread ALTER COLUMN provider_id SET NOT NULL;
            ALTER TABLE discussion ALTER COLUMN provider_id SET NOT NULL;
            ALTER TABLE discussion_comment ALTER COLUMN provider_id SET NOT NULL;
            ALTER TABLE team ALTER COLUMN provider_id SET NOT NULL;
            ALTER TABLE project ALTER COLUMN provider_id SET NOT NULL;
            ALTER TABLE project_item ALTER COLUMN provider_id SET NOT NULL;
            ALTER TABLE project_status_update ALTER COLUMN provider_id SET NOT NULL;
        </sql>
    </changeSet>

    <!-- ==================== Phase 6: Add FK constraints for provider_id ==================== -->

    <changeSet author="issue-715" id="1772284124265-6">
        <addForeignKeyConstraint baseTableName="user" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_user_provider"/>
        <addForeignKeyConstraint baseTableName="repository" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_repository_provider"/>
        <addForeignKeyConstraint baseTableName="organization" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_organization_provider"/>
        <addForeignKeyConstraint baseTableName="issue" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_issue_provider"/>
        <addForeignKeyConstraint baseTableName="milestone" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_milestone_provider"/>
        <addForeignKeyConstraint baseTableName="issue_comment" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_issue_comment_provider"/>
        <addForeignKeyConstraint baseTableName="pull_request_review_comment" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_pr_review_comment_provider"/>
        <addForeignKeyConstraint baseTableName="pull_request_review_thread" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_pr_review_thread_provider"/>
        <addForeignKeyConstraint baseTableName="discussion" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_discussion_provider"/>
        <addForeignKeyConstraint baseTableName="discussion_comment" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_discussion_comment_provider"/>
        <addForeignKeyConstraint baseTableName="team" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_team_provider"/>
        <addForeignKeyConstraint baseTableName="project" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_project_provider"/>
        <addForeignKeyConstraint baseTableName="project_item" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_project_item_provider"/>
        <addForeignKeyConstraint baseTableName="project_status_update" baseColumnNames="provider_id"
                                 referencedTableName="git_provider" referencedColumnNames="id"
                                 constraintName="fk_project_status_update_provider"/>
    </changeSet>

    <!-- ==================== Phase 7: Convert id columns to IDENTITY ==================== -->
    <!-- All BaseGitServiceEntity tables previously used manually-assigned IDs.
         Now that we have synthetic auto-generated PKs, we need IDENTITY generation. -->

    <changeSet author="issue-715" id="1772284124265-7">
        <sql splitStatements="false">
            DO $$
            DECLARE
                tbl TEXT;
                maxid BIGINT;
            BEGIN
                -- All 14 BaseGitServiceEntity tables need IDENTITY conversion
                FOR tbl IN SELECT unnest(ARRAY[
                    '"user"', 'repository', 'organization', 'issue', 'milestone',
                    'issue_comment', 'pull_request_review_comment', 'pull_request_review_thread',
                    'discussion', 'discussion_comment', 'team', 'project', 'project_item',
                    'project_status_update'
                ])
                LOOP
                    -- Only add IDENTITY if column doesn't already have it
                    IF EXISTS (
                        SELECT 1 FROM pg_attribute a
                        JOIN pg_class c ON a.attrelid = c.oid
                        JOIN pg_namespace n ON c.relnamespace = n.oid
                        WHERE c.relname = REPLACE(tbl, '"', '')
                          AND a.attname = 'id'
                          AND a.attidentity = ''
                          AND n.nspname = 'public'
                    ) THEN
                        EXECUTE format('ALTER TABLE %s ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY', tbl);
                    END IF;

                    -- Restart the identity sequence past the max existing id
                    EXECUTE format('SELECT COALESCE(MAX(id), 0) + 1 FROM %s', tbl) INTO maxid;
                    EXECUTE format('ALTER TABLE %s ALTER COLUMN id RESTART WITH %s', tbl, maxid);
                END LOOP;
            END $$;
        </sql>
    </changeSet>

    <!-- ==================== Phase 8: Update unique constraints ==================== -->

    <!-- User: uk_user_login_lower → uk_user_provider_login (provider_id, LOWER(login))
              + add (provider_id, native_id) for upsert ON CONFLICT -->
    <changeSet author="issue-715" id="1772284124265-8">
        <sql>DROP INDEX IF EXISTS uk_user_login_lower;</sql>
    </changeSet>
    <changeSet author="issue-715" id="1772284124265-9">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="uk_user_provider_login"/></not>
        </preConditions>
        <sql>
            CREATE UNIQUE INDEX uk_user_provider_login ON "user" (provider_id, LOWER(login));
        </sql>
        <rollback>
            <dropIndex tableName="user" indexName="uk_user_provider_login"/>
        </rollback>
    </changeSet>
    <changeSet author="issue-715" id="1772284124265-9a">
        <addUniqueConstraint tableName="user" columnNames="provider_id, native_id"
                             constraintName="uq_user_provider_native_id"/>
    </changeSet>

    <!-- Organization: add provider-scoped unique constraints -->
    <changeSet author="issue-715" id="1772284124265-10">
        <sql>ALTER TABLE organization DROP CONSTRAINT IF EXISTS uq_organization_login;</sql>
        <addUniqueConstraint tableName="organization" columnNames="provider_id, native_id"
                             constraintName="uq_organization_provider_native_id"/>
        <addUniqueConstraint tableName="organization" columnNames="provider_id, login"
                             constraintName="uq_organization_provider_login"/>
    </changeSet>

    <!-- Repository: uq_repository_name_with_owner → uq_repository_provider_name_with_owner -->
    <changeSet author="issue-715" id="1772284124265-11">
        <sql>ALTER TABLE repository DROP CONSTRAINT IF EXISTS uq_repository_name_with_owner;</sql>
        <addUniqueConstraint tableName="repository" columnNames="provider_id, name_with_owner"
                             constraintName="uq_repository_provider_name_with_owner"/>
    </changeSet>

</databaseChangeLog>
