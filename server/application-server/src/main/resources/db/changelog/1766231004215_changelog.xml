<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- 
        Sub-Issues and Issue Types Migration
        
        This migration adds support for:
        1. GitHub's sub-issue hierarchy (parent-child relationships between issues)
        2. GitHub's organization-level issue types (categorization like Bug, Feature, etc.)
        3. Sub-issue summary denormalization for efficient querying
    -->

    <!-- Create issue_type table for GitHub organization-level issue types -->
    <changeSet id="1766231004215_create_issue_type_table" author="FelixTJDietrich">
        <comment>Add issue_type table for GitHub organization-level issue type categorization</comment>

        <createTable tableName="issue_type">
            <!-- Uses GitHub's node_id as primary key (max observed: 69 chars, using 128 for headroom) -->
            <column name="id" type="varchar(128)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="text">
                <constraints nullable="true"/>
            </column>
            <column name="color" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="is_enabled" type="boolean" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="organization_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
            baseTableName="issue_type"
            baseColumnNames="organization_id"
            referencedTableName="organization"
            referencedColumnNames="id"
            constraintName="fk_issue_type_organization"
            onDelete="CASCADE"/>

        <!-- Index for efficient lookup by organization -->
        <createIndex tableName="issue_type" indexName="idx_issue_type_organization_id">
            <column name="organization_id"/>
        </createIndex>
    </changeSet>

    <!-- Add sub-issue hierarchy support to issue table -->
    <changeSet id="1766231004215_add_sub_issue_hierarchy" author="FelixTJDietrich">
        <comment>Add parent_issue_id column to issue table for GitHub sub-issue hierarchy</comment>
        
        <addColumn tableName="issue">
            <column name="parent_issue_id" type="bigint">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <addForeignKeyConstraint 
            baseTableName="issue" 
            baseColumnNames="parent_issue_id"
            referencedTableName="issue" 
            referencedColumnNames="id"
            constraintName="fk_issue_parent_issue"
            onDelete="SET NULL"/>

        <!-- Index for efficient querying of sub-issues by parent -->
        <createIndex tableName="issue" indexName="idx_issue_parent_issue_id">
            <column name="parent_issue_id"/>
        </createIndex>
    </changeSet>

    <!-- Add sub-issue summary fields for denormalized counts -->
    <changeSet id="1766231004215_add_sub_issue_summary" author="FelixTJDietrich">
        <comment>Add sub_issues_summary denormalized fields from GitHub webhooks</comment>

        <addColumn tableName="issue">
            <column name="sub_issues_total" type="integer">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <addColumn tableName="issue">
            <column name="sub_issues_completed" type="integer">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <addColumn tableName="issue">
            <column name="sub_issues_percent_completed" type="integer">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- Add issue_type_id to issue table -->
    <changeSet id="1766231004215_add_issue_type_to_issue" author="FelixTJDietrich">
        <comment>Add issue_type_id foreign key to issue table</comment>

        <addColumn tableName="issue">
            <column name="issue_type_id" type="varchar(128)">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <addForeignKeyConstraint
            baseTableName="issue"
            baseColumnNames="issue_type_id"
            referencedTableName="issue_type"
            referencedColumnNames="id"
            constraintName="fk_issue_issue_type"
            onDelete="SET NULL"/>

        <createIndex tableName="issue" indexName="idx_issue_issue_type_id">
            <column name="issue_type_id"/>
        </createIndex>
    </changeSet>

    <!-- Add sync timestamp columns to workspace for cooldown tracking -->
    <changeSet id="1766231004215_add_workspace_sync_timestamps" author="FelixTJDietrich">
        <comment>Add sync timestamp columns for sub-issues and issue types to workspace</comment>

        <addColumn tableName="workspace">
            <column name="sub_issues_synced_at" type="timestamp">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <addColumn tableName="workspace">
            <column name="issue_types_synced_at" type="timestamp">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <addColumn tableName="workspace">
            <column name="issue_dependencies_synced_at" type="timestamp">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- Fix undersized node_id column: 64 chars was too short for GitHub commit IDs (observed 69+) -->
    <changeSet id="1766231004215_fix_nodeid_column_length" author="FelixTJDietrich">
        <comment>Increase pull_request_review_thread.node_id from VARCHAR(64) to VARCHAR(128) for longer GitHub IDs</comment>

        <modifyDataType tableName="pull_request_review_thread"
            columnName="node_id"
            newDataType="varchar(128)"/>
    </changeSet>

    <!-- Create issue_blocking join table for blocked_by/blocking relationships -->
    <changeSet id="1766231004215_create_issue_blocking_table" author="FelixTJDietrich">
        <comment>Add issue_blocking join table for tracking issue dependency relationships</comment>

        <createTable tableName="issue_blocking">
            <!-- Issue that is blocked (needs the blocking issue to be resolved first) -->
            <column name="blocked_issue_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <!-- Issue that is doing the blocking (prevents the blocked issue) -->
            <column name="blocking_issue_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="issue_blocking"
            columnNames="blocked_issue_id, blocking_issue_id"
            constraintName="pk_issue_blocking"/>

        <addForeignKeyConstraint
            baseTableName="issue_blocking"
            baseColumnNames="blocked_issue_id"
            referencedTableName="issue"
            referencedColumnNames="id"
            constraintName="fk_issue_blocking_blocked"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableName="issue_blocking"
            baseColumnNames="blocking_issue_id"
            referencedTableName="issue"
            referencedColumnNames="id"
            constraintName="fk_issue_blocking_blocking"
            onDelete="CASCADE"/>

        <createIndex tableName="issue_blocking" indexName="idx_issue_blocking_blocked_id">
            <column name="blocked_issue_id"/>
        </createIndex>

        <createIndex tableName="issue_blocking" indexName="idx_issue_blocking_blocking_id">
            <column name="blocking_issue_id"/>
        </createIndex>
    </changeSet>

    <!-- 
        Remove entity contamination from gitprovider module.
        
        These columns stored data that properly belongs in other modules:
        - badPracticeSummary, lastDetectionTime -> activity module (BadPracticeDetection entity)
        - leaguePoints -> workspace module (WorkspaceMembership entity, already exists there)
        
        See: DOMAIN_EVENT_ARCHITECTURE.md for full rationale.
    -->

    <changeSet id="1766231004215-drop-bad-practice-summary" author="FelixTJDietrich">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="pullrequest" columnName="bad_practice_summary"/>
        </preConditions>
        <comment>Drop bad_practice_summary column - data exists in bad_practice_detection.summary</comment>
        <dropColumn tableName="pullrequest" columnName="bad_practice_summary"/>
    </changeSet>

    <changeSet id="1766231004215-drop-last-detection-time" author="FelixTJDietrich">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="pullrequest" columnName="last_detection_time"/>
        </preConditions>
        <comment>Drop last_detection_time column - data exists in bad_practice_detection.detection_time</comment>
        <dropColumn tableName="pullrequest" columnName="last_detection_time"/>
    </changeSet>

    <changeSet id="1766231004215-drop-league-points" author="FelixTJDietrich">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="hephaestus_user" columnName="league_points"/>
        </preConditions>
        <comment>Drop league_points column from user table - migrated to workspace_membership</comment>
        <dropColumn tableName="hephaestus_user" columnName="league_points"/>
    </changeSet>

    <!-- 
        Drop deprecated position columns from pull_request_review_comment table.
        These fields were deprecated by GitHub in favor of line/originalLine fields.
        See: https://docs.github.com/en/graphql/reference/objects#pullrequestreviewcomment
    -->
    <changeSet id="1766231004215-drop-deprecated-positions" author="FelixTJDietrich">
        <dropColumn tableName="pull_request_review_comment" columnName="position"/>
        <dropColumn tableName="pull_request_review_comment" columnName="original_position"/>
    </changeSet>

    <!-- Add missing indexes on foreign key columns for query performance -->
    <changeSet id="1766231004215-add-missing-indexes" author="FelixTJDietrich">
        <comment>Add missing indexes on foreign key columns for query performance</comment>
        
        <!-- Issue table indexes -->
        <createIndex tableName="issue" indexName="idx_issue_repository_id">
            <column name="repository_id"/>
        </createIndex>
        <createIndex tableName="issue" indexName="idx_issue_author_id">
            <column name="author_id"/>
        </createIndex>
        <createIndex tableName="issue" indexName="idx_issue_state">
            <column name="state"/>
        </createIndex>
        
        <!-- Pull request review indexes -->
        <createIndex tableName="pull_request_review" indexName="idx_pr_review_author_id">
            <column name="author_id"/>
        </createIndex>
        <createIndex tableName="pull_request_review" indexName="idx_pr_review_submitted_at">
            <column name="submitted_at"/>
        </createIndex>
        <createIndex tableName="pull_request_review" indexName="idx_pr_review_pull_request_id">
            <column name="pull_request_id"/>
        </createIndex>
        
        <!-- Issue comment indexes -->
        <createIndex tableName="issue_comment" indexName="idx_issue_comment_author_id">
            <column name="author_id"/>
        </createIndex>
        <createIndex tableName="issue_comment" indexName="idx_issue_comment_created_at">
            <column name="created_at"/>
        </createIndex>
        
        <!-- Repository indexes -->
        <createIndex tableName="repository" indexName="idx_repository_name_with_owner">
            <column name="name_with_owner"/>
        </createIndex>
        <createIndex tableName="repository" indexName="idx_repository_organization_id">
            <column name="organization_id"/>
        </createIndex>
        
        <!-- Workspace membership index -->
        <createIndex tableName="workspace_membership" indexName="idx_workspace_membership_user_id">
            <column name="user_id"/>
        </createIndex>
        
        <!-- Chat message index -->
        <createIndex tableName="chat_message" indexName="idx_chat_message_thread_id">
            <column name="thread_id"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
