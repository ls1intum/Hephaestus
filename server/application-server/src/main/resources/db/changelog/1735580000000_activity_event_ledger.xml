<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
    MINIMAL Activity Event Ledger - The Stripe/Square Approach
    
    One table. 11 columns. 4 indexes. That's it.
    
    Supports:
    - Leaderboard: COUNT(*) GROUP BY actor_id, event_type
    - Mentor context: WHERE actor_id = ? ORDER BY occurred_at DESC
    - Email attribution: WHERE correlation_id = ? for notification→click chains
    - DX Core 4 metrics: Speed, Effectiveness, Quality, Impact
    -->

    <changeSet id="1735580000000-drop-contribution-event" author="hephaestus">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="contribution_event"/>
        </preConditions>
        <dropTable tableName="contribution_event"/>
    </changeSet>

    <changeSet id="1735580000000-create-activity-event" author="hephaestus">
        <createTable tableName="activity_event">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <!-- Idempotency: {type}:{target_id}:{timestamp_ms} -->
            <column name="event_key" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <!-- What happened -->
            <column name="event_type" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="occurred_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>

            <!-- Who did it -->
            <column name="actor_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>

            <!-- Context -->
            <column name="workspace_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="repository_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>
            <column name="target_type" type="VARCHAR(32)">
                <constraints nullable="true"/>
            </column>
            <column name="target_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>

            <!-- Source -->
            <column name="source_system" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>

            <!-- Event chains (notification → click → action) -->
            <column name="correlation_id" type="UUID">
                <constraints nullable="true"/>
            </column>

            <!-- XP points earned (computed at write time) -->
            <column name="xp" type="DOUBLE PRECISION" defaultValueNumeric="0.0">
                <constraints nullable="false"/>
            </column>

            <!-- Everything else -->
            <column name="payload" type="JSONB">
                <constraints nullable="true"/>
            </column>

            <!-- Bookkeeping -->
            <column name="ingested_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Idempotency constraint -->
        <addUniqueConstraint
            tableName="activity_event"
            columnNames="workspace_id, event_key"
            constraintName="uk_activity_event_workspace_key"/>

        <!-- Only 4 indexes - what we actually query -->
        <createIndex tableName="activity_event" indexName="idx_activity_event_workspace_time">
            <column name="workspace_id"/>
            <column name="occurred_at"/>
        </createIndex>
        <createIndex tableName="activity_event" indexName="idx_activity_event_actor_time">
            <column name="actor_id"/>
            <column name="occurred_at"/>
        </createIndex>
        <createIndex tableName="activity_event" indexName="idx_activity_event_type_time">
            <column name="event_type"/>
            <column name="occurred_at"/>
        </createIndex>
        <createIndex tableName="activity_event" indexName="idx_activity_event_correlation">
            <column name="correlation_id"/>
        </createIndex>
        <!-- Optimal index for leaderboard GROUP BY aggregation -->
        <createIndex tableName="activity_event" indexName="idx_activity_event_leaderboard">
            <column name="workspace_id"/>
            <column name="actor_id"/>
            <column name="occurred_at"/>
        </createIndex>

        <!-- Foreign keys -->
        <addForeignKeyConstraint
            baseTableName="activity_event"
            baseColumnNames="workspace_id"
            referencedTableName="workspace"
            referencedColumnNames="id"
            constraintName="fk_activity_event_workspace"/>
        <addForeignKeyConstraint
            baseTableName="activity_event"
            baseColumnNames="actor_id"
            referencedTableName="user"
            referencedColumnNames="id"
            constraintName="fk_activity_event_actor"/>
        <addForeignKeyConstraint
            baseTableName="activity_event"
            baseColumnNames="repository_id"
            referencedTableName="repository"
            referencedColumnNames="id"
            constraintName="fk_activity_event_repository"/>
    </changeSet>

</databaseChangeLog>
