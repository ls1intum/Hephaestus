spring:
    application:
        name: Hephaestus
        version: "0.10.0-rc.46"

    config:
        import: optional:file:.env[.properties]

    datasource:
        url: jdbc:postgresql://localhost:5432/hephaestus
        username: root
        password: root
        hikari:
            connection-timeout: 45000
            idle-timeout: 600000
            max-lifetime: 1800000
            maximum-pool-size: 30
            minimum-idle: 5

    jpa:
        hibernate:
            # We use update for development and none for production, as we use liquibase
            ddl-auto: update
        # Disable open-in-view to prevent lazy loading during view rendering
        # and avoid the warning. Database queries should be completed in the service layer.
        open-in-view: false

        # show-sql: "true"
        properties:
            hibernate:
                integrator_provider: de.tum.in.www1.hephaestus.ClassImportIntegratorIntegratorProvider
                format_sql: "true"

    liquibase:
        change-log: classpath:db/master.xml

    devtools:
        restart:
            additional-exclude: org/kohsuke/github/**
        add-properties: false

    security:
        oauth2:
            resourceserver:
                jwt:
                    issuer-uri: http://localhost:8081/realms/hephaestus

    thymeleaf:
        prefix: ${MAIL_TEMPLATE_FOLDER:classpath:/mail-templates/}
        suffix: .html

    mail:
        host: ${MAIL_HOST:smtp.gmail.com}
        port: ${MAIL_PORT:587}
        username: ${POSTFIX_USERNAME:} # gmail email address e.g hephaestus@gmail.com
        password: ${POSTFIX_PASSWORD:} # app code password from gmail. how to: https://support.google.com/mail/answer/185833?hl=en
        properties:
            mail:
                transport:
                    protocol: smtp
                smtp:
                    starttls:
                        enable: true
                debug: ${MAIL_DEBUG:false}

    # Disable Mustache template location check as we don't use Mustache templates
    mustache:
        check-template-location: false

springdoc:
    default-produces-media-type: application/json
    writer-with-order-by-keys: true

logging:
    level:
        # Suppress warnings about unknown enum values from GitHub API responses
        # For example: when GitHub returns null for the 'side' field in PR review comments
        # (typically for outdated comments, multi-line comments, or file-level comments)
        org.kohsuke.github.internal.EnumUtils: ERROR

hephaestus:
    host-url: https://hephaestus.ase.cit.tum.de/

    webapp:
        url: ${CLIENT_HOST:http://localhost:4200}
    
    leaderboard:
        schedule:
            day: 2
            time: "9:00"
        notification:
            enabled: false
            team: "all"
            channel-id: ""
    
    # ═══════════════════════════════════════════════════════════════════════════
    # WORKSPACE CONFIGURATION
    # ═══════════════════════════════════════════════════════════════════════════
    # Hephaestus supports two GitHub authentication modes:
    #
    # 1. GITHUB APP MODE (recommended for production)
    #    - Workspaces are automatically created from GitHub App installations
    #    - Repository monitors are managed by installation events (webhooks)
    #    - Configure: github.app.id and github.app.privateKey
    #    - Set init-default: false (workspaces come from installations)
    #
    # 2. PAT MODE (recommended for local development)
    #    - A single workspace is bootstrapped from configuration below
    #    - You manually specify which repositories to monitor
    #    - Configure: hephaestus.workspace.default.token
    #    - Set init-default: true
    #
    # The init-default setting only affects PAT-based workspace creation.
    # GitHub App installations are always processed regardless of this setting.
    # ═══════════════════════════════════════════════════════════════════════════
    workspace:
        # Set to true to bootstrap a PAT workspace on startup (for local development)
        # Set to false in production when using GitHub App installations
        init-default: true
        slug:
            # TTL (in days) for slug redirects; set to 0 to disable redirects while preserving history
            redirect:
                ttl-days: 30
        default:
            # GitHub organization or user login for the PAT workspace
            login: ${GITHUB_PAT_LOGIN:ls1intum}
            # Personal Access Token with repo, read:org, and read:user scopes
            token: ${GITHUB_PAT:}
            # Repositories to monitor (PAT mode always uses explicit list)
            repositories-to-monitor:
                - ls1intum/Hephaestus
                - ls1intum/Artemis
    
    intelligence-service:
        url: http://localhost:8000

    cache:
        contributors:
            # Eviction rate in milliseconds (1 hour)
            evict-rate: 3600000
    mail:
        enabled: ${MAIL_ENABLED:false}
        sender: ${MAIL_SENDER:hephaestus@gmail.com} # use gmail email address for local testing

    detection:
        run-automatic-detection-for-all: false
        tracing:
            enabled: false
            # The host of the langfuse server
            host: ${LANGFUSE_HOST:}
            # The public key of the langfuse server
            public-key: ${LANGFUSE_PUBLIC_KEY:}
            # The secret key of the langfuse server
            secret-key: ${LANGFUSE_SECRET_KEY:}

    posthog:
        enabled: ${POSTHOG_ENABLED:false}
        api-host: ${POSTHOG_API_HOST:https://app.posthog.com}
        project-id: ${POSTHOG_PROJECT_ID:}
        personal-api-key: ${POSTHOG_PERSONAL_API_KEY:}



keycloak:
    url: http://localhost:8081
    realm: hephaestus
    client-id: hephaestus-confidential
    client-secret: ${KEYCLOAK_HEPHAESTUS_CONFIDENTIAL_CLIENT_SECRET:${KEYCLOAK_CLIENT_SECRET:0g0QtFmz6GB1Jv03SszCFepPro0hiP7G}}

nats:
    enabled: false
    timeframe: 7
    durable-consumer-name: ""
    server: ""
    consumer:
        # How long to wait for acknowledgment before redelivery (minutes)
        ack-wait-minutes: 5
        # Maximum pending unacknowledged messages per consumer
        max-ack-pending: 500
        # Minimum interval between heartbeat alarm log messages (minutes)
        heartbeat-log-interval-minutes: 5
        # Number of consecutive heartbeat alarms before triggering consumer restart
        heartbeat-restart-threshold: 3
        # Delay between reconnection attempts (seconds)
        reconnect-delay-seconds: 2
        # Request timeout for JetStream API calls (seconds) - increase for workspaces with many repositories
        request-timeout-seconds: 60

monitoring:
    run-on-startup: true
    # Fetching timeframe in days for recent data sync
    timeframe: 7
    sync-cron: "0 0 3 * * *"
    # Cooldown in minutes before running the monitoring again
    sync-cooldown-in-minutes: 15
    # ═══════════════════════════════════════════════════════════════════════════
    # BACKFILL CONFIGURATION
    # ═══════════════════════════════════════════════════════════════════════════
    # Historical data synchronization settings.
    # When enabled, backfill runs AFTER recent sync completes, in small batches
    # to avoid exhausting GitHub API rate limits.
    backfill:
        # Whether to backfill historical issues and pull requests
        enabled: false
        # Number of issues/PRs to sync per batch (default: 25)
        # Lower = fewer API calls per sync cycle, Higher = faster backfill
        batch-size: 25
        # Minimum rate limit remaining before backfill runs (default: 500)
        # Backfill skips if remaining < threshold to preserve rate limit for real-time sync
        rate-limit-threshold: 500
        # Minutes to wait between backfill batches (default: 5)
        # Spreads API usage over time to avoid rate limit exhaustion
        cooldown-minutes: 5
    # ═══════════════════════════════════════════════════════════════════════════
    # DEVELOPMENT FILTERS
    # ═══════════════════════════════════════════════════════════════════════════
    # Limit which organizations/repositories are actively synced.
    # Useful in development to avoid syncing hundreds of repos from GitHub App installations.
    #
    # Empty lists = no filtering (production behavior, sync everything)
    # Non-empty = only sync matching items
    #
    # Configure these in application-local.yml for development:
    #   monitoring:
    #     filters:
    #       allowed-organizations:
    #         - ls1intum
    #         - HephaestusTest
    #       allowed-repositories:
    #         - ls1intum/Hephaestus
    #         - ls1intum/Artemis
    # ═══════════════════════════════════════════════════════════════════════════
    filters:
        # Limit to workspaces owned by these organizations (case-insensitive)
        allowed-organizations: []
        # Limit to these specific repositories (format: owner/repo, case-insensitive)
        allowed-repositories: []

# ═══════════════════════════════════════════════════════════════════════════
# GITHUB AUTHENTICATION
# ═══════════════════════════════════════════════════════════════════════════
# Can be any OAuth token, such as the PAT
github:
    app:
        # Set to 0 to disable GitHub App mode and use Personal Access Tokens instead
        id: ${GH_APP_ID:0}
        privateKeyLocation: ${GH_APP_PRIVATE_KEY_LOCATION:}
        privateKey: ${GH_APP_PRIVATE_KEY:}
    meta:
        auth-token: ${GH_AUTH_TOKEN:}

slack:
    token: ""
    signing-secret: ""

sentry:
    dsn: ""
