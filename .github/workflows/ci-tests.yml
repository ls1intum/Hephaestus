name: Tests

on:
  workflow_call:
    inputs:
      should_skip:
        description: "Whether to skip the workflow"
        required: false
        type: string
        default: "false"
      # Path-based change detection for selective test execution
      webapp_changed:
        description: "Whether webapp files changed"
        required: false
        type: string
        default: "true"
      application_server_changed:
        description: "Whether application-server files changed"
        required: false
        type: string
        default: "true"
      intelligence_service_changed:
        description: "Whether intelligence-service files changed"
        required: false
        type: string
        default: "true"
      webhook_ingest_changed:
        description: "Whether webhook-ingest files changed"
        required: false
        type: string
        default: "true"

# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ TEST SUITE                                                                   ‚îÇ
# ‚îÇ Matrix-based test execution with path-based filtering.                       ‚îÇ
# ‚îÇ                                                                               ‚îÇ
# ‚îÇ Test types:                                                                  ‚îÇ
# ‚îÇ - application-server-*: JUnit tests (unit, integration, architecture)        ‚îÇ
# ‚îÇ - webapp-unit: Vitest unit tests                                             ‚îÇ
# ‚îÇ - webapp-storybook: Storybook interaction tests with Playwright/Vitest       ‚îÇ
# ‚îÇ - webapp-visual: Chromatic visual regression tests                           ‚îÇ
# ‚îÇ - intelligence-service-*: Vitest unit and integration tests (Testcontainers) ‚îÇ
# ‚îÇ - webhook-ingest-*: Vitest unit tests                                        ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

jobs:
  tests:
    permissions:
      contents: read
      checks: write
      statuses: write
    name: ${{ matrix.test-type }}
    runs-on: ubuntu-latest
    if: inputs.should_skip != 'true'
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        test-type:
          [
            application-server-unit,
            application-server-integration,
            application-server-architecture,
            webapp-unit,
            webapp-storybook,
            webapp-visual,
            intelligence-service-unit,
            intelligence-service-integration,
            webhook-ingest-unit,
          ]

    steps:
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Path-based skip logic
      # IMPORTANT: If adding a new test type to the matrix above, add a case here!
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Determine if test should run
        id: should_run
        run: |
          case "${{ matrix.test-type }}" in
            "webapp-unit"|"webapp-storybook"|"webapp-visual")
              echo "run=${{ inputs.webapp_changed }}" >> $GITHUB_OUTPUT
              ;;
            "application-server-unit"|"application-server-integration"|"application-server-architecture")
              echo "run=${{ inputs.application_server_changed }}" >> $GITHUB_OUTPUT
              ;;
            "intelligence-service-unit"|"intelligence-service-integration")
              echo "run=${{ inputs.intelligence_service_changed }}" >> $GITHUB_OUTPUT
              ;;
            "webhook-ingest-unit")
              echo "run=${{ inputs.webhook_ingest_changed }}" >> $GITHUB_OUTPUT
              ;;
            *)
              # Unknown test type - fail explicitly to catch missing case statements
              echo "::error::Unknown test type '${{ matrix.test-type }}' in ci-tests.yml matrix."
              echo "::error::Please add a case for this test type in the 'Determine if test should run' step."
              echo "run=false" >> $GITHUB_OUTPUT
              exit 1
              ;;
          esac

      - name: Skip notification
        if: steps.should_run.outputs.run != 'true'
        run: |
          echo "‚è≠Ô∏è Skipping ${{ matrix.test-type }} - no relevant files changed"
          echo "   This is expected behavior from path-based filtering."

      - uses: actions/checkout@v4
        if: steps.should_run.outputs.run == 'true'
        with:
          # Why fetch-depth: 0 (full history)?
          # - webapp-visual: Chromatic's TurboSnap feature needs git history to detect
          #   which stories changed and only test those, saving build minutes
          # - application-server: Could use fetch-depth: 1, but keeping 0 for simplicity
          #   since git clone overhead is minimal (~2-3s) and full history enables
          #   future features like blame-based test selection
          fetch-depth: 0

      # Ensure stable Node/npm and proper caching for webapp visual tests
      - name: Setup Node.js (LTS) and npm cache
        if: steps.should_run.outputs.run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version-file: ".node-version"
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            webapp/package-lock.json

      # Advanced caching strategy
      - name: Setup advanced caches
        if: steps.should_run.outputs.run == 'true'
        uses: ./.github/actions/setup-caches
        with:
          cache-type: ${{ matrix.test-type }}
          os: ${{ runner.os }}

      # application-server tests
      - name: "application-server ${{ matrix.test-type }} execution"
        if: steps.should_run.outputs.run == 'true' && startsWith(matrix.test-type, 'application-server-')
        run: |
          echo "üß™ Running application-server ${{ matrix.test-type }} tests"
          cd server/application-server

          # Clean previous test reports to ensure accurate reporting
          rm -rf target/surefire-reports/*

          case "${{ matrix.test-type }}" in
            "application-server-unit")
              mvn test -Dgroups="unit" -T 2C --batch-mode
              ;;
            "application-server-integration")
              mvn test -Dgroups="integration" -T 2C --batch-mode
              ;;
            "application-server-architecture")
              mvn test -Dgroups="architecture" -T 2C --batch-mode
              ;;
          esac

      # Webapp tests
      - name: "Webapp ${{ matrix.test-type }} execution"
        if: steps.should_run.outputs.run == 'true' && startsWith(matrix.test-type, 'webapp-')
        run: |
          echo "üß™ Running webapp ${{ matrix.test-type }} tests"

          # Install from repo root for workspace/hoisted optional deps
          rm -rf node_modules
          npm ci --workspaces --include=dev --include=optional --no-audit --progress=false

          # Check for rollup native binary (warning only)
          npm ls @rollup/rollup-linux-x64-gnu || echo "‚ö†Ô∏è rollup native not installed yet"

          # Force-install platform binaries
          node scripts/install-platform-binaries.mjs

          cd webapp

          case "${{ matrix.test-type }}" in
            "webapp-unit")
              echo "üß™ Running webapp unit tests..."
              npm run test
              ;;
            "webapp-storybook")
              echo "üß™ Running Storybook interaction tests with Playwright..."
              # Install Playwright chromium browser for Vitest browser mode
              # Note: setup-caches action caches ~/.cache/ms-playwright for faster installs
              if [ -d ~/.cache/ms-playwright ]; then
                echo "üì¶ Playwright cache found, checking if install needed..."
              fi
              npx playwright install chromium --with-deps
              npm run test:storybook
              ;;
            "webapp-visual")
              if ! npm run build-storybook; then
                echo "‚ùå Storybook build failed, retrying..."
                cd ..
                rm -rf node_modules
                npm ci --workspaces --include=dev --include=optional --no-audit --progress=false
                cd webapp
                npm run build-storybook
              fi
              ;;
          esac

      # Intelligence-service tests
      - name: "Intelligence-service ${{ matrix.test-type }} execution"
        if: steps.should_run.outputs.run == 'true' && startsWith(matrix.test-type, 'intelligence-service-')
        run: |
          # Clean local node_modules but PRESERVE ~/.npm cache (restored by setup-node)
          # The npm cache is used by npm ci to avoid re-downloading packages
          rm -rf node_modules server/intelligence-service/node_modules
          npm install --no-audit --progress=false

          # Install platform binaries from package.json versions
          node scripts/install-platform-binaries.mjs

          cd server/intelligence-service

          case "${{ matrix.test-type }}" in
            "intelligence-service-unit")
              echo "üß™ Running intelligence-service unit tests (pure unit tests, no database)..."
              npm run test:unit
              ;;
            "intelligence-service-integration")
              echo "üß™ Running intelligence-service integration tests (with Testcontainers)..."
              npm run test:integration
              ;;
          esac

      # Webhook-ingest tests
      - name: "Webhook-ingest ${{ matrix.test-type }} execution"
        if: steps.should_run.outputs.run == 'true' && matrix.test-type == 'webhook-ingest-unit'
        run: |
          echo "üß™ Running webhook-ingest unit tests..."

          # Clean local node_modules but PRESERVE ~/.npm cache (restored by setup-node)
          # The npm cache is used by npm ci to avoid re-downloading packages
          rm -rf node_modules server/webhook-ingest/node_modules
          npm install --no-audit --progress=false

          # Install platform binaries from package.json versions
          node scripts/install-platform-binaries.mjs

          cd server/webhook-ingest
          npm run test

      # Chromatic visual testing
      - name: "Chromatic Visual Testing"
        if: steps.should_run.outputs.run == 'true' && matrix.test-type == 'webapp-visual'
        id: chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          workingDir: webapp
          onlyChanged: true
          zip: true
          skip: "@(dependabot/**|renovate/**)"
          autoAcceptChanges: ${{ github.ref == 'refs/heads/main' && 'main' || '' }}
          exitZeroOnChanges: false
          logLevel: info
          junitReport: true
        env:
          CHROMATIC_BRANCH: ${{ github.head_ref || github.ref_name }}
          CHROMATIC_SHA: ${{ github.event.pull_request.head.sha || github.sha }}

      # Create Storybook status check
      # CRITICAL: For pull_request events, context.sha is the MERGE commit, not the PR head.
      # We must use the PR head SHA for the status to appear on the PR checks page.
      - name: "Create Storybook status check"
        if: steps.should_run.outputs.run == 'true' && matrix.test-type == 'webapp-visual' && always() && startsWith(steps.chromatic.outputs.storybookUrl, 'http')
        uses: actions/github-script@v7
        with:
          script: |
            // Use PR head SHA for pull_request events, otherwise use context.sha
            const sha = context.payload.pull_request?.head?.sha || context.sha;
            console.log(`Creating status check on SHA: ${sha}`);
            console.log(`Storybook URL: ${{ steps.chromatic.outputs.storybookUrl }}`);

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: sha,
              state: 'success',
              target_url: '${{ steps.chromatic.outputs.storybookUrl }}',
              description: 'Click Details to view your Storybook',
              context: 'Storybook Publish'
            });

      # Test result aggregation
      - name: Upload application-server test results
        if: steps.should_run.outputs.run == 'true' && always() && startsWith(matrix.test-type, 'application-server-')
        uses: dorny/test-reporter@v2
        with:
          name: "Test Results - ${{ matrix.test-type }}"
          path: "server/application-server/target/surefire-reports/TEST-*.xml"
          reporter: java-junit
          fail-on-error: false

      - name: Upload Chromatic test results
        if: steps.should_run.outputs.run == 'true' && always() && matrix.test-type == 'webapp-visual' && startsWith(steps.chromatic.outputs.storybookUrl, 'http')
        uses: dorny/test-reporter@v2
        with:
          name: "Test Results - ${{ matrix.test-type }}"
          path: "webapp/chromatic-build-*.xml"
          reporter: java-junit
          fail-on-error: false

      - name: Upload intelligence-service test results
        if: steps.should_run.outputs.run == 'true' && always() && startsWith(matrix.test-type, 'intelligence-service-')
        uses: dorny/test-reporter@v2
        with:
          name: "Test Results - ${{ matrix.test-type }}"
          path: "server/intelligence-service/test-results/junit-*.xml"
          reporter: java-junit
          fail-on-error: false
