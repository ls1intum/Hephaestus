name: "PR"

on:
  pull_request_target:
    types:
      - opened
      - edited
      - synchronize
      - reopened
      - ready_for_review

jobs:
  validate-title:
    name: "Validate title"
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: "Install dependencies"
        run: npm ci

      - name: "Validate PR title with commitlint"
        id: commitlint
        run: |
          # Use commitlint to validate PR title (single source of truth)
          echo "${{ github.event.pull_request.title }}" | npx --no-install commitlint 2>&1 | tee /tmp/commitlint-output.txt
          exit_code=${PIPESTATUS[1]}
          
          # Capture output for the comment
          {
            echo 'error_message<<EOF'
            cat /tmp/commitlint-output.txt
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
          
          exit $exit_code
        continue-on-error: true

      - name: "Comment on PR with validation error"
        uses: marocchino/sticky-pull-request-comment@v2
        if: steps.commitlint.outcome == 'failure'
        with:
          header: pr-title-lint-error
          message: |
            ## âŒ PR Title Validation Failed

            ```
            ${{ steps.commitlint.outputs.error_message }}
            ```

            > ðŸ“– See [CONTRIBUTING.md](https://github.com/ls1intum/Hephaestus/blob/main/CONTRIBUTING.md) for commit message guidelines.

      - name: "Remove error comment on success"
        uses: marocchino/sticky-pull-request-comment@v2
        if: steps.commitlint.outcome == 'success'
        with:
          header: pr-title-lint-error
          delete: true

      - name: "Fail workflow if commitlint failed"
        if: steps.commitlint.outcome == 'failure'
        run: exit 1

  assign-author:
    name: "Assign author"
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    if: github.event.action == 'opened'
    steps:
      - uses: technote-space/assign-author@v1

  labeler:
    name: "Apply labels"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - uses: actions/labeler@v5
        with:
          configuration-path: .github/labeler.yml

      - name: "Apply size and semantic labels"
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/label-pr.js')
            await script({github, context})
