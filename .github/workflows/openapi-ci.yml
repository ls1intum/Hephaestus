name: CI/CD

on:
  pull_request:
    types: [opened, synchronize, labeled, reopened]
    paths:
      - 'server/application-server/**'
      - 'server/intelligence-service/**'
      - '.github/workflows/openapi-ci.yml'
      - 'server/application-server/src/main/java/de/tum/in/www1/hephaestus/intelligenceservice/**'
  push:
    paths:
      - 'server/application-server/openapi.yaml'
      - 'server/intelligence-service/openapi.yaml'
      - 'webapp-react/src/api/**/*.gen.ts'
      - 'server/application-server/src/main/java/de/tum/in/www1/hephaestus/intelligenceservice/**'
    branches: [develop]
  workflow_dispatch:

jobs:
  # Intelligence Service spec validation
  intelligence-service-specs:
    name: Intelligence Service / Validate OpenAPI spec (add autocommit-openapi label to PR to auto-commit changes)
    runs-on: ubuntu-latest
    outputs:
      spec-changed: ${{ steps.check_spec_changes.outputs.spec_changed }}
      spec-content: ${{ steps.spec_output.outputs.spec_content }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          persist-credentials: false
          fetch-depth: 0

      - name: Set up Python 3.13
        uses: actions/setup-python@v2
        with:
          python-version: 3.13

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 2.1.1
          virtualenvs-create: true
          virtualenvs-in-project: true
          virtualenvs-path: .venv
          installer-parallel: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install Python dependencies
        working-directory: server/intelligence-service
        run: poetry lock && poetry install --no-interaction --no-root

      - name: Generate and validate OpenAPI specs
        run: npm run generate:api:intelligence-service:specs

      - name: Check for spec changes
        id: check_spec_changes
        run: |
          echo "Checking for changes in OpenAPI spec..."
          git add server/intelligence-service/openapi.yaml
          if git diff --cached --quiet; then
            echo "No changes detected in OpenAPI spec."
            echo "spec_changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in OpenAPI spec."
            git diff --cached
            echo "spec_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate spec consistency
        run: |
          if [[ "${{ steps.check_spec_changes.outputs.spec_changed }}" == "true" ]]; then
            # Check if autocommit label is present
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'autocommit-openapi') }}" == "true" ]]; then
              echo "✅ Intelligence Service OpenAPI spec changes detected, but autocommit-openapi label is present - will auto-commit"
            else
              echo "## ⚠️ Intelligence Service OpenAPI Spec Out of Sync" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Issue:** The committed Intelligence Service OpenAPI spec does not match the current FastAPI code." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**What this means:**" >> $GITHUB_STEP_SUMMARY
              echo "- Intelligence Service FastAPI code changes were made without regenerating the OpenAPI specification" >> $GITHUB_STEP_SUMMARY
              echo "- The Intelligence Service spec file is out of sync with the actual FastAPI endpoints" >> $GITHUB_STEP_SUMMARY
              echo "- This will cause the Application Server's Java client generation to use outdated API definitions" >> $GITHUB_STEP_SUMMARY
              echo "- The outdated spec will also affect any future Java client regeneration" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Fix Required (choose one):**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Option 1 - Auto-commit (Recommended):**" >> $GITHUB_STEP_SUMMARY
              echo "Add the \`autocommit-openapi\` label to this PR to automatically commit the updated spec." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Option 2 - Manual fix:**" >> $GITHUB_STEP_SUMMARY
              echo '```bash' >> $GITHUB_STEP_SUMMARY
              echo '# Option 2a: Update just the spec' >> $GITHUB_STEP_SUMMARY
              echo 'npm run generate:api:intelligence-service:specs' >> $GITHUB_STEP_SUMMARY
              echo 'git add server/intelligence-service/openapi.yaml' >> $GITHUB_STEP_SUMMARY
              echo 'git commit -m "chore: update intelligence service OpenAPI spec"' >> $GITHUB_STEP_SUMMARY
              echo '' >> $GITHUB_STEP_SUMMARY
              echo '# Option 2b: Update spec + Java client (recommended)' >> $GITHUB_STEP_SUMMARY
              echo 'npm run generate:api:intelligence-service' >> $GITHUB_STEP_SUMMARY
              echo 'git add server/intelligence-service/openapi.yaml server/application-server/src/main/java/de/tum/in/www1/hephaestus/intelligenceservice/' >> $GITHUB_STEP_SUMMARY
              echo 'git commit -m "chore: update intelligence service OpenAPI spec and Java client"' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Changes detected:**" >> $GITHUB_STEP_SUMMARY
              echo '```diff' >> $GITHUB_STEP_SUMMARY
              git diff --cached server/intelligence-service/openapi.yaml >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "Intelligence Service OpenAPI spec validation failed. Check the CI summary above for details."
              exit 1
            fi
          else
            echo "✅ Intelligence Service OpenAPI spec validation passed - FastAPI spec matches code"
          fi

      - name: Output OpenAPI spec content
        id: spec_output
        run: |
          echo "spec_content<<EOF" >> $GITHUB_OUTPUT
          cat server/intelligence-service/openapi.yaml >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # Application Server spec validation
  application-server-specs:
    name: Application Server / Validate OpenAPI spec (add autocommit-openapi label to PR to auto-commit changes)
    runs-on: ubuntu-latest
    outputs:
      spec-changed: ${{ steps.check_spec_changes.outputs.spec_changed }}
      spec-content: ${{ steps.spec_output.outputs.spec_content }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          persist-credentials: false
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Set up directories
        working-directory: server/application-server
        run: |
          mkdir -p ./keycloak-data
          chmod -R 755 ./keycloak-data

      - name: Generate and validate OpenAPI specs
        run: npm run generate:api:application-server:specs

      - name: Check for spec changes
        id: check_spec_changes
        run: |
          echo "Checking for changes in OpenAPI spec..."
          git add server/application-server/openapi.yaml
          if git diff --cached --quiet; then
            echo "No changes detected in OpenAPI spec."
            echo "spec_changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in OpenAPI spec."
            git diff --cached
            echo "spec_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate spec consistency
        run: |
          if [[ "${{ steps.check_spec_changes.outputs.spec_changed }}" == "true" ]]; then
            # Check if autocommit label is present
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'autocommit-openapi') }}" == "true" ]]; then
              echo "✅ Application Server OpenAPI spec changes detected, but autocommit-openapi label is present - will auto-commit"
            else
              echo "## ⚠️ Application Server OpenAPI Spec Out of Sync" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Issue:** The committed Application Server OpenAPI spec does not match the current Spring Boot code." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**What this means:**" >> $GITHUB_STEP_SUMMARY
              echo "- Application Server Spring Boot code changes were made without regenerating the OpenAPI specification" >> $GITHUB_STEP_SUMMARY
              echo "- The Application Server spec file is out of sync with the actual Spring Boot API endpoints" >> $GITHUB_STEP_SUMMARY
              echo "- This will cause the Webapp's TypeScript client generation to use outdated API definitions" >> $GITHUB_STEP_SUMMARY
              echo "- The outdated spec will also affect any future TypeScript client regeneration" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Fix Required (choose one):**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Option 1 - Auto-commit (Recommended):**" >> $GITHUB_STEP_SUMMARY
              echo "Add the \`autocommit-openapi\` label to this PR to automatically commit the updated spec." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Option 2 - Manual fix:**" >> $GITHUB_STEP_SUMMARY
              echo '```bash' >> $GITHUB_STEP_SUMMARY
              echo '# Option 2a: Update just the spec' >> $GITHUB_STEP_SUMMARY
              echo 'npm run generate:api:application-server:specs' >> $GITHUB_STEP_SUMMARY
              echo 'git add server/application-server/openapi.yaml' >> $GITHUB_STEP_SUMMARY
              echo 'git commit -m "chore: update application server OpenAPI spec"' >> $GITHUB_STEP_SUMMARY
              echo '' >> $GITHUB_STEP_SUMMARY
              echo '# Option 2b: Update spec + clients (recommended)' >> $GITHUB_STEP_SUMMARY
              echo 'npm run generate:api:application-server' >> $GITHUB_STEP_SUMMARY
              echo 'git add server/application-server/openapi.yaml webapp/src/api/' >> $GITHUB_STEP_SUMMARY
              echo 'git commit -m "chore: update application server OpenAPI spec and clients"' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Changes detected:**" >> $GITHUB_STEP_SUMMARY
              echo '```diff' >> $GITHUB_STEP_SUMMARY
              git diff --cached server/application-server/openapi.yaml >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "Application Server OpenAPI spec validation failed. Check the CI summary above for details."
              exit 1
            fi
          else
            echo "✅ Application Server OpenAPI spec validation passed - Spring Boot spec matches code"
          fi

      - name: Output OpenAPI spec content
        id: spec_output
        run: |
          echo "spec_content<<EOF" >> $GITHUB_OUTPUT
          cat server/application-server/openapi.yaml >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # Intelligence Service Java client generation (runs even if spec validation fails)
  intelligence-service-client:
    name: Application Server / Validate Java API client (add autocommit-openapi label to PR to auto-commit changes)
    runs-on: ubuntu-latest
    needs: intelligence-service-specs
    if: always()
    outputs:
      client-changed: ${{ steps.check_changes.outputs.changes_detected }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          persist-credentials: false
          fetch-depth: 0

      - name: Create Intelligence Service OpenAPI spec from previous job output
        run: |
          mkdir -p server/intelligence-service
          echo '${{ needs.intelligence-service-specs.outputs.spec-content }}' > server/intelligence-service/openapi.yaml

      - name: Install dependencies
        run: npm install

      - name: Generate Java client for the intelligence service
        run: npm run generate:api:intelligence-service:client

      - name: Check for changes in the API
        id: check_changes
        run: |
          echo "Checking for changes in the API client directory..."
          git add .
          if git diff --cached --quiet; then
            echo "No changes detected in the API client directory."
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in the API client directory."
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            git diff --cached
          fi

      - name: Validate client consistency
        run: |
          if [[ "${{ steps.check_changes.outputs.changes_detected }}" == "true" ]]; then
            # Check if autocommit label is present
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'autocommit-openapi') }}" == "true" ]]; then
              echo "✅ Intelligence Service Java client changes detected, but autocommit-openapi label is present - will auto-commit"
            else
              echo "## ⚠️ Intelligence Service Java Client Out of Sync" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Issue:** The Application Server's Java client for Intelligence Service does not match the current Intelligence Service OpenAPI spec." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**What this means:**" >> $GITHUB_STEP_SUMMARY
              echo "- Intelligence Service OpenAPI spec was updated but the Application Server's Java client wasn't regenerated" >> $GITHUB_STEP_SUMMARY
              echo "- The Application Server will use an outdated Java client to call the Intelligence Service" >> $GITHUB_STEP_SUMMARY
              echo "- API calls from Application Server to Intelligence Service may fail or use wrong data structures" >> $GITHUB_STEP_SUMMARY
              echo "- This affects the entire chain: Intelligence Service spec → Application Server Java client → Application functionality" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Fix Required (choose one):**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Option 1 - Auto-commit (Recommended):**" >> $GITHUB_STEP_SUMMARY
              echo "Add the \`autocommit-openapi\` label to this PR to automatically commit the updated client." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Option 2 - Manual fix:**" >> $GITHUB_STEP_SUMMARY
              echo '```bash' >> $GITHUB_STEP_SUMMARY
              echo '# Option 2a: Update just the client' >> $GITHUB_STEP_SUMMARY
              echo 'npm run generate:api:intelligence-service:client' >> $GITHUB_STEP_SUMMARY
              echo 'git add server/application-server/src/main/java/de/tum/in/www1/hephaestus/intelligenceservice/' >> $GITHUB_STEP_SUMMARY
              echo 'git commit -m "chore: update intelligence service Java client"' >> $GITHUB_STEP_SUMMARY
              echo '' >> $GITHUB_STEP_SUMMARY
              echo '# Option 2b: Update spec + client (recommended)' >> $GITHUB_STEP_SUMMARY
              echo 'npm run generate:api:intelligence-service' >> $GITHUB_STEP_SUMMARY
              echo 'git add server/intelligence-service/openapi.yaml server/application-server/src/main/java/de/tum/in/www1/hephaestus/intelligenceservice/' >> $GITHUB_STEP_SUMMARY
              echo 'git commit -m "chore: update intelligence service OpenAPI spec and Java client"' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Changes detected:**" >> $GITHUB_STEP_SUMMARY
              echo '```diff' >> $GITHUB_STEP_SUMMARY
              git diff --cached server/application-server/src/main/java/de/tum/in/www1/hephaestus/intelligenceservice/ >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "Application Server Java client (for Intelligence Service) validation failed. Check the CI summary above for details."
              exit 1
            fi
          else
            echo "✅ Application Server Java client validation passed - client matches Intelligence Service OpenAPI spec"
          fi

  # Application Server React client generation (runs even if spec validation fails)
  application-server-client:
    name: Webapp (React) / Validate TypeScript API client (add autocommit-openapi label to PR to auto-commit changes)
    runs-on: ubuntu-latest
    needs: application-server-specs
    if: always()
    outputs:
      client-changed: ${{ steps.check_changes.outputs.changes_detected }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          persist-credentials: false
          fetch-depth: 0

      - name: Create Application Server OpenAPI spec from previous job output
        run: |
          mkdir -p server/application-server
          echo '${{ needs.application-server-specs.outputs.spec-content }}' > server/application-server/openapi.yaml

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Generate React client for the application server
        run: npm run generate:api:application-server:client-react

      - name: Check for changes in the API
        id: check_changes
        run: |
          echo "Checking for changes in the API client directory..."
          echo "Current git status:"
          git status
          echo "Current git diff:"
          git diff
          git add .
          echo "Git status after adding changes:"
          git status
          if git diff --cached --quiet; then
            echo "No changes detected in the API client directory."
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in the API client directory."
            echo "Staged changes:"
            git diff --cached
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate client consistency
        run: |
          if [[ "${{ steps.check_changes.outputs.changes_detected }}" == "true" ]]; then
            # Check if autocommit label is present
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'autocommit-openapi') }}" == "true" ]]; then
              echo "✅ Application Server TypeScript client changes detected, but autocommit-openapi label is present - will auto-commit"
            else
              echo "## ⚠️ Application Server TypeScript Client Out of Sync" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Issue:** The Webapp's TypeScript client for Application Server does not match the current Application Server OpenAPI spec." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**What this means:**" >> $GITHUB_STEP_SUMMARY
              echo "- Application Server OpenAPI spec was updated but the Webapp's TypeScript client wasn't regenerated" >> $GITHUB_STEP_SUMMARY
              echo "- The Webapp (React) will use an outdated TypeScript client to call the Application Server" >> $GITHUB_STEP_SUMMARY
              echo "- API calls from Webapp to Application Server may fail or use wrong data structures" >> $GITHUB_STEP_SUMMARY
              echo "- This affects the entire chain: Application Server spec → Webapp TypeScript client → Client functionality" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Fix Required (choose one):**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Option 1 - Auto-commit (Recommended):**" >> $GITHUB_STEP_SUMMARY
              echo "Add the \`autocommit-openapi\` label to this PR to automatically commit the updated client." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Option 2 - Manual fix:**" >> $GITHUB_STEP_SUMMARY
              echo '```bash' >> $GITHUB_STEP_SUMMARY
              echo 'npm run generate:api:application-server:client-react' >> $GITHUB_STEP_SUMMARY
              echo 'git add webapp-react/src/api/' >> $GITHUB_STEP_SUMMARY
              echo 'git commit -m "chore: update application server TypeScript client"' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Option 3 - Generate everything (specs + clients):**" >> $GITHUB_STEP_SUMMARY
              echo '```bash' >> $GITHUB_STEP_SUMMARY
              echo 'npm run generate:api  # Generates all specs and clients at once' >> $GITHUB_STEP_SUMMARY
              echo 'git add .' >> $GITHUB_STEP_SUMMARY
              echo 'git commit -m "chore: update all OpenAPI specs and clients"' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Changes detected:**" >> $GITHUB_STEP_SUMMARY
              echo '```diff' >> $GITHUB_STEP_SUMMARY
              git diff --cached webapp-react/src/api/ >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "Webapp TypeScript client (for Application Server) validation failed. Check the CI summary above for details."
              exit 1
            fi
          else
            echo "✅ Webapp TypeScript client validation passed - client matches Application Server OpenAPI spec"
          fi

  # Unified commit job - runs after both client generations complete
  commit-changes:
    name: OpenAPI / Commit All Changes (add autocommit-openapi label to PR to auto-commit changes)
    runs-on: ubuntu-latest
    needs: [intelligence-service-specs, application-server-specs, intelligence-service-client, application-server-client]
    if: |
      always() && 
      contains(github.event.pull_request.labels.*.name, 'autocommit-openapi') &&
      (
        needs.intelligence-service-specs.outputs.spec-changed == 'true' ||
        needs.application-server-specs.outputs.spec-changed == 'true' ||
        needs.intelligence-service-client.outputs.client-changed == 'true' ||
        needs.application-server-client.outputs.client-changed == 'true'
      )

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          persist-credentials: false
          fetch-depth: 0

      - name: Set up Python 3.13 (for intelligence service spec regeneration)
        if: needs.intelligence-service-specs.outputs.spec-changed == 'true'
        uses: actions/setup-python@v2
        with:
          python-version: 3.13

      - name: Install Poetry (for intelligence service spec regeneration)
        if: needs.intelligence-service-specs.outputs.spec-changed == 'true'
        uses: snok/install-poetry@v1
        with:
          version: 2.1.1
          virtualenvs-create: true
          virtualenvs-in-project: true
          virtualenvs-path: .venv
          installer-parallel: true

      - name: Install Python dependencies (for intelligence service spec regeneration)
        if: needs.intelligence-service-specs.outputs.spec-changed == 'true'
        working-directory: server/intelligence-service
        run: poetry lock && poetry install --no-interaction --no-root

      - name: Regenerate intelligence service OpenAPI specs
        if: needs.intelligence-service-specs.outputs.spec-changed == 'true'
        run: npm run generate:api:intelligence-service:specs

      - name: Set up JDK 21 (for application server spec regeneration)
        if: needs.application-server-specs.outputs.spec-changed == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Set up directories (for application server spec regeneration)
        if: needs.application-server-specs.outputs.spec-changed == 'true'
        working-directory: server/application-server
        run: |
          mkdir -p ./keycloak-data
          chmod -R 755 ./keycloak-data

      - name: Regenerate application server OpenAPI specs
        if: needs.application-server-specs.outputs.spec-changed == 'true'
        run: npm run generate:api:application-server:specs

      - name: Set up Node.js (for client regeneration)
        if: |
          needs.intelligence-service-client.outputs.client-changed == 'true' ||
          needs.application-server-client.outputs.client-changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies (for client regeneration)
        if: |
          needs.intelligence-service-client.outputs.client-changed == 'true' ||
          needs.application-server-client.outputs.client-changed == 'true'
        run: npm install

      - name: Regenerate intelligence service Java client
        if: needs.intelligence-service-client.outputs.client-changed == 'true'
        run: npm run generate:api:intelligence-service:client

      - name: Regenerate application server React client
        if: needs.application-server-client.outputs.client-changed == 'true'
        run: npm run generate:api:application-server:client-react

      - name: Check for any changes and commit
        run: |
          echo "Checking for any changes to commit..."
          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            echo "Changes detected. Committing all OpenAPI updates..."
            git config --local user.name "github-actions[bot]"
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            
            # Build commit message based on what changed
            COMMIT_MSG="chore: update OpenAPI specs and clients"
            COMMIT_BODY=""
            
            if [[ "${{ needs.intelligence-service-specs.outputs.spec-changed }}" == "true" ]]; then
              COMMIT_BODY="$COMMIT_BODY\n- Update intelligence service OpenAPI spec"
            fi
            
            if [[ "${{ needs.application-server-specs.outputs.spec-changed }}" == "true" ]]; then
              COMMIT_BODY="$COMMIT_BODY\n- Update application server OpenAPI spec"
            fi
            
            if [[ "${{ needs.intelligence-service-client.outputs.client-changed }}" == "true" ]]; then
              COMMIT_BODY="$COMMIT_BODY\n- Update intelligence service Java client"
            fi
            
            if [[ "${{ needs.application-server-client.outputs.client-changed }}" == "true" ]]; then
              COMMIT_BODY="$COMMIT_BODY\n- Update application server React client"
            fi
            
            git commit -a -m "$COMMIT_MSG$COMMIT_BODY"
            echo "CHANGES_COMMITTED=true" >> $GITHUB_ENV
          fi

      - name: Push changes
        if: env.CHANGES_COMMITTED == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GH_PAT }}
          branch: ${{ github.event.pull_request.head.ref  }}

      - name: Remove autocommit-openapi label
        run: |
          echo "Removing the autocommit-openapi label..."
          curl --silent --fail-with-body -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels/autocommit-openapi
