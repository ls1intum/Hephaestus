name: CI/CD

on:
  workflow_dispatch:
  push:
    branches: ["develop", "main"]
    tags: ["v*"]
  merge_group:
  pull_request:
    branches: ["**"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  # Global pipeline configuration
  MAVEN_OPTS: -Xmx2048m -XX:+UseParallelGC
  NODE_VERSION: 22
  PYTHON_VERSION: 3.13
  JAVA_VERSION: 21

jobs:
  # Step 1: Pipeline orchestration and duplicate detection
  pipeline-setup:
    uses: ./.github/workflows/ci-pipeline-setup.yml
    secrets: inherit

  # Step 2: Code quality and style checks
  quality-gates:
    uses: ./.github/workflows/ci-quality-gates.yml
    needs: [pipeline-setup]
    if: needs.pipeline-setup.outputs.should_skip != 'true'
    secrets: inherit
    with:
      should_skip: ${{ needs.pipeline-setup.outputs.should_skip }}

  # Step 3: Security vulnerability scanning
  security-scan:
    uses: ./.github/workflows/ci-security-scan.yml
    needs: [pipeline-setup]
    if: needs.pipeline-setup.outputs.should_skip != 'true'
    secrets: inherit
    with:
      should_skip: ${{ needs.pipeline-setup.outputs.should_skip }}

  # Step 4: Comprehensive test execution
  test-suite:
    uses: ./.github/workflows/ci-tests.yml
    needs: [pipeline-setup, quality-gates]
    if: needs.pipeline-setup.outputs.should_skip != 'true'
    secrets: inherit
    with:
      should_skip: ${{ needs.pipeline-setup.outputs.should_skip }}

  # Step 5: Build Docker images
  docker-build:
    uses: ./.github/workflows/ci-docker-build.yml
    needs: [pipeline-setup, test-suite]
    if: needs.pipeline-setup.outputs.should_skip != 'true'
    secrets: inherit
    with:
      should_skip: ${{ needs.pipeline-setup.outputs.should_skip }}

  # Step 6: Security scan Docker images
  docker-security-scan:
    uses: ./.github/workflows/ci-docker-security-scan.yml
    needs: [pipeline-setup, docker-build]
    if: needs.pipeline-setup.outputs.should_skip != 'true'
    secrets: inherit
    with:
      should_skip: ${{ needs.pipeline-setup.outputs.should_skip }}

  # Final: Aggregated success gate for branch protection
  all-ci-passed:
    runs-on: ubuntu-latest
    needs: [quality-gates, security-scan, test-suite, docker-build, docker-security-scan]
    if: always()
    steps:
      - name: Generate comprehensive CI summary
        run: |
          echo "## 🎯 CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Individual job status reporting
          echo "### Job Status Overview:" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Quality**: ${{ needs.quality-gates.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Scan**: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Suite**: ${{ needs.test-suite.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Build**: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Security Scan**: ${{ needs.docker-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Docker images built
          if [[ "${{ needs.docker-build.result }}" == "success" ]]; then
            echo "### 🐳 Images Built:" >> $GITHUB_STEP_SUMMARY
            echo "- **Frontend (React)**: webapp-react" >> $GITHUB_STEP_SUMMARY
            echo "- **Backend (Spring)**: application-server" >> $GITHUB_STEP_SUMMARY
            echo "- **AI Service (FastAPI)**: intelligence-service" >> $GITHUB_STEP_SUMMARY
            echo "- **Webhook Processor**: webhook-ingest" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check all jobs and determine overall status
        run: |
          # Check if any required job failed
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "### ❌ CI Pipeline Result: FAILURE" >> $GITHUB_STEP_SUMMARY
            echo "One or more critical CI jobs failed. Review the individual job logs for details." >> $GITHUB_STEP_SUMMARY
            echo "❌ One or more CI jobs failed"
            exit 1
          elif [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "### ⚠️ CI Pipeline Result: CANCELLED" >> $GITHUB_STEP_SUMMARY
            echo "One or more CI jobs were cancelled. The pipeline did not complete successfully." >> $GITHUB_STEP_SUMMARY
            echo "⚠️ One or more CI jobs were cancelled"
            exit 1
          else
            echo "### ✅ CI Pipeline Result: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "All CI jobs completed successfully! The code is ready for deployment." >> $GITHUB_STEP_SUMMARY
            echo "✅ All CI jobs passed successfully"
          fi

  # Deployment workflows are handled by separate deployment pipelines
  # triggered by successful CI completion
