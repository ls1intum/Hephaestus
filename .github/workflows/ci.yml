name: CI/CD Enterprise Pipeline

on:
  workflow_dispatch:
  push:
    branches: ["develop", "main"]
    tags: ["v*"]
  merge_group:
  pull_request:
    branches: ["**"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  # Global pipeline configuration
  MAVEN_OPTS: -Xmx2048m -XX:+UseParallelGC
  NODE_VERSION: 22
  PYTHON_VERSION: 3.13
  JAVA_VERSION: 21

jobs:
  # Pipeline orchestration and duplicate detection
  pipeline-setup:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
      matrix_include: ${{ steps.matrix_setup.outputs.matrix }}
      changed_components: ${{ steps.changes.outputs.components }}
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          do_not_skip: '["workflow_dispatch", "schedule"]'
          
      - name: Detect changed components
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            webapp:
              - 'webapp-react/**'
            application-server:
              - 'server/application-server/**'
            intelligence-service:
              - 'server/intelligence-service/**'
            webhook-ingest:
              - 'server/webhook-ingest/**'
            docs:
              - 'docs/**'
            ci:
              - '.github/workflows/**'

      - name: Setup dynamic test matrix
        id: matrix_setup
        run: |
          # Create intelligent test matrix based on changes
          MATRIX=$(cat << 'EOF'
          {
            "include": [
              {
                "name": "Quality Gates",
                "type": "quality",
                "runs_if": "always",
                "timeout": 12
              },
              {
                "name": "Security Scan",
                "type": "security", 
                "runs_if": "always",
                "timeout": 15
              },
              {
                "name": "Java Tests",
                "type": "java-tests",
                "runs_if": "${{ steps.changes.outputs.application-server == 'true' || steps.changes.outputs.ci == 'true' }}",
                "timeout": 20
              },
              {
                "name": "Webapp Tests",
                "type": "webapp-tests",
                "runs_if": "${{ steps.changes.outputs.webapp == 'true' || steps.changes.outputs.ci == 'true' }}",
                "timeout": 15
              },
              {
                "name": "Python Tests",
                "type": "python-tests",
                "runs_if": "${{ steps.changes.outputs.intelligence-service == 'true' || steps.changes.outputs.webhook-ingest == 'true' || steps.changes.outputs.ci == 'true' }}",
                "timeout": 10
              }
            ]
          }
          EOF
          )
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  # Enhanced quality gates with parallel execution
  quality-gates:
    runs-on: ubuntu-latest
    needs: [pipeline-setup]
    if: needs.pipeline-setup.outputs.should_skip != 'true'
    timeout-minutes: 12
    strategy:
      fail-fast: false
      matrix:
        check: [java-format, webapp-quality, python-quality, openapi-validation]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Shared cache setup
      - name: Setup shared caches
        uses: ./.github/actions/setup-caches
        with:
          cache-type: ${{ matrix.check }}

      # Java code quality
      - name: Java formatting & quality checks
        if: matrix.check == 'java-format'
        run: |
          npm ci
          npm run format:java:check
          echo "‚úÖ Java code formatting passed" >> $GITHUB_STEP_SUMMARY

      # Webapp quality checks  
      - name: Webapp quality checks
        if: matrix.check == 'webapp-quality'
        working-directory: ./webapp-react
        run: |
          npm ci
          npm run check
          npx tsc --noEmit
          echo "‚úÖ Webapp quality checks passed" >> $GITHUB_STEP_SUMMARY

      # Python quality checks
      - name: Python quality checks
        if: matrix.check == 'python-quality'
        working-directory: server/intelligence-service
        run: |
          poetry install --no-interaction --no-root
          poetry run black --check .
          poetry run flake8 .
          poetry run mypy . --ignore-missing-imports
          echo "‚úÖ Python quality checks passed" >> $GITHUB_STEP_SUMMARY

      # OpenAPI validation with auto-commit
      - name: OpenAPI validation and sync
        if: matrix.check == 'openapi-validation'
        run: |
          # Setup all environments for OpenAPI generation
          npm ci
          
          # Python setup
          cd server/intelligence-service && poetry install --no-interaction --no-root && cd ../..
          
          # Java setup  
          cd server/application-server && mvn compile -DskipTests && cd ../..
          
          # Generate all specs and clients
          npm run generate:api
          
          # Check for changes and handle auto-commit
          git add .
          if ! git diff --cached --quiet; then
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'autocommit-openapi') }}" == "true" ]]; then
              git config --local user.name "github-actions[bot]"
              git config --local user.email "github-actions[bot]@users.noreply.github.com"
              git commit -m "chore: update OpenAPI specs and clients [skip ci]"
              git push
              echo "‚úÖ OpenAPI changes auto-committed" >> $GITHUB_STEP_SUMMARY
            else
              echo "## ‚ö†Ô∏è OpenAPI Changes Detected" >> $GITHUB_STEP_SUMMARY
              echo "Add the 'autocommit-openapi' label to auto-commit these changes." >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "‚úÖ OpenAPI specs and clients are up to date" >> $GITHUB_STEP_SUMMARY
          fi

  # Comprehensive security scanning
  security-scan:
    runs-on: ubuntu-latest
    needs: [pipeline-setup]
    if: needs.pipeline-setup.outputs.should_skip != 'true'
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        scan-type: [sast, dependencies, containers, secrets]
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # SAST (Static Application Security Testing)
      - name: Initialize CodeQL
        if: matrix.scan-type == 'sast'
        uses: github/codeql-action/init@v3
        with:
          languages: java, javascript, python
          queries: security-extended

      - name: Build for CodeQL analysis
        if: matrix.scan-type == 'sast'
        run: |
          # Java build
          cd server/application-server && mvn compile -DskipTests
          # Node.js build
          cd ../../webapp-react && npm ci && npm run build:prod

      - name: Perform CodeQL Analysis
        if: matrix.scan-type == 'sast'
        uses: github/codeql-action/analyze@v3

      # Dependency vulnerability scanning
      - name: Run Trivy dependency scan
        if: matrix.scan-type == 'dependencies'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results
        if: matrix.scan-type == 'dependencies'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      # Container security scanning
      - name: Build and scan containers
        if: matrix.scan-type == 'containers'
        run: |
          # Build test images
          docker build -f webapp-react/Dockerfile webapp-react -t test-webapp:latest
          docker build -f server/application-server/Dockerfile server/application-server -t test-app-server:latest
          
          # Scan containers
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image --format sarif --output container-results.sarif test-webapp:latest

      # Secret scanning
      - name: Run secret detection
        if: matrix.scan-type == 'secrets'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  # Intelligent test execution matrix
  test-matrix:
    runs-on: ${{ matrix.os }}
    needs: [pipeline-setup, quality-gates]
    if: needs.pipeline-setup.outputs.should_skip != 'true'
    timeout-minutes: ${{ matrix.timeout }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Java test matrix
          - name: "Java Unit Tests"
            os: ubuntu-latest
            test-type: java-unit
            timeout: 15
          - name: "Java Integration Tests"
            os: ubuntu-latest
            test-type: java-integration
            timeout: 20
          - name: "Java Architecture Tests"
            os: ubuntu-latest
            test-type: java-architecture
            timeout: 10
          # Webapp test matrix
          - name: "Webapp Unit Tests"
            os: ubuntu-latest
            test-type: webapp-unit
            timeout: 10
          - name: "Webapp Visual Tests"
            os: ubuntu-latest
            test-type: webapp-visual
            timeout: 15
          # Python test matrix
          - name: "Intelligence Service Tests"
            os: ubuntu-latest
            test-type: python-intelligence
            timeout: 10
          # Cross-platform validation
          - name: "macOS Compatibility"
            os: macos-latest
            test-type: cross-platform
            timeout: 15
    steps:
      - uses: actions/checkout@v4

      # Advanced caching strategy
      - name: Setup advanced caches
        uses: ./.github/actions/setup-caches
        with:
          cache-type: ${{ matrix.test-type }}
          os: ${{ matrix.os }}

      # Java tests
      - name: Java test execution
        if: startsWith(matrix.test-type, 'java-')
        run: |
          case "${{ matrix.test-type }}" in
            "java-unit")
              cd server/application-server
              mvn test -Dgroups="unit" -Dtest="!**/ArchitectureTest" -T 2C --batch-mode
              ;;
            "java-integration")
              cd server/application-server
              mvn test -Dgroups="integration" -T 2C --batch-mode
              ;;
            "java-architecture")
              cd server/application-server
              mvn test -Dtest="**/ArchitectureTest" --batch-mode
              ;;
          esac

      # Webapp tests
      - name: Webapp test execution
        if: startsWith(matrix.test-type, 'webapp-')
        working-directory: webapp-react
        run: |
          npm ci
          case "${{ matrix.test-type }}" in
            "webapp-unit")
              npm run test:ci
              ;;
            "webapp-visual")
              npm run chromatic
              ;;
          esac

      # Python tests
      - name: Python test execution
        if: matrix.test-type == 'python-intelligence'
        working-directory: server/intelligence-service
        run: |
          poetry install --no-interaction --no-root
          poetry run pytest --cov=app --cov-report=xml

      # Test result aggregation
      - name: Upload test results
        if: always()
        uses: dorny/test-reporter@v2
        with:
          name: ${{ matrix.name }} Results
          path: "**/target/surefire-reports/*.xml,**/test-results.xml"
          reporter: java-junit
          fail-on-error: false

  # Enhanced database validation
  database-validation:
    runs-on: ubuntu-latest
    needs: [pipeline-setup, quality-gates]
    if: needs.pipeline-setup.outputs.should_skip != 'true'
    timeout-minutes: 15
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: hephaestus
          POSTGRES_PASSWORD: root
          POSTGRES_USER: root
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 21
          cache: maven

      - name: Build Application Server
        working-directory: server/application-server
        run: mvn compile -DskipTests

      - name: Validate schema consistency
        env:
          CI: true
        run: |
          scripts/db-utils.sh draft-changelog
          if [ -f "server/application-server/src/main/resources/db/changelog_new.xml" ]; then
            echo "## ‚ö†Ô∏è Schema Drift Detected" >> $GITHUB_STEP_SUMMARY
            echo "JPA entities don't match committed migrations. Run 'npm run db:draft-changelog' locally." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Generate and validate ERD documentation
        run: |
          scripts/db-utils.sh generate-erd
          if git diff --quiet docs/dev/database/schema.mmd; then
            echo "‚úÖ ERD documentation is up to date" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ö†Ô∏è ERD Documentation Out of Date" >> $GITHUB_STEP_SUMMARY
            echo "Run 'npm run db:generate-erd-docs' locally and commit changes." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # Optimized Docker builds with security scanning
  docker-build-and-scan:
    runs-on: ubuntu-latest
    needs: [pipeline-setup, test-matrix]
    if: needs.pipeline-setup.outputs.should_skip != 'true'
    timeout-minutes: 25
    strategy:
      matrix:
        component: 
          - { name: "webapp", dockerfile: "./webapp-react/Dockerfile", context: "./webapp-react" }
          - { name: "application-server", dockerfile: "./server/application-server/Dockerfile", context: "./server/application-server" }
          - { name: "intelligence-service", dockerfile: "./server/intelligence-service/Dockerfile", context: "./server/intelligence-service" }
          - { name: "webhook-ingest", dockerfile: "./server/webhook-ingest/Dockerfile", context: "./server/webhook-ingest" }
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.component.context }}
          file: ${{ matrix.component.dockerfile }}
          tags: test-${{ matrix.component.name }}:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan Docker image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: test-${{ matrix.component.tag }}:latest
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'


  # Aggregated success gate for branch protection
  all-ci-passed:
    runs-on: ubuntu-latest
    needs: [quality-gates, security-scan, test-matrix, database-validation, docker-build-and-scan]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          # Check if any required job failed
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "‚ùå One or more CI jobs failed"
            exit 1
          elif [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "‚ö†Ô∏è One or more CI jobs were cancelled"
            exit 1
          else
            echo "‚úÖ All CI jobs passed successfully"
          fi

  # Production Docker builds and deployment
  deploy-staging:
    needs: [all-ci-passed]
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: 
      name: staging
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to staging with health checks
        run: |
          echo "üöÄ Deploying to staging environment..."
          # Blue-green deployment would go here
          echo "‚úÖ Staging deployment completed"

      - name: Run smoke tests
        run: |
          echo "üß™ Running post-deployment smoke tests..."
          # Comprehensive smoke test suite would go here
          echo "‚úÖ Smoke tests passed"

  # Production deployment for tags
  deploy-production:
    needs: [deploy-staging]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    environment: 
      name: production
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to production
        run: |
          echo "üöÄ Deploying to production environment..."
          # Canary deployment with gradual traffic shifting would go here
          echo "‚úÖ Production deployment completed"
