name: Quality

on:
  workflow_call:
    inputs:
      should_skip:
        description: "Whether to skip the workflow"
        required: false
        type: string
        default: "false"
      # Path-based change detection inputs for selective execution
      webapp_changed:
        description: "Whether webapp files changed (or should run for other reasons)"
        required: false
        type: string
        default: "true"
      application_server_changed:
        description: "Whether application-server files changed (or should run for other reasons)"
        required: false
        type: string
        default: "true"
      intelligence_service_changed:
        description: "Whether intelligence-service files changed (or should run for other reasons)"
        required: false
        type: string
        default: "true"
      webhook_ingest_changed:
        description: "Whether webhook-ingest files changed (or should run for other reasons)"
        required: false
        type: string
        default: "true"

jobs:
  quality-gates:
    name: "${{ matrix.display-name }}"
    runs-on: ubuntu-latest
    if: inputs.should_skip != 'true'
    timeout-minutes: ${{ contains(fromJSON('["database-schema-validation", "database-documentation-validation", "database-models-validation"]'), matrix.check) && 20 || 15 }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - check: application-server-quality
            display-name: "App Server"
          - check: webapp-quality
            display-name: "Webapp"
          - check: intelligence-service-quality
            display-name: "Intelligence"
          - check: webhook-ingest-quality
            display-name: "Webhook"
          - check: openapi-validation
            display-name: "OpenAPI"
          - check: database-schema-validation
            display-name: "Database: Schema"
          - check: database-documentation-validation
            display-name: "Database: ERD"
          - check: database-models-validation
            display-name: "Database: Models"
    steps:
      - name: Determine if check should run
        id: should_run
        run: |
          case "${{ matrix.check }}" in
            "webapp-quality")
              echo "run=${{ inputs.webapp_changed }}" >> $GITHUB_OUTPUT
              ;;
            "application-server-quality"|"database-schema-validation"|"database-documentation-validation"|"openapi-validation")
              echo "run=${{ inputs.application_server_changed }}" >> $GITHUB_OUTPUT
              ;;
            "intelligence-service-quality"|"database-models-validation")
              # intelligence-service depends on application-server schema for DB models
              if [[ "${{ inputs.intelligence_service_changed }}" == "true" || "${{ inputs.application_server_changed }}" == "true" ]]; then
                echo "run=true" >> $GITHUB_OUTPUT
              else
                echo "run=false" >> $GITHUB_OUTPUT
              fi
              ;;
            "webhook-ingest-quality")
              echo "run=${{ inputs.webhook_ingest_changed }}" >> $GITHUB_OUTPUT
              ;;
            *)
              # Unknown check type - fail explicitly to catch missing case statements
              echo "::error::Unknown check type '${{ matrix.check }}' in ci-quality-gates.yml matrix."
              echo "::error::Please add a case for this check in the 'Determine if check should run' step."
              echo "run=false" >> $GITHUB_OUTPUT
              exit 1
              ;;
          esac

      - name: Skip notification
        if: steps.should_run.outputs.run != 'true'
        run: echo "⏭️ Skipping ${{ matrix.check }} - no relevant files changed"

      - name: Checkout repository
        if: steps.should_run.outputs.run == 'true'
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          # Database checks need full history for git diff on schema/migrations
          # Other quality checks only need HEAD for faster checkout
          fetch-depth: ${{ contains(matrix.check, 'database') && 0 || 1 }}

      - name: Setup Node.js
        if: steps.should_run.outputs.run == 'true'
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version-file: ".node-version"
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            webapp/package-lock.json
            server/intelligence-service/package-lock.json

      - name: Setup caches
        if: steps.should_run.outputs.run == 'true'
        uses: ./.github/actions/setup-caches
        with:
          cache-type: ${{ matrix.check }}
          os: ${{ runner.os }}

      - name: Application-server formatting
        if: steps.should_run.outputs.run == 'true' && matrix.check == 'application-server-quality'
        run: |
          npm ci --prefer-offline --no-audit
          if ! npm run format:java:check; then
            echo "❌ Formatting failed. Run: npm run format:java"
            exit 1
          fi

      - name: Webapp quality
        if: steps.should_run.outputs.run == 'true' && matrix.check == 'webapp-quality'
        working-directory: ./webapp
        run: |
          cd ..
          npm ci --no-audit --progress=false
          node scripts/install-platform-binaries.mjs
          cd webapp

          # Run Biome check (includes formatting and linting)
          if ! npm run check; then
            echo "❌ Biome checks failed. Run: npm run check -- --write"
            exit 1
          fi

          # Run TypeScript type checking
          if ! npm run typecheck; then
            echo "❌ TypeScript errors found"
            exit 1
          fi

          # Note: Build is tested in Docker build workflow, not needed here

      - name: Intelligence-service quality
        if: steps.should_run.outputs.run == 'true' && matrix.check == 'intelligence-service-quality'
        run: |
          # npm ci already handles node_modules cleanup when package-lock.json changes
          npm ci --no-audit --progress=false
          node scripts/install-platform-binaries.mjs

          ISSUES_FOUND=()
          npm -w server/intelligence-service run check || ISSUES_FOUND+=("Biome check failed")
          npm -w server/intelligence-service run typecheck || ISSUES_FOUND+=("TypeScript failed")
          npm -w server/intelligence-service run build || ISSUES_FOUND+=("Build failed")

          if [ ${#ISSUES_FOUND[@]} -gt 0 ]; then
            for issue in "${ISSUES_FOUND[@]}"; do echo "❌ $issue"; done
            exit 1
          fi

      - name: Webhook-ingest quality
        if: steps.should_run.outputs.run == 'true' && matrix.check == 'webhook-ingest-quality'
        run: |
          # npm ci already handles node_modules cleanup when package-lock.json changes
          npm ci --no-audit --progress=false
          node scripts/install-platform-binaries.mjs

          ISSUES_FOUND=()
          npm -w server/webhook-ingest run check || ISSUES_FOUND+=("Biome check failed")
          npm -w server/webhook-ingest run typecheck || ISSUES_FOUND+=("TypeScript failed")
          npm -w server/webhook-ingest run test || ISSUES_FOUND+=("Tests failed")
          npm -w server/webhook-ingest run build || ISSUES_FOUND+=("Build failed")

          if [ ${#ISSUES_FOUND[@]} -gt 0 ]; then
            for issue in "${ISSUES_FOUND[@]}"; do echo "❌ $issue"; done
            exit 1
          fi

      - name: OpenAPI validation
        if: steps.should_run.outputs.run == 'true' && matrix.check == 'openapi-validation'
        env:
          DATABASE_URL: postgresql://fake:fake@localhost:5432/fake
          MODEL_NAME: fake:model
          DETECTION_MODEL_NAME: fake:model
        run: |
          npm ci --prefer-offline --no-audit
          cd server/application-server
          [ ! -d "target" ] && mvn compile -DskipTests --quiet -Dmaven.build.cache.enabled=true
          cd ../..

          npm run generate:api
          git add .
          if ! git diff --cached --quiet; then
            echo "❌ OpenAPI out of sync. Run: npm run generate:api"
            exit 1
          fi

      - name: Database schema validation
        if: steps.should_run.outputs.run == 'true' && matrix.check == 'database-schema-validation'
        run: |
          docker run -d --name postgres-schema \
            -e POSTGRES_DB=hephaestus -e POSTGRES_PASSWORD=root -e POSTGRES_USER=root \
            -p 5432:5432 postgres:16
          until docker exec postgres-schema pg_isready -U root -d hephaestus; do sleep 2; done

          export SPRING_DATASOURCE_URL="jdbc:postgresql://localhost:5432/hephaestus"
          export SPRING_DATASOURCE_USERNAME="root"
          export SPRING_DATASOURCE_PASSWORD="root"

          npm ci --prefer-offline --no-audit
          cd server/application-server && mvn compile -DskipTests --quiet -Dmaven.build.cache.enabled=true && cd ../..
          scripts/db-utils.sh draft-changelog || { docker stop postgres-schema && docker rm postgres-schema; exit 1; }
          docker stop postgres-schema && docker rm postgres-schema

          if [ -f "server/application-server/src/main/resources/db/changelog_new.xml" ]; then
            echo "❌ Schema drift detected. Run: npm run db:draft-changelog"
            cat server/application-server/src/main/resources/db/changelog_new.xml
            exit 1
          fi

      - name: Database documentation validation
        if: steps.should_run.outputs.run == 'true' && matrix.check == 'database-documentation-validation'
        run: |
          docker run -d --name postgres-erd \
            -e POSTGRES_DB=hephaestus -e POSTGRES_PASSWORD=root -e POSTGRES_USER=root \
            -p 5432:5432 postgres:16
          until docker exec postgres-erd pg_isready -U root -d hephaestus; do sleep 2; done

          export SPRING_DATASOURCE_URL="jdbc:postgresql://localhost:5432/hephaestus"
          export SPRING_DATASOURCE_USERNAME="root"
          export SPRING_DATASOURCE_PASSWORD="root"

          npm ci --prefer-offline --no-audit
          cd server/application-server && mvn compile -DskipTests --quiet -Dmaven.build.cache.enabled=true && cd ../..
          scripts/db-utils.sh generate-erd || { docker stop postgres-erd && docker rm postgres-erd; exit 1; }
          docker stop postgres-erd && docker rm postgres-erd

          git add docs/contributor/erd/schema.mmd
          if ! git diff --cached --quiet docs/contributor/erd/schema.mmd; then
            echo "❌ ERD outdated. Run: npm run db:generate-erd-docs"
            exit 1
          fi

      - name: Database models validation
        if: steps.should_run.outputs.run == 'true' && matrix.check == 'database-models-validation'
        run: |
          npm ci --prefer-offline --no-audit
          node scripts/install-platform-binaries.mjs

          docker run -d --name postgres-models \
            -e POSTGRES_DB=hephaestus -e POSTGRES_PASSWORD=root -e POSTGRES_USER=root \
            -p 5432:5432 postgres:16
          until docker exec postgres-models pg_isready -U root -d hephaestus; do sleep 2; done

          export SPRING_DATASOURCE_URL="jdbc:postgresql://localhost:5432/hephaestus"
          export SPRING_DATASOURCE_USERNAME="root"
          export SPRING_DATASOURCE_PASSWORD="root"

          cd server/application-server && mvn compile -DskipTests --quiet -Dmaven.build.cache.enabled=true && cd ../..
          scripts/db-utils.sh generate-models-intelligence-service || { docker stop postgres-models && docker rm postgres-models; exit 1; }
          docker stop postgres-models && docker rm postgres-models

          git add server/intelligence-service/src/shared/db/schema.ts
          if ! git diff --cached --quiet server/intelligence-service/src/shared/db/schema.ts; then
            echo "❌ DB models out of sync. Run: npm run db:generate-models:intelligence-service"
            git diff --cached server/intelligence-service/src/shared/db/schema.ts
            exit 1
          fi
