# Sync Prompts from Langfuse
#
# Automatically syncs prompts when they change in Langfuse.
# Uses Langfuse's native GitHub Repository Dispatch feature.
#
# SETUP (one-time in Langfuse):
# 1. Go to Prompts > Automations > Create Automation
# 2. Select "GitHub Repository Dispatch"
# 3. Dispatch URL: https://api.github.com/repos/ls1intum/Hephaestus/dispatches
# 4. Event Type: langfuse-prompt-update
# 5. GitHub Token: A PAT with repo scope (stored in Langfuse, NOT in this repo)
# 6. Select triggers: "Created", "Updated" for prompt versions with label "production"

name: Sync Prompts

on:
  # Langfuse webhook via GitHub Repository Dispatch
  repository_dispatch:
    types: [langfuse-prompt-update]

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Preview changes without applying"
        required: false
        default: "false"
        type: boolean

jobs:
  sync:
    name: Sync from Langfuse
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server/intelligence-service

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".node-version"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Pull prompts from Langfuse
        id: pull
        env:
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_BASE_URL: ${{ secrets.LANGFUSE_BASE_URL }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            npm run prompts:pull:dry-run
            echo "dry_run=true" >> $GITHUB_OUTPUT
          else
            npm run prompts:pull 2>&1 | tee pull-output.txt
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for changes
        if: steps.pull.outputs.dry_run == 'false'
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --stat
          fi

      - name: Extract prompt info from webhook
        if: steps.changes.outputs.has_changes == 'true'
        id: prompt_info
        run: |
          # Get prompt info from repository_dispatch payload (if available)
          PROMPT_NAME="${{ github.event.client_payload.prompt.name }}"
          PROMPT_VERSION="${{ github.event.client_payload.prompt.version }}"
          ACTION="${{ github.event.client_payload.action }}"
          
          if [ -n "$PROMPT_NAME" ]; then
            echo "prompt_name=$PROMPT_NAME" >> $GITHUB_OUTPUT
            echo "prompt_version=$PROMPT_VERSION" >> $GITHUB_OUTPUT
            echo "action=$ACTION" >> $GITHUB_OUTPUT
            echo "has_payload=true" >> $GITHUB_OUTPUT
          else
            echo "has_payload=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or update Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(ai): sync prompts from Langfuse"
          branch: chore/sync-prompts-from-langfuse
          delete-branch: true
          title: "chore(ai): sync prompts from Langfuse"
          body: |
            ## Prompt Sync from Langfuse

            ${{ steps.prompt_info.outputs.has_payload == 'true' && format('**Trigger:** `{0}` prompt `{1}` v{2}', steps.prompt_info.outputs.action, steps.prompt_info.outputs.prompt_name, steps.prompt_info.outputs.prompt_version) || '**Trigger:** Manual sync or batch update' }}

            ### Changed Files
            ```
            ${{ steps.changes.outputs.has_changes == 'true' && '(see diff below)' || 'No changes' }}
            ```

            ### Review Checklist
            - [ ] Prompt changes look correct
            - [ ] No unintended modifications
            - [ ] Tests pass (if applicable)

            ---
            *Auto-generated by [Sync Prompts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          labels: |
            ai
            automated

