name: CI/CD

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  merge_group:
  pull_request:
    branches: ["**"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ CHANGE DETECTION                                                          â”‚
  # â”‚ Detects which components changed for selective job execution.             â”‚
  # â”‚ This significantly reduces CI time when only specific components change.  â”‚
  # â”‚                                                                            â”‚
  # â”‚ Why fetch-depth: 0?                                                       â”‚
  # â”‚ - For PRs: paths-filter uses GitHub API (no git history needed)           â”‚
  # â”‚ - For pushes/merge_group: needs git history to find merge-base            â”‚
  # â”‚ We use fetch-depth: 0 to handle all event types consistently.             â”‚
  # â”‚ See: https://github.com/dorny/paths-filter#supported-workflows            â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  detect-changes:
    name: "Detect changes"
    runs-on: ubuntu-latest
    # Required for dorny/paths-filter to access PR files via GitHub API
    permissions:
      pull-requests: read
      contents: read
    outputs:
      # Component-level changes (string 'true'/'false')
      webapp: ${{ steps.filter.outputs.webapp }}
      application-server: ${{ steps.filter.outputs.application-server }}
      intelligence-service: ${{ steps.filter.outputs.intelligence-service }}
      webhook-ingest: ${{ steps.filter.outputs.webhook-ingest }}
      docs: ${{ steps.filter.outputs.docs }}
      ci-config: ${{ steps.filter.outputs.ci-config }}
      # Aggregate: any code changed (not just docs/ci-config)
      any-code: ${{ steps.filter.outputs.webapp == 'true' || steps.filter.outputs.application-server == 'true' || steps.filter.outputs.intelligence-service == 'true' || steps.filter.outputs.webhook-ingest == 'true' }}
      # Skip duplicate check
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          # Full history for merge-base detection on push/merge_group events
          # For PRs, paths-filter uses GitHub API and doesn't need history
          fetch-depth: 0

      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          do_not_skip: '["workflow_dispatch", "push", "merge_group"]'

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            webapp:
              - 'webapp/**'
              - 'package.json'
              - 'package-lock.json'
              - '.node-version'
            application-server:
              - 'server/application-server/**'
              # db-utils.sh contains database migration tooling
              - 'scripts/db-utils.sh'
            intelligence-service:
              - 'server/intelligence-service/**'
              # Scripts that affect intelligence-service builds/tooling
              - 'scripts/install-platform-binaries.mjs'
              - 'scripts/generate-mermaid-erd.ts'
              - 'scripts/postprocess-openapi-java.ts'
              - 'package.json'
              - 'package-lock.json'
            webhook-ingest:
              - 'server/webhook-ingest/**'
              # Root package files affect workspace dependencies
              - 'package.json'
              - 'package-lock.json'
            docs:
              - 'docs/**'
            ci-config:
              - '.github/workflows/**'
              - '.github/actions/**'

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ QUALITY GATES                                                             â”‚
  # â”‚ Code quality and style checks - runs selectively based on changes.        â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  quality-gates:
    uses: ./.github/workflows/ci-quality-gates.yml
    needs: [detect-changes]
    # Run if: any code changed, CI config changed, or not a PR (push to main/merge_group/dispatch)
    if: |
      needs.detect-changes.outputs.should_skip != 'true' && (
        needs.detect-changes.outputs.any-code == 'true' ||
        needs.detect-changes.outputs.ci-config == 'true' ||
        github.event_name != 'pull_request'
      )
    secrets: inherit
    with:
      should_skip: ${{ needs.detect-changes.outputs.should_skip }}
      # Force run all checks when CI config changes or on non-PR events (push to main, merge queue)
      # This ensures workflow changes are fully validated
      # Note: Using ternary pattern to ensure string output for workflow_call string inputs
      # See: https://github.com/actions/runner/issues/1483
      force_run: ${{ (needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      # Pass change detection to sub-workflow for further optimization
      webapp_changed: ${{ (needs.detect-changes.outputs.webapp == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      application_server_changed: ${{ (needs.detect-changes.outputs.application-server == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      intelligence_service_changed: ${{ (needs.detect-changes.outputs.intelligence-service == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      webhook_ingest_changed: ${{ (needs.detect-changes.outputs.webhook-ingest == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ SECURITY SCANNING                                                         â”‚
  # â”‚ Vulnerability scanning - runs on code changes for safety.                 â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  security-scan:
    uses: ./.github/workflows/ci-security-scan.yml
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.should_skip != 'true' && (
        needs.detect-changes.outputs.any-code == 'true' ||
        needs.detect-changes.outputs.ci-config == 'true' ||
        github.event_name != 'pull_request'
      )
    secrets: inherit
    with:
      should_skip: ${{ needs.detect-changes.outputs.should_skip }}

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ TEST SUITE                                                                â”‚
  # â”‚ Comprehensive test execution - runs selectively based on changes.        â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  test-suite:
    uses: ./.github/workflows/ci-tests.yml
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.should_skip != 'true' && (
        needs.detect-changes.outputs.any-code == 'true' ||
        needs.detect-changes.outputs.ci-config == 'true' ||
        github.event_name != 'pull_request'
      )
    secrets: inherit
    with:
      should_skip: ${{ needs.detect-changes.outputs.should_skip }}
      # Note: Using ternary pattern to ensure string output for workflow_call string inputs
      webapp_changed: ${{ (needs.detect-changes.outputs.webapp == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      application_server_changed: ${{ (needs.detect-changes.outputs.application-server == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      intelligence_service_changed: ${{ (needs.detect-changes.outputs.intelligence-service == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      webhook_ingest_changed: ${{ (needs.detect-changes.outputs.webhook-ingest == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ DOCKER BUILDS                                                             â”‚
  # â”‚ Builds Docker images - runs selectively based on component changes.       â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  docker-build:
    uses: ./.github/workflows/ci-docker-build.yml
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.should_skip != 'true' && (
        needs.detect-changes.outputs.any-code == 'true' ||
        needs.detect-changes.outputs.ci-config == 'true' ||
        github.event_name != 'pull_request'
      )
    secrets: inherit
    with:
      should_skip: ${{ needs.detect-changes.outputs.should_skip }}
      # Docker builds should run when component OR CI config changes (Dockerfiles may have changed)
      # Also always run on non-PR events (push to main, merge queue)
      # Note: Using ternary pattern to ensure string output for workflow_call string inputs
      webapp_changed: ${{ (needs.detect-changes.outputs.webapp == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      application_server_changed: ${{ (needs.detect-changes.outputs.application-server == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      intelligence_service_changed: ${{ (needs.detect-changes.outputs.intelligence-service == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      webhook_ingest_changed: ${{ (needs.detect-changes.outputs.webhook-ingest == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ CI STATUS GATE                                                            â”‚
  # â”‚ Aggregated success gate for branch protection rules.                      â”‚
  # â”‚                                                                            â”‚
  # â”‚ Why this job exists:                                                       â”‚
  # â”‚ - Branch protection requires a single check for merge eligibility         â”‚
  # â”‚ - With path-based filtering, individual jobs may be skipped               â”‚
  # â”‚ - Skipped jobs count as "success" for branch protection, but we need      â”‚
  # â”‚   explicit verification that no jobs failed or were cancelled             â”‚
  # â”‚                                                                            â”‚
  # â”‚ Status interpretation:                                                     â”‚
  # â”‚ - 'success': Job ran and passed                                           â”‚
  # â”‚ - 'skipped': Job was skipped (path filtering or condition not met)        â”‚
  # â”‚ - 'failure': Job ran and failed - BLOCKS MERGE                            â”‚
  # â”‚ - 'cancelled': Job was cancelled - BLOCKS MERGE                           â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  all-ci-passed:
    name: "CI Status Gate"
    runs-on: ubuntu-latest
    needs:
      [detect-changes, quality-gates, security-scan, test-suite, docker-build]
    if: always()
    steps:
      - name: Evaluate CI results
        id: evaluate
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                     CI RESULTS SUMMARY                           â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ detect-changes: ${{ needs.detect-changes.result }}"
          echo "â•‘ quality-gates:  ${{ needs.quality-gates.result }}"
          echo "â•‘ security-scan:  ${{ needs.security-scan.result }}"
          echo "â•‘ test-suite:     ${{ needs.test-suite.result }}"
          echo "â•‘ docker-build:   ${{ needs.docker-build.result }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Failure check - any job that ran and failed
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "âŒ BLOCKED: One or more CI jobs failed"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Cancellation check - any job cancelled (not skipped)
          if [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "âš ï¸ BLOCKED: One or more CI jobs were cancelled"
            echo "status=cancelled" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Success: all jobs either passed or were skipped
          # Note: 'skipped' status means path filtering determined no relevant changes
          # for that component. This is expected and safe for branch protection.
          echo "âœ… PASSED: All required CI jobs succeeded"
          echo "status=success" >> $GITHUB_OUTPUT

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # GitHub Actions Job Summary
      # Provides a rich markdown summary visible in the Actions UI
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate CI Summary
        if: always()
        run: |
          # Header
          echo "## ðŸ” CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ steps.evaluate.outputs.status }}" == "success" ]]; then
            echo "âœ… **All checks passed!**" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.evaluate.outputs.status }}" == "failure" ]]; then
            echo "âŒ **Some checks failed.** See details below." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **CI was cancelled or encountered an issue.**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Workflow results table
          echo "### Workflow Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Map result to emoji
          result_to_emoji() {
            case "$1" in
              success) echo "âœ… Passed" ;;
              failure) echo "âŒ Failed" ;;
              skipped) echo "â­ï¸ Skipped" ;;
              cancelled) echo "ðŸš« Cancelled" ;;
              *) echo "â“ Unknown" ;;
            esac
          }

          echo "| Quality Gates | $(result_to_emoji '${{ needs.quality-gates.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | $(result_to_emoji '${{ needs.test-suite.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | $(result_to_emoji '${{ needs.security-scan.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | $(result_to_emoji '${{ needs.docker-build.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Path filtering info
          echo "### ðŸ“ Components Changed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Webapp | ${{ needs.detect-changes.outputs.webapp == 'true' && 'âœ… Yes' || 'âž– No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Application Server | ${{ needs.detect-changes.outputs.application-server == 'true' && 'âœ… Yes' || 'âž– No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Intelligence Service | ${{ needs.detect-changes.outputs.intelligence-service == 'true' && 'âœ… Yes' || 'âž– No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Webhook Ingest | ${{ needs.detect-changes.outputs.webhook-ingest == 'true' && 'âœ… Yes' || 'âž– No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CI Config | ${{ needs.detect-changes.outputs.ci-config == 'true' && 'âš™ï¸ Yes' || 'âž– No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Tips section for failures
          if [[ "${{ steps.evaluate.outputs.status }}" == "failure" ]]; then
            echo "### ðŸ’¡ Troubleshooting Tips" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. **Check the failed job logs** for specific error messages" >> $GITHUB_STEP_SUMMARY
            echo "2. **Run locally** before pushing:" >> $GITHUB_STEP_SUMMARY
            echo '   ```bash' >> $GITHUB_STEP_SUMMARY
            echo '   npm run format && npm run check' >> $GITHUB_STEP_SUMMARY
            echo '   ```' >> $GITHUB_STEP_SUMMARY
            echo "3. **For test failures**, run the specific test suite locally" >> $GITHUB_STEP_SUMMARY
            echo "4. **See the [CI documentation](docs/contributor/ci-cd.mdx)** for more help" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by CI Status Gate â€¢ [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*" >> $GITHUB_STEP_SUMMARY
