name: CI/CD

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  merge_group:
  pull_request:
    branches: ["**"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  detect-changes:
    name: "Detect changes"
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read
    outputs:
      webapp: ${{ steps.filter.outputs.webapp }}
      application-server: ${{ steps.filter.outputs.application-server }}
      intelligence-service: ${{ steps.filter.outputs.intelligence-service }}
      webhook-ingest: ${{ steps.filter.outputs.webhook-ingest }}
      docs: ${{ steps.filter.outputs.docs }}
      ci-config: ${{ steps.filter.outputs.ci-config }}
      any-code: ${{ steps.filter.outputs.webapp == 'true' || steps.filter.outputs.application-server == 'true' || steps.filter.outputs.intelligence-service == 'true' || steps.filter.outputs.webhook-ingest == 'true' }}
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          do_not_skip: '["workflow_dispatch", "push", "merge_group"]'

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            webapp:
              - 'webapp/**'
              - 'package.json'
              - 'package-lock.json'
              - '.node-version'
            application-server:
              - 'server/application-server/**'
              - 'scripts/db-utils.sh'
            intelligence-service:
              - 'server/intelligence-service/**'
              - 'scripts/install-platform-binaries.mjs'
              - 'scripts/generate-mermaid-erd.ts'
              - 'scripts/postprocess-openapi-java.ts'
              - 'package.json'
              - 'package-lock.json'
            webhook-ingest:
              - 'server/webhook-ingest/**'
              - 'package.json'
              - 'package-lock.json'
            docs:
              - 'docs/**'
            ci-config:
              - '.github/workflows/**'
              - '.github/actions/**'

  quality-gates:
    uses: ./.github/workflows/ci-quality-gates.yml
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.should_skip != 'true' && (
        needs.detect-changes.outputs.any-code == 'true' ||
        needs.detect-changes.outputs.ci-config == 'true' ||
        github.event_name != 'pull_request'
      )
    secrets: inherit
    with:
      should_skip: ${{ needs.detect-changes.outputs.should_skip }}
      webapp_changed: ${{ (needs.detect-changes.outputs.webapp == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      application_server_changed: ${{ (needs.detect-changes.outputs.application-server == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      intelligence_service_changed: ${{ (needs.detect-changes.outputs.intelligence-service == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      webhook_ingest_changed: ${{ (needs.detect-changes.outputs.webhook-ingest == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}

  security-scan:
    uses: ./.github/workflows/ci-security-scan.yml
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.should_skip != 'true' && (
        needs.detect-changes.outputs.any-code == 'true' ||
        needs.detect-changes.outputs.ci-config == 'true' ||
        github.event_name != 'pull_request'
      )
    secrets: inherit
    with:
      should_skip: ${{ needs.detect-changes.outputs.should_skip }}

  test-suite:
    uses: ./.github/workflows/ci-tests.yml
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.should_skip != 'true' && (
        needs.detect-changes.outputs.any-code == 'true' ||
        needs.detect-changes.outputs.ci-config == 'true' ||
        github.event_name != 'pull_request'
      )
    secrets: inherit
    with:
      should_skip: ${{ needs.detect-changes.outputs.should_skip }}
      webapp_changed: ${{ (needs.detect-changes.outputs.webapp == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      application_server_changed: ${{ (needs.detect-changes.outputs.application-server == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      intelligence_service_changed: ${{ (needs.detect-changes.outputs.intelligence-service == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      webhook_ingest_changed: ${{ (needs.detect-changes.outputs.webhook-ingest == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}

  docker-build:
    uses: ./.github/workflows/ci-docker-build.yml
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.should_skip != 'true' && (
        needs.detect-changes.outputs.any-code == 'true' ||
        needs.detect-changes.outputs.ci-config == 'true' ||
        github.event_name != 'pull_request'
      )
    secrets: inherit
    with:
      should_skip: ${{ needs.detect-changes.outputs.should_skip }}
      webapp_changed: ${{ (needs.detect-changes.outputs.webapp == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      application_server_changed: ${{ (needs.detect-changes.outputs.application-server == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      intelligence_service_changed: ${{ (needs.detect-changes.outputs.intelligence-service == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}
      webhook_ingest_changed: ${{ (needs.detect-changes.outputs.webhook-ingest == 'true' || needs.detect-changes.outputs.ci-config == 'true' || github.event_name != 'pull_request') && 'true' || 'false' }}

  all-ci-passed:
    name: "CI Status Gate"
    runs-on: ubuntu-latest
    permissions:
      actions: read
      statuses: write
    needs:
      [detect-changes, quality-gates, security-scan, test-suite, docker-build]
    if: always()
    steps:
      - name: Generate workflow timeline
        uses: Kesin11/actions-timeline@v2
        with:
          show-waiting-runner: true

      - name: Evaluate CI results
        id: evaluate
        run: |
          echo "detect-changes: ${{ needs.detect-changes.result }}"
          echo "quality-gates:  ${{ needs.quality-gates.result }}"
          echo "security-scan:  ${{ needs.security-scan.result }}"
          echo "test-suite:     ${{ needs.test-suite.result }}"
          echo "docker-build:   ${{ needs.docker-build.result }}"

          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "status=cancelled" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "status=success" >> $GITHUB_OUTPUT

      - name: Generate CI Summary
        if: always()
        run: |
          # Header
          echo "## üîç CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ steps.evaluate.outputs.status }}" == "success" ]]; then
            echo "‚úÖ **All checks passed!**" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.evaluate.outputs.status }}" == "failure" ]]; then
            echo "‚ùå **Some checks failed.** See details below." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **CI was cancelled or encountered an issue.**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Workflow results table
          echo "### Workflow Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Map result to emoji
          result_to_emoji() {
            case "$1" in
              success) echo "‚úÖ Passed" ;;
              failure) echo "‚ùå Failed" ;;
              skipped) echo "‚è≠Ô∏è Skipped" ;;
              cancelled) echo "üö´ Cancelled" ;;
              *) echo "‚ùì Unknown" ;;
            esac
          }

          echo "| Quality Gates | $(result_to_emoji '${{ needs.quality-gates.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | $(result_to_emoji '${{ needs.test-suite.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | $(result_to_emoji '${{ needs.security-scan.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | $(result_to_emoji '${{ needs.docker-build.result }}') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Path filtering info
          echo "### üìÅ Components Changed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Webapp | ${{ needs.detect-changes.outputs.webapp == 'true' && '‚úÖ Yes' || '‚ûñ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Application Server | ${{ needs.detect-changes.outputs.application-server == 'true' && '‚úÖ Yes' || '‚ûñ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Intelligence Service | ${{ needs.detect-changes.outputs.intelligence-service == 'true' && '‚úÖ Yes' || '‚ûñ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Webhook Ingest | ${{ needs.detect-changes.outputs.webhook-ingest == 'true' && '‚úÖ Yes' || '‚ûñ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CI Config | ${{ needs.detect-changes.outputs.ci-config == 'true' && '‚öôÔ∏è Yes' || '‚ûñ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Tips section for failures - specific to what failed
          if [[ "${{ steps.evaluate.outputs.status }}" == "failure" ]]; then
            echo "### üí° Troubleshooting Guide" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Quality gates failures
            if [[ "${{ needs.quality-gates.result }}" == "failure" ]]; then
              echo "<details><summary><b>‚ùå Quality Gates Failed</b></summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Issue | Fix Command |" >> $GITHUB_STEP_SUMMARY
              echo "|-------|-------------|" >> $GITHUB_STEP_SUMMARY
              echo "| Formatting errors | \`npm run format\` |" >> $GITHUB_STEP_SUMMARY
              echo "| TypeScript errors | \`npm run typecheck:webapp\` |" >> $GITHUB_STEP_SUMMARY
              echo "| Biome lint errors | \`npm run lint:fix\` |" >> $GITHUB_STEP_SUMMARY
              echo "| Java formatting | \`npm run format:java\` |" >> $GITHUB_STEP_SUMMARY
              echo "| OpenAPI out of sync | \`npm run generate:api\` |" >> $GITHUB_STEP_SUMMARY
              echo "| Database schema drift | \`npm run db:draft-changelog\` |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # Test failures
            if [[ "${{ needs.test-suite.result }}" == "failure" ]]; then
              echo "<details><summary><b>‚ùå Tests Failed</b></summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Test Suite | Run Locally |" >> $GITHUB_STEP_SUMMARY
              echo "|------------|-------------|" >> $GITHUB_STEP_SUMMARY
              echo "| Webapp unit | \`npm run test:webapp\` |" >> $GITHUB_STEP_SUMMARY
              echo "| Webapp Storybook | \`npm -w webapp run test:storybook\` |" >> $GITHUB_STEP_SUMMARY
              echo "| Application server | \`cd server/application-server && ./mvnw test\` |" >> $GITHUB_STEP_SUMMARY
              echo "| Intelligence service | \`npm -w server/intelligence-service run test\` |" >> $GITHUB_STEP_SUMMARY
              echo "| Webhook ingest | \`npm -w server/webhook-ingest run test\` |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Tip:** Check the **Test Results** tab above for specific failures." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # Docker build failures
            if [[ "${{ needs.docker-build.result }}" == "failure" ]]; then
              echo "<details><summary><b>‚ùå Docker Build Failed</b></summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Common causes:" >> $GITHUB_STEP_SUMMARY
              echo "- Build errors in the application code" >> $GITHUB_STEP_SUMMARY
              echo "- Missing dependencies" >> $GITHUB_STEP_SUMMARY
              echo "- Dockerfile syntax errors" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Test locally: \`docker build -f <component>/Dockerfile .\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # Security scan failures
            if [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
              echo "<details><summary><b>‚ùå Security Scan Failed</b></summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Check the **Security** tab for details on vulnerabilities." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Quick fix:** Run \`npm run format && npm run check\` before pushing." >> $GITHUB_STEP_SUMMARY
          fi

          # Performance note for successful runs
          if [[ "${{ steps.evaluate.outputs.status }}" == "success" ]]; then
            echo "### ‚ö° Performance" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            SKIPPED_COUNT=0
            [[ "${{ needs.quality-gates.result }}" == "skipped" ]] && ((SKIPPED_COUNT++))
            [[ "${{ needs.test-suite.result }}" == "skipped" ]] && ((SKIPPED_COUNT++))
            [[ "${{ needs.security-scan.result }}" == "skipped" ]] && ((SKIPPED_COUNT++))
            [[ "${{ needs.docker-build.result }}" == "skipped" ]] && ((SKIPPED_COUNT++))
            if [[ $SKIPPED_COUNT -gt 0 ]]; then
              echo "üöÄ **Path-based filtering saved time!** $SKIPPED_COUNT workflow(s) skipped because no relevant files changed." >> $GITHUB_STEP_SUMMARY
            else
              echo "All workflows ran (CI config or main branch push)." >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by CI Status Gate ‚Ä¢ [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*" >> $GITHUB_STEP_SUMMARY

      - name: Create commit status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.pull_request?.head?.sha || context.sha;
            const state = '${{ steps.evaluate.outputs.status }}' || 'failure';
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: sha,
              state: state,
              description: state === 'success' ? 'All CI checks passed' : 'One or more CI checks failed',
              context: 'All CI Passed'
            });

      - name: Create Coolify Preview status
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.pull_request?.head?.sha || context.sha;
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: sha,
              state: 'success',
              target_url: 'https://coolify.hephaestus.aet.cit.tum.de/project/lc8sows0ok8g880sg4o4o84w/environment/ek8o8800g4wks84c8w8wcckc/application/wg44k0ccsoscsgcco8swc4ks/preview-deployments',
              description: 'Click Details to view Coolify preview deployments',
              context: 'Preview / Coolify'
            });
