name: Docker Build

on:
  workflow_call:
    inputs:
      should_skip:
        description: "Whether to skip the workflow"
        required: false
        type: string
        default: "false"
      # Path-based change detection for selective Docker builds
      # These are pre-computed by the caller (cicd.yml) to include CI config fallback
      webapp_changed:
        description: "Whether webapp files changed (or should build for other reasons)"
        required: false
        type: string
        default: "true"
      application_server_changed:
        description: "Whether application-server files changed (or should build for other reasons)"
        required: false
        type: string
        default: "true"
      intelligence_service_changed:
        description: "Whether intelligence-service files changed (or should build for other reasons)"
        required: false
        type: string
        default: "true"
      webhook_ingest_changed:
        description: "Whether webhook-ingest files changed (or should build for other reasons)"
        required: false
        type: string
        default: "true"

# ┌──────────────────────────────────────────────────────────────────────────────┐
# │ DOCKER IMAGE BUILDS                                                          │
# │ Each component is built independently based on change detection.             │
# │                                                                               │
# │ Design decisions:                                                             │
# │ - No intermediate job: Inputs are passed directly to build jobs to avoid     │
# │   5-10s overhead of an intermediate "check-changes" job.                      │
# │ - Individual jobs: Each component builds independently, allowing parallel     │
# │   execution and selective skipping.                                           │
# │ - External workflow: Uses shared org workflow for consistent Docker builds.   │
# └──────────────────────────────────────────────────────────────────────────────┘

jobs:
  # Build webapp Docker image
  webapp-build:
    name: "Docker: webapp"
    if: inputs.should_skip != 'true' && inputs.webapp_changed == 'true'
    uses: ls1intum/.github/.github/workflows/build-and-push-docker-image.yml@main
    with:
      image-name: "ls1intum/hephaestus/webapp"
      docker-file: "./webapp/Dockerfile"
      docker-context: "."
      registry: "ghcr.io"
      tags: |
        ${{ github.ref_name }}
        ${{ github.sha }}
        ci-${{ github.run_number }}
        ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.number) || 'latest' }}
      labels: |
        org.opencontainers.image.title=Hephaestus Webapp
        org.opencontainers.image.description=Web client for Hephaestus
        org.opencontainers.image.vendor=AET TUM
        org.opencontainers.image.licenses=MIT
        hephaestus.component=webapp
    secrets: inherit

  # Build application-server Docker image
  application-server-build:
    name: "Docker: application-server"
    if: inputs.should_skip != 'true' && inputs.application_server_changed == 'true'
    uses: ls1intum/.github/.github/workflows/build-and-push-docker-image.yml@main
    with:
      image-name: "ls1intum/hephaestus/application-server"
      docker-file: "./server/application-server/Dockerfile"
      docker-context: "./server/application-server"
      registry: "ghcr.io"
      tags: |
        ${{ github.ref_name }}
        ${{ github.sha }}
        ci-${{ github.run_number }}
        ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.number) || 'latest' }}
      labels: |
        org.opencontainers.image.title=Hephaestus Application Server
        org.opencontainers.image.description=Spring Boot server for Hephaestus
        org.opencontainers.image.vendor=AET TUM
        org.opencontainers.image.licenses=MIT
        hephaestus.component=application-server
    secrets: inherit

  # Build intelligence-service Docker image
  intelligence-service-build:
    name: "Docker: intelligence-service"
    if: inputs.should_skip != 'true' && inputs.intelligence_service_changed == 'true'
    uses: ls1intum/.github/.github/workflows/build-and-push-docker-image.yml@main
    with:
      image-name: "ls1intum/hephaestus/intelligence-service"
      docker-file: "./server/intelligence-service/Dockerfile"
      docker-context: "./server/intelligence-service"
      registry: "ghcr.io"
      tags: |
        ${{ github.ref_name }}
        ${{ github.sha }}
        ci-${{ github.run_number }}
        ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.number) || 'latest' }}
      labels: |
        org.opencontainers.image.title=Hephaestus Intelligence Service
        org.opencontainers.image.description=Node/Hono-based AI service for Hephaestus (AI SDK v6)
        org.opencontainers.image.vendor=AET TUM
        org.opencontainers.image.licenses=MIT
        hephaestus.component=intelligence-service
    secrets: inherit

  # Build webhook-ingest Docker image
  webhook-ingest-build:
    name: "Docker: webhook-ingest"
    if: inputs.should_skip != 'true' && inputs.webhook_ingest_changed == 'true'
    uses: ls1intum/.github/.github/workflows/build-and-push-docker-image.yml@main
    with:
      image-name: "ls1intum/hephaestus/webhook-ingest"
      docker-file: "./server/webhook-ingest/Dockerfile"
      docker-context: "./server/webhook-ingest"
      registry: "ghcr.io"
      tags: |
        ${{ github.ref_name }}
        ${{ github.sha }}
        ci-${{ github.run_number }}
        ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.number) || 'latest' }}
      labels: |
        org.opencontainers.image.title=Hephaestus Webhook Ingest
        org.opencontainers.image.description=Hono/TypeScript-based webhook processor for Hephaestus
        org.opencontainers.image.vendor=AET TUM
        org.opencontainers.image.licenses=MIT
        hephaestus.component=webhook-ingest
    secrets: inherit
