# GitHub Copilot Agent Development Environment Configuration
# This file preinstalls tools and dependencies to ensure smooth agent sessions
# Documentation: https://docs.github.com/en/enterprise-cloud@latest/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment

# Preinstall script runs once when the environment is created
# Set up all required tools and dependencies
preinstall: |
  set -e
  
  echo "üîß Setting up Hephaestus development environment..."
  
  # Install Node.js 22.10.0 (exact version from .node-version)
  echo "üì¶ Installing Node.js 22.10.0..."
  curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  apt-get install -y nodejs
  node --version
  npm --version
  
  # Install Java 21 (OpenJDK via Adoptium/Eclipse Temurin)
  echo "‚òï Installing Java 21..."
  apt-get install -y wget apt-transport-https gnupg
  mkdir -p /etc/apt/keyrings
  wget -O - https://packages.adoptium.net/artifactory/api/gpg/key/public | tee /etc/apt/keyrings/adoptium.asc
  echo "deb [signed-by=/etc/apt/keyrings/adoptium.asc] https://packages.adoptium.net/artifactory/deb $(awk -F= '/^VERSION_CODENAME/{print$2}' /etc/os-release) main" | tee /etc/apt/sources.list.d/adoptium.list
  apt-get update
  apt-get install -y temurin-21-jdk
  
  # Set Java 21 as default and verify
  update-alternatives --set java /usr/lib/jvm/temurin-21-jdk-amd64/bin/java || true
  export JAVA_HOME=/usr/lib/jvm/temurin-21-jdk-amd64
  export PATH=$JAVA_HOME/bin:$PATH
  java -version
  
  # Install Python 3.13
  echo "üêç Installing Python 3.13..."
  apt-get install -y software-properties-common
  add-apt-repository -y ppa:deadsnakes/ppa
  apt-get update
  apt-get install -y python3.13 python3.13-venv python3.13-dev python3-pip
  update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.13 1
  python3 --version
  
  # Install Poetry 2.x for Python dependency management
  echo "üìù Installing Poetry 2.x..."
  # Install pipx first for isolated CLI tool installation
  python3 -m pip install --user pipx
  python3 -m pipx ensurepath
  export PATH="/root/.local/bin:$PATH"
  
  # Install Poetry via pipx for proper isolation
  pipx install poetry==2.0.0
  
  # Create symlink to ensure poetry is in standard PATH
  if [ -f /root/.local/bin/poetry ]; then
    ln -sf /root/.local/bin/poetry /usr/local/bin/poetry || { echo "‚ùå Failed to create symlink for poetry"; exit 1; }
  else
    echo "‚ùå /root/.local/bin/poetry not found, cannot create symlink"
    exit 1
  fi
  if [ -f /root/.local/bin/pipx ]; then
    ln -sf /root/.local/bin/pipx /usr/local/bin/pipx || { echo "‚ùå Failed to create symlink for pipx"; exit 1; }
  else
    echo "‚ùå /root/.local/bin/pipx not found, cannot create symlink"
    exit 1
  fi
  poetry --version
  
  # Verify Docker is available (usually pre-installed in GitHub environments)
  echo "üê≥ Checking Docker availability..."
  docker --version || echo "‚ö†Ô∏è Docker not available, some database operations may fail"
  
  # Install project npm dependencies
  echo "üì¶ Installing npm dependencies..."
  # Always remove node_modules to ensure a clean install
  if [ -d "node_modules" ]; then
    echo "Removing existing node_modules directory..."
    rm -rf node_modules
  fi
  npm ci --prefer-offline --no-audit
  
  # Install Beads CLI for AI agent issue tracking
  echo "üìã Installing Beads CLI (bd)..."
  npm install -g @beads/bd
  bd --version
  
  # Bootstrap Python environments for intelligence-service and webhook-ingest
  echo "üîß Bootstrapping Python environments..."
  if command -v poetry &> /dev/null; then
    npm run bootstrap:py || echo "‚ö†Ô∏è Poetry bootstrap failed, may need Python 3.13"
  else
    echo "‚ö†Ô∏è Poetry not available, skipping Python bootstrap"
  fi
  
  # Verify Maven wrapper is executable
  echo "‚úÖ Verifying Maven wrapper..."
  chmod +x server/application-server/mvnw
  cd server/application-server && ./mvnw --version
  cd ../..
  
  echo "‚úÖ Environment setup complete!"

# Environment variables for development sessions
environment:
  # Java 21 configuration - required for Spring Boot 3.5 and Liquibase
  JAVA_HOME: /usr/lib/jvm/temurin-21-jdk-amd64
  
  # Database connection for local development
  SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/hephaestus
  SPRING_DATASOURCE_USERNAME: root
  SPRING_DATASOURCE_PASSWORD: root
  
  # Intelligence service model configuration (fake provider for tooling/generation)
  MODEL_NAME: fake:model
  DETECTION_MODEL_NAME: fake:model
  
  # Add Java 21, Poetry, and global npm tools to PATH
  PATH: /usr/lib/jvm/temurin-21-jdk-amd64/bin:/usr/local/bin:/root/.local/bin:$PATH
