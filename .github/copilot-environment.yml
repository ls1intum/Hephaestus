# GitHub Copilot Agent Development Environment Configuration
# This file preinstalls tools and dependencies to ensure smooth agent sessions
# Documentation: https://docs.github.com/en/enterprise-cloud@latest/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment

# Preinstall script runs once when the environment is created
# Set up all required tools and dependencies
preinstall: |
  set -e
  
  echo "üîß Setting up Hephaestus development environment..."
  
  # Install Node.js 22.10.0 (exact version from .node-version)
  echo "üì¶ Installing Node.js 22.10.0..."
  curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  apt-get install -y nodejs
  node --version
  npm --version
  
  # Install Java 21 (OpenJDK via Adoptium/Eclipse Temurin)
  echo "‚òï Installing Java 21..."
  apt-get install -y wget apt-transport-https gnupg
  mkdir -p /etc/apt/keyrings
  wget -O - https://packages.adoptium.net/artifactory/api/gpg/key/public | tee /etc/apt/keyrings/adoptium.asc
  echo "deb [signed-by=/etc/apt/keyrings/adoptium.asc] https://packages.adoptium.net/artifactory/deb $(awk -F= '/^VERSION_CODENAME/{print$2}' /etc/os-release) main" | tee /etc/apt/sources.list.d/adoptium.list
  apt-get update
  apt-get install -y temurin-21-jdk
  
  # Set Java 21 as default and verify
  update-alternatives --set java /usr/lib/jvm/temurin-21-jdk-amd64/bin/java || true
  export JAVA_HOME=/usr/lib/jvm/temurin-21-jdk-amd64
  export PATH=$JAVA_HOME/bin:$PATH
  java -version
  
  # Verify Docker is available (usually pre-installed in GitHub environments)
  echo "üê≥ Checking Docker availability..."
  docker --version || echo "‚ö†Ô∏è Docker not available, some database operations may fail"
  
  # Install project npm dependencies (includes all workspaces: webapp, intelligence-service, webhook-ingest)
  echo "üì¶ Installing npm dependencies..."
  # Always remove node_modules to ensure a clean install
  if [ -d "node_modules" ]; then
    echo "Removing existing node_modules directory..."
    rm -rf node_modules
  fi
  npm ci --prefer-offline --no-audit
  
  # Install Beads CLI for AI agent issue tracking
  echo "üìã Installing Beads CLI (bd)..."
  npm install -g @beads/bd
  # The @beads/bd postinstall script skips binary download when CI=true
  # Run postinstall manually without CI flag to download the native binary
  BD_POSTINSTALL_SCRIPT="$(npm root -g)/@beads/bd/scripts/postinstall.js"
  if [ -f "$BD_POSTINSTALL_SCRIPT" ]; then
    CI="" node "$BD_POSTINSTALL_SCRIPT"
    bd --version
  else
    echo "‚ö†Ô∏è Beads postinstall script not found at $BD_POSTINSTALL_SCRIPT"
    echo "‚ö†Ô∏è bd commands may not work properly"
  fi
  
  # Initialize beads database from JSONL if present (required for fresh clones)
  echo "üìã Initializing Beads database..."
  if [ -f ".beads/issues.jsonl" ]; then
    bd init || echo "‚ö†Ô∏è Beads init failed, bd commands may require manual 'bd init'"
  else
    echo "‚ÑπÔ∏è No .beads/issues.jsonl found, skipping bd init (not a beads-enabled project)"
  fi
  
  # Verify Maven wrapper is executable
  echo "‚úÖ Verifying Maven wrapper..."
  chmod +x server/application-server/mvnw
  cd server/application-server && ./mvnw --version
  cd ../..
  
  echo "‚úÖ Environment setup complete!"

# Environment variables for development sessions
environment:
  # Java 21 configuration - required for Spring Boot 3.5 and Liquibase
  JAVA_HOME: /usr/lib/jvm/temurin-21-jdk-amd64
  
  # Database connection for local development
  SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/hephaestus
  SPRING_DATASOURCE_USERNAME: root
  SPRING_DATASOURCE_PASSWORD: root
  
  # Intelligence service model configuration (fake provider for tooling/generation)
  MODEL_NAME: fake:model
  DETECTION_MODEL_NAME: fake:model
  
  # Add Java 21 to PATH
  PATH: /usr/lib/jvm/temurin-21-jdk-amd64/bin:$PATH
